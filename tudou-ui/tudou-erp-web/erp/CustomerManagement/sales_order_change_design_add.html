<!DOCTYPE html>
<html lang="en">
<head>
    <script type="text/javascript">

        /***
         * 销售变更单新增页面（设计师）
         * */

        /**
         * 新增
         * */
        function sales_order_change_design_save() {
            if ($("#businessdate").val() !== "" && $("#custusername").val() !== "") {
                var tsochangedetailValidList = [];
                var obj = new Object();
                var tsochangeValid = new Object();
                tsochangeValid = {
//                    stores: $("#stores").val(),
                    custsales: $("#custsales").val(),
                    custusername: $("#custusername").val(),
                    mobile: $("#mobile").val(),
                    receivedaddress: $("#receivedaddress").val(),
                    businessdate: $("#businessdate").val(),
                    paymentaccount: $("#paymentaccount").val(),
                    sodoc: $("#sodoc").val(),
                    details: $("#details").val(),
                    custsalesid: $("#custsalesid").val(),
                    custid: $("#custid").val(),
                    salespackageid: $("#salespackageid").val(),
//                    storesid: $("#storesid").val()
                }
                if ($("#sales_order_change_design_add_detail_table tbody tr").length < 1) {
                    BJUI.alertmsg('error', "至少的有一行明细行记录", {
                        displayMode: 'fade',
                        alertTimeout: 1000,
                        displayPosition: 'middlecenter'
                    });
                } else {
                    var salesordertable = $("#sales_order_change_design_add_detail_table tbody tr");
                    for (var i = 0; i < salesordertable.length; i++) {
                        var isnonstandard = $("input[name='salesorder[" + i + "].isnonstandard']").val();
                        if (isnonstandard == "是") {
                            isnonstandard = true;
                        }
                        if (isnonstandard == "不是") {
                            isnonstandard = false;
                        }
                        obj = {
//                        linenum: $("input[name='salesorder[" + i + "].linenum']").val(),//ok
                            linestate: $("input[name='salesorder[" + i + "].linestate']").val(),//ok
                            worker: $("input[name='salesorder[" + i + "].worker']").val(),//ok
                            materialdetailed: $("input[name='salesorder[" + i + "].materialdetailed']").val(),
                            isnonstandard: isnonstandard,
                            itemno: $("input[name='salesorder[" + i + "].itemno']").val(),
                            itemclass: $("input[name='salesorder[" + i + "].itemclass']").val(),
                            brand: $("input[name='salesorder[" + i + "].brand']").val(),
                            partname: $("input[name='salesorder[" + i + "].partname']").val(),
                            partspec: $("input[name='salesorder[" + i + "].partspec']").val(),
                            partstyle: $("input[name='salesorder[" + i + "].partstyle']").val(),
                            colorlevel: $("input[name='salesorder[" + i + "].colorlevel']").val(),
                            material: $("input[name='salesorder[" + i + "].material']").val(),
                            usingphase: $("input[name='salesorder[" + i + "].usingphase']").val(),
                            funit: $("input[name='salesorder[" + i + "].funit']").val(),
                            oldunitqty: $("input[name='salesorder[" + i + "].oldunitqty']").val(),
                            modifyunitqty: $("input[name='salesorder[" + i + "].modifyunitqty']").val(),
                            mpq: $("input[name='salesorder[" + i + "].mpq']").val(),
                            oldqty: $("input[name='salesorder[" + i + "].oldqty']").val(),
                            modifyqty: $("input[name='salesorder[" + i + "].modifyqty']").val(),
                            changeqty: $("input[name='salesorder[" + i + "].changeqty']").val(),
                            sourcenum: $("#sodoc").val(),
                            soucrelinenum: $("input[name='salesorder[" + i + "].soucrelinenum']").val(),
                            itemid: $("input[name='salesorder[" + i + "].itemid']").val(),
                            grossweight: $("input[name='salesorder[" + i + "].grossweight']").val(),
                            unitweight: $("input[name='salesorder[" + i + "].unitweight']").val(),
                        };
                        tsochangedetailValidList.push(obj);
                    }
                    objOb = {
                        tsochangedetailValidList,
                        tsochangeValid
                    };

                    $("#sales_order_change_design_save_btn").attr("disabled", "disabled");
                    $.ajax({
                        url: '/v1/sochange/addsalechangeorders',
                        contentType: 'application/json',
                        dataType: 'json',
                        type: 'POST',
                        data: JSON.stringify(objOb),
                        xhrFields: {
                            withCredentials: true
                        },
                        crossDomain: true,
                        success: function (d) {
                            if (d.state == 200) {
//                            //让明细表变成不可编辑
//                            $("#sales_order_change_design_add_detail_table tbody tr").addClass("readonly");
//                            //刷新销售订单列表
//                            $('#sales_order_change_design_list').datagrid("refresh");
//                            BJUI.alertmsg('info', d.content, {
//                                displayMode: 'fade',
//                                alertTimeout: 1000,
//                                displayPosition: 'middlecenter'
//                            });
//                            //回传的值回显
//                            $("#doc").val(d.data.doc);
//                            $("#state").val(d.data.state);
//                            //改变按钮状态
//                            $("#sales_order_change_design_commit_btn").removeAttr("disabled");
//                            $("#sales_order_change_design_nocommit_btn").attr("disabled", "disabled");
//                            $("#sales_order_change_design_ad_de").removeAttr("disabled");
////                            $("#purchase_save_btn").attr("disabled","disabled");
//                            //将销售订单主键id值放到表头中
//                            $("#sales_order_change_design_add_table input[name='id']").val(d.data.id);
//                            //将所有明细表的行状态改成新增
//                            for (var i = 0; i < $("#sales_order_change_design_add_detail_table tbody tr").length; i++) {
//                                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(1) input").val("新增")
//                            }
                                thisid = d.data.id;
                                //刷新列表
                                $('#sales_order_change_design_list').datagrid("refresh");
                                //关闭对话
                                BJUI.dialog("closeCurrent", this);
                                //提示成功
                                BJUI.alertmsg('info', d.content, {
                                    displayMode: 'fade',
                                    alertTimeout: 1000,
                                    displayPosition: 'middlecenter'
                                });
                                //打开编辑页面
                                $(this).dialog({
                                    id: "salesorderOrderEdit",
                                    title: "销售订单编辑_edit",
                                    url: "CustomerManagement/sales_order_change_design_edit.html",
                                    width: 1052,
                                    height: 602,
                                    mask: true
                                });
                            } else {
                                $("#sales_order_change_design_save_btn").removeAttr("disabled");

                                BJUI.alertmsg('error', d.content, {
                                    displayMode: 'fade',
                                    alertTimeout: 1000,
                                    displayPosition: 'middlecenter'
                                });
                            }
                        }
                    });
                }
            }
        }

        /**
         * 删除明细行
         * **/
        function delete_row() {
            if (1 < $("#sales_order_change_design_add_detail_table tbody tr").length) {
                $("#sales_order_change_design_add_detail_table").find(".selected").remove();
                //删除选中行，并刷新明细行列表
                re_arr_add_detail_table();
            }
        }

        /**
         *
         * 提交
         * **/
        function sales_order_change_design_add_commit() {
            var id = $("#sales_order_change_design_add_table input[name='id']").val();
            $.ajax({
                url: '/v1/sochange/commitsalechangeorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: id
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#sales_order_change_design_commit_btn").attr("disabled", "disabled");
                        $("#sales_order_change_design_save_btn").attr("disabled", "disabled");
                        $("#sales_order_change_design_nocommit_btn").removeAttr("disabled");
                        $("#sales_order_change_design_ad_de").attr("disabled", "disabled");
                        $('#sales_order_change_design_list').datagrid("refresh");
                        //改变各行审核状态
                        for (var i = 0; i < $("#sales_order_change_design_add_detail_table tbody tr").length; i++) {
                            $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(1) input").val("已提交")
                        }
                    } else {
                        BJUI.alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }
        /**
         * 收回
         * **/
        function purchase_giveup_add_giveup_commit() {
            var id = $("#sales_order_change_design_add_table input[name='id']").val();
            $.ajax({
                url: '/v1/sochange/giveupcommitsalechangeorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: id
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#sales_order_change_design_save_btn").removeAttr("disabled");
                        $("#sales_order_change_design_commit_btn").removeAttr("disabled");
                        $("#sales_order_change_design_ad_de").removeAttr("disabled");
                        $("#sales_order_change_design_nocommit_btn").attr("disabled", "disabled");
                        $('#sales_order_change_design_list').datagrid("refresh");

                        for (var i = 0; i < $("#sales_order_change_design_add_detail_table tbody tr").length; i++) {
                            $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(1) input").val("新增")
                        }
                    } else {
                        BJUI.alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }

            });
        }
        /**
         * （删除整单前）弹框
         * **/
        function sales_order_change_design_delete() {
            BJUI.alertmsg('confirm', '确定要删除吗?', {
                displayMode: 'fade',
                displayPosition: 'middlecenter',
                okName: "是",
                cancelName: "否",
                okCall: 'delete_order'
            });
        }
        /**
         * （弹框确认后）删除整单
         */
        function delete_order() {
            var selected = $("#sales_order_change_design_add_table input[name='id']").val();
            $.ajax({
                url: '/v1/sochange/deletesalechangeorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: selected
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.dialog("closeCurrent", this);
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $('#sales_order_change_design_list').datagrid("refresh");
                    } else {
                        BJUI.alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }


        //定义全局变量，已做个性包和套餐的区分
        var typedocument = "套餐";
        //是否为第一次,判断是否需要追加合计栏
        var isfirst = 0;
        countline = 0;
        function select_sales_package(type) {
            typedocument = type;
            //打开编辑界面
            $(this).dialog({
                id: "storage_add",
                title: "选择套餐_add",
                url: "CustomerManagement/sales_package_change_select.html",

                width: 1050,
                height: 600,
                mask: true
            });
        }
        function re_arr_add_detail_table() {
            for (var i = 0; i < $("#sales_order_change_design_add_detail_table tbody tr").length; i++) {
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(0)").attr("name", "salesorder[" + i + "].linenum");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(1)").attr("name", "salesorder[" + i + "].linestate");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(2)").attr("name", "salesorder[" + i + "].itemno");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(3)").attr("name", "salesorder[" + i + "].itemclass");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(4)").attr("name", "salesorder[" + i + "].brand");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(5)").attr("name", "salesorder[" + i + "].partname");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(6)").attr("name", "salesorder[" + i + "].partspec");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(7)").attr("name", "salesorder[" + i + "].partstyle");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(8)").attr("name", "salesorder[" + i + "].colorlevel");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(9)").attr("name", "salesorder[" + i + "].material");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(10)").attr("name", "salesorder[" + i + "].usingphase");

                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(11)").attr("name", "salesorder[" + i + "].funit");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(12)").attr("name", "salesorder[" + i + "].grossweight");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(13)").attr("name", "salesorder[" + i + "].unitweight");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(14)").attr("name", "salesorder[" + i + "].oldunitqty");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(15)").attr("name", "salesorder[" + i + "].modifyunitqty");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(16)").attr("name", "salesorder[" + i + "].mpq");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(17)").attr("name", "salesorder[" + i + "].oldqty");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(18)").attr("name", "salesorder[" + i + "].modifyqty");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(19)").attr("name", "salesorder[" + i + "].changeqty");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(20)").attr("name", "salesorder[" + i + "].soucrelinenum");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(21)").attr("name", "salesorder[" + i + "].itemid");
                $("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") input:eq(22)").attr("name", "salesorder[" + i + "].id");
            }
            count_change_add()
        }

    </script>
</head>
<body>
<div class="bjui-pageContent">
    <form data-toggle="validate" data-toggle="validate">
        <div style="margin:15px;">
            <button class="btn btn-blue" data-icon="save" id="sales_order_change_design_save_btn"
                    onclick="sales_order_change_design_save()">保存
            </button>
            <button type="button" class="btn btn-green" data-icon="thumbs-up" disabled="disabled"
                    id="sales_order_change_design_commit_btn" onclick="sales_order_change_design_add_commit()">提交
            </button>
            <button type="button" class="btn btn-orange" data-icon="thumbs-down" disabled="disabled"
                    id="sales_order_change_design_nocommit_btn" onclick="purchase_giveup_add_giveup_commit()">收回
            </button>
            <button type="button" class="btn btn-red" data-icon="times" disabled="disabled"
                    id="sales_order_change_design_ad_de" onclick="sales_order_change_design_delete()">删除
            </button>
            <button class="btn-close btn" data-icon="close"><i class="fa fa-close"></i>关闭</button>
            <button class="btn-default doc_lookup doc_lookup" data-toggle="lookupbtn"
                    data-url="CustomerManagement/salesorder_selecte.html" data-group="salesorderInfo"
                    data-id="sales_order_se" data-title="选择销售订单">选择销售订单
            </button>

        </div>
        <table class="table table-bordered table-hover table-striped table-top bjui-tabledit"
               id="sales_order_change_design_add_table" width="100%">

            <input type="hidden" name="id" value="">
            <input type="hidden" name="salesorderInfo.custid" value="" id="custid">
            <input type="hidden" name="salesorderInfo.custsalesid" value="" id="custsalesid">
            <input type="hidden" name="salesorderInfo.salespackageid" value="" id="salespackageid">
            <!--<input type="hidden" name="salesorderInfo.storesid" value="" id="storesid">-->
            <tbody>

            <!--主表第一行-->
            <tr>
                <td>
                    <label for="doc" class="control-label x90">单号：</label>
                    <input type="text" id="doc" value="" name="doc" size="15" readonly="true">
                </td>
                <td>
                    <label for="state" class="control-label x90">状态：</label>
                    <input type="text" id="state" value="" name="state" style="width: 150px" readonly="true">
                </td>
                <!--<td>-->
                <!--<label for="stores" class="control-label x90">门店：</label>-->
                <!--<input type="text" id="stores" value="" name="salesorderInfo.stores" style="width: 150px" readonly="true">-->
                <!--</td>-->

                <td>
                    <label for="custsales" class="control-label x90">客户经理：</label>
                    <input type="text" id="custsales" name="salesorderInfo.custsales" style="width: 150px"
                           readonly="true">
                </td>
                <td>
                    <label class="control-label x90" for="custusername">客户姓名：</label>
                    <input type="text" id="custusername" name="salesorderInfo.custusername" style="width: 150px"
                           readonly="true">

                </td>
            </tr>
            <!--主表第二行-->
            <tr>

                <td>
                    <label class="control-label x90" for="mobile">手机号：</label>
                    <input type="text" id="mobile" name="salesorderInfo.mobile" style="width: 150px"
                           readonly="true">
                </td>
                <td>
                    <label for="receivedaddress" class="control-label x90">送货地址：</label>
                    <input type="text" id="receivedaddress" name="salesorderInfo.receivedaddress"
                           class="receivedaddress"
                           data-rule="required" style="width: 150px" readonly="true">
                </td>
                <td>
                    <label for="businessdate" class="control-label x90">业务日期：</label>
                    <input type="text" id="businessdate" value="" name="businessdate" data-toggle="datepicker"
                           data-rule="required" style="width: 150px">
                </td>
                <td>
                    <label for="paymentaccount" class="control-label x90">活动政策：</label>
                    <input type="text" id="paymentaccount" name="salesorderInfo.paymentaccount" class="paymentaccount"
                           style="width: 150px" readonly="true">
                </td>
            </tr>
            <!--主表第三行-->
            <tr>

                <td>
                    <label for="sodoc" class="control-label x90">销售订单：</label>
                    <input type="text" id="sodoc" name="salesorderInfo.sodoc" class="sodoc"
                           data-rule="required" style="width: 150px" readonly="true">
                </td>
                <td colspan="3"><label for="details" class="control-label x90">备注：</label>
                    <textarea type="text" id="details" name="details" size="15"
                              style="width:80%;resize: none"></textarea></td>
            </tr>
            </tbody>
        </table>

        <div style="margin:50px 0 10px 0;">
            <button type="button" class="btn btn-green" data-icon="edit" onclick="select_sales_package('个性包')">选择个性包
            </button>
            <button class="btn-orange" onclick="delete_row()">删除行</button>
            <button class="btn-blue" data-toggle="dialog" data-mask="true">查看附件</button>
        </div>

        <div id="tableContanier">
            <table class="table table-bordered table-hover table-striped bjui-tabledit"
                   id="sales_order_change_design_add_detail_table" data-single-noindex="true">
                <!--表格的头，先加载-->
                <thead>
                <tr>
                    <th title="">行号</th>
                    <th title="">行状态</th>
                    <!--<th title="">工种</th>-->
                    <!--<th title="">材料明细</th>-->
                    <!--<th title="">是否非标</th>-->
                    <th title="">料号</th>
                    <th title="">分类</th>
                    <th title="">品牌</th>
                    <th title="">商品名称</th>
                    <th title="">规格</th>
                    <th title="">型号</th>
                    <th title="">颜色</th>
                    <th title="">材质</th>
                    <th title="">使用阶段</th>
                    <th title="">单位</th>
                    <th title="">毛重</th>
                    <th title="">重量单位</th>
                    <th title="">单位用户量</th>
                    <th title="">修改单位用户量</th>
                    <th title="">最小包装MPQ</th>
                    <th title="">原数量</th>
                    <th title="">修改数量</th>
                    <th title="">变更数量</th>
                    <!--<th title="">销售订单号</th>-->
                    <th title="">销售订单行号</th>

                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <div id="sales_order_change_count"></div>
    </form>
</div>
</body>
</html>