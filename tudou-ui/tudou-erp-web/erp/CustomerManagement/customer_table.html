<html>

<head>
	<script type="text/javascript">

		$('#customer_list_tabel').datagrid({

			local: 'remote',
			dataUrl: '/v1/customer/customerlist',
			dataType: 'json',
			sortAll: false,
			loadType: 'get',
			filterAll: true,
			height:'95%',
			columns: [{name: 'customercode', width: '117', label: '编码'},
				{name: 'cusname', width: '110', label: '姓名'},
				{name: 'mobile', width: '95', label: '手机号'},
				{name: 'state', width: '70', label: '状态'},
				{name: 'orgname', width: '70', label: '组织'},
//				{name: 'stores', width: '150', label: '门店'},
				{name: 'mobilesales', width: '110', label: '美聊员'},
				{name: 'custsales', width: '110', label: '客户经理'},
				{name: 'designer', width: '110', label: '设计师'},
				{name: 'cityname', width: '70', label: '城市'},
				{name: 'community', width: '150', label: '小区名称'},
				{name: 'isverify', type:'select',items: [{'true': '已验证'}, {'false': '未验证'}], width: '70', label: '验证'},
				{name: 'source', width: '150', label: '来源'},
				{name: 'secondsource', width: '150', label: '二级来源'},
				{name: 'maxfollowsnum', width: '70', label: '回访次数'},
				{name: 'scaledate', width: '150', label: '量尺时间'},
				{name: 'createuser', width: '110', label: '创建人'},
				{name: 'createtime', width: '150', label: '创建时间'},
				{name: 'lastuser', width: '110', label: '最后修改人'},
				{name: 'lasttime', width: '150', label: '最后修改时间'},
				{name: 'id', width: '80', label: '主键', hide: true}],
			paging: {pageSize: 50, selectPageSize: '50,100,200', pageCurrent: 1},
			columnMenu: true,
			columnShowhide: true,
			columnFilter: true,
			columnLock: false,
			fullGrid: false,
			dblOnClick: 'customerEdit',

//    showEditbtnscol: true,//是否显示编辑按钮列。
//    editUrl:'/v1/customer/customerlist', //保存编辑、添加数据的url
		});

		function customer_table_getselectedKey() {
			var selected = $("#customer_list_tabel").find('tr.datagrid-selected-tr');
			var selectedKey = "";
			selected.each(function (index, item) {
				selectedKey += item.lastChild.innerText + ",";
			});
			selectedKey = selectedKey.substring(0, selectedKey.length - 1);
			return selectedKey;
		}

		function customer_deleteItems() {
			deleteKeys = customer_table_getselectedKey();
			if (deleteKeys.length > 0) {
				$.ajax({
//            url: '/v1/personnel/delete_personnel?ids='+deleteKeys,
					dataType: 'json',
					type: 'POST',
					xhrFields: {
						withCredentials: true
					},
					crossDomain: true,
					success: function (d) {
						if (d.state == 200) {
							$("body").alertmsg('info', '操作成功');
							$('#customer_list_tabel').datagrid('refresh');
						}
					}
				});
			}
			else {
				$("body").alertmsg('error', '请选择要操作的对象。')
			}
		}

		function customerEdit() {
			var selected = $("#customer_list_tabel").find('tr.datagrid-selected-tr');
			if (selected.length == 0) {
				$(this).alertmsg('error', '请在列表中选择要操作的对象。');
			} else {
				$(this).dialog({
					id: "customer_editBtn",
					title: "客户信息编辑",
					url: "CustomerManagement/customer_edit.html",
					width: 1800,
					height: 900,
					mask: true
				});
			}
		}

		function newcustomerEdit(selected) {
			if (selected.length == 0) {
				$(this).alertmsg('error', '请在列表中选择要操作的对象。');
			} else {
				$(this).dialog({
					id: "customer_editBtn",
					title: "客户信息编辑",
					url: "CustomerManagement/customer_edit.html",
					width: 1800,
					height: 900,
					mask: true
				});
			}
		}

		function toDesignTable(dialogId, title, toPage) {
			customer_table_selected = customer_table_getselectedKey();
			if (customer_table_selected.length == 0) {
				$(this).alertmsg('error', '请在列表中选择要操作的对象。');
			} else {
				$(this).dialog({
					id: "customer_" + dialogId,
					title: title,
					url: "CustomerManagement/" + toPage,
					width: 1050,
					height: 400,
					mask: true
				});
			}
		}

		function importExcel(){
			if (!checkData()){
				$("#upfile").val("");
				return;
			}
			$.ajax({
				url: '/v1/customer/customer_excel_post',
				type: 'POST',
				cache: false,
				data: new FormData($('#form1')[0]),
				processData: false,
				contentType: false
			}).done(function(res) {
				if (res.state == 200){
					$(this).alertmsg('ok', '导入成功');
					$('#customer_list_tabel').datagrid('refresh');
				}else{
					var content = '';
					for (var i = 0; i < res.data.length ; i++){
						content +=res.data[i]+"<br>";
					}

					$(this).alertmsg('info',content,{autoClose:false,title:'导入电话重复项'});
				}
				$("#upfile").val("");
			}).fail(function(res) {
				$("#upfile").val("");
				$(this).alertmsg('error', '导入失败,请重新导入');
			});
		}

		function checkData(){
			var fileDir = $("#upfile").val();
			if(fileDir.length == 0){
				return false;
			}
			var suffix = fileDir.substr(fileDir.lastIndexOf("."));
			if("" == fileDir){
				$(this).alertmsg('info', '选择EXCEL格式的文件导入');
				return false;
			}
			if(".xls" != suffix && ".xlsx" != suffix ){
//				alert("选择Excel格式的文件导入！");
				$(this).alertmsg('info', '选择EXCEL格式的文件导入');
				return false;
			}
			return true;
		}

	</script>
</head>

<body>
<div class="bjui-pageContent" id="customer_all">
	<div style="margin:0px 0px 10px 0px;">
		<button type="button" class="btn btn-blue" data-icon="plus" data-url="CustomerManagement/customer_new.html" data-toggle="dialog" data-id="personnel_n" data-mask="true" data-width="1800" data-height="900"><i class="fa fa-plus"></i>新增
		</button>
		<button type="button" class="btn btn-green" data-icon="edit" onclick="customerEdit()" id="customer_edit"><i class="fa fa-edit"></i>编辑</button>

		<button type="button" class="btn btn-green" data-icon="user"
				onclick="toDesignTable('customer_s','转设计','customer_to_design.html')">转设计
		</button>
		<button type="button" class="btn btn-green" data-icon="user"
				onclick="toDesignTable('customer_x','转销售','customer_to_sale.html')">转销售
		</button>
		<button type="button" class="btn btn-green" data-icon="user"
				onclick="toDesignTable('customer_el','转美聊','customer_to_electric.html')">转美聊
		</button>
		<form id="form1" action="/v1/customer/customer_excel_post" method="post"  enctype="multipart/form-data" class="fa">
			<input type="file" name="file" id="upfile" style="visibility: hidden; position: absolute;" onchange="importExcel()">
			<button type="button" class="btn btn-blue" data-icon="sign-in" onclick="upfile.click()"><i class="fa fa-sign-in"></i>导入</button>
		</form>

	</div>
	<table id="customer_list_tabel" class="table table-hover" data-width="100%"></table>
</div>
</body>

</html>