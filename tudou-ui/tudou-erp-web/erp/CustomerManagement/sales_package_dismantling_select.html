<!DOCTYPE html>
<html lang="en">
<head>
    <script type="text/javascript">
        /**
         * 销售订单选择套餐或者个性包（拆单员）
         * @type {any}
         */
        var type = $.CurrentDialog[0].innerText;
        //展示套餐或者个性包列表
        $("#sales_package_list").datagrid({
            local: 'remote',
            dataUrl: '/v1/myother/getsalespackage?typedocument=' + typedocument,
            dataType: 'json',
            sortAll: false,
            loadType: 'get',
            filterAll: true,
            height:'95%',
            columns: [
                {name: 'salespackagecode', width: '150', label: '编码'},
                {name: 'salespackagename', width: '150', label: '名称'},
                {name: 'typedocument', width: '150', label: '套餐类型'},
                {name: 'id', width: '80', label: '主键', hide: true}
            ],
            showLinenumber: true,
            paging: {pageSize: 50, selectPageSize: '50,100,200', pageCurrent: 1},
            columnMenu: true,
            columnShowhide: true,
            columnFilter: true,
            columnLock: false,
            fullGrid: false
        })
        //将typedocument重新修改成默认值
        typedocument = "套餐";
        //把选中的套餐或者个性包中的详情内容写到子表中
        function sales_package_selected() {
            var selected = $("#sales_package_list").find('tr.datagrid-selected-tr');
            //获取套餐名称
            var typename = selected.find('td').eq(2)[0].innerText;
            $.ajax({
                url: '/v1/myother/getsalespackagelist',
                dataType: 'json',
                type: 'GET',
                data: {
                    id: selected[0].lastChild.innerText,
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    var html = "";
                    if (d.state == 200) {
                        //各数量,添加合计栏时计算
                        var countqty = 0;
                        var countunitqty = 0;//单位用户量
                        var countmpq = 0;

                        //构造html代码
                        for (var i = 0; i < d.data.length; i++) {
                            //需要合计的三个值
                            d.data[i].unitqty == undefined ? countunitqty += 0 : countunitqty += d.data[i].unitqty;
                            d.data[i].mpq == undefined ? countmpq += 0 : countmpq += d.data[i].mpq;
                            d.data[i].qty == undefined ? countmpq += 0 : countqty += d.data[i].qty;
                            var line = i + countline;//todo
                            var isnonstandard =d.data[i].isnonstandard;
                            if(isnonstandard==false){
                                isnonstandard="不是";
                            }
                            if(isnonstandard==true){
                                isnonstandard="是";
                            }
                            html += "<tr>" +
                                    "<td  style='width: 4%'><input   type=text name='salespackage[" + line + "].linenum' readonly=true class='form-control linenum' value=''></td>" +
                                    "<td style='width: 4%'><input   type=text name='salespackage[" + line + "].linestate' readonly=true class='form-control linestate' value=''>" +
                                    "<input   type=hidden name='salespackage[" + line + "].worker' readonly=true class='form-control worker' value='" + d.data[i].worker + "'>" +
                                    "<input   type=hidden name='salespackage[" + line + "].materialdetailed' readonly=true class='form-control materialdetailed' value='" + d.data[i].materialdetailed + "'>" +
                                    "<input   type=hidden name='salespackage[" + line + "].isnonstandard' readonly=true class='form-control isnonstandard' value=" + isnonstandard + "></td>" +
                                    "<td style='width: 11%'><input   type=text name='salespackage[" + line + "].itemno' readonly=true class='form-control itemno' value='" + d.data[i].itemno + "'></td>" +
                                    "<td style='width: 4%'><input   type=text name='salespackage[" + line + "].itemclass' readonly=true class='form-control itemclass' value='" + d.data[i].itemclass + "'></td>" +
                                    "<td style='width: 4%'><input   type=text name='salespackage[" + line + "].brand' readonly=true class='form-control brand' value='" + d.data[i].brand + "'></td>" +
                                    "<td style='width: 26%'><input   type=text name='salespackage[" + line + "].partname' readonly=true class='form-control partname' value='" + d.data[i].partname + "'></td>" +
                                    "<td style='width: 7%'><input   type=text name='salespackage[" + line + "].partspec' readonly=true class='form-control partspec' value='" + d.data[i].partspec + "'></td>" +
                                    "<td style='width: 4%'><input   type=text name='salespackage[" + line + "].partstyle' readonly=true class='form-control partstyle' value='" + d.data[i].partstyle + "'></td>" +
                                    "<td style='width: 4%'><input   type=text name='salespackage[" + line + "].colorlevel' readonly=true class='form-control colorlevel' value='" + d.data[i].colorlevel + "'></td>" +
                                    "<td style='width: 4%'><input   type=text name='salespackage[" + line + "].material' readonly=true class='form-control material' value='" + d.data[i].material + "'></td>" +
                                    "<td style='width: 4%'><input   type=text name='salespackage[" + line + "].usingphase' readonly=true class='form-control usingphase' value=" + d.data[i].usingphase + "></td>" +
                                    "<td style='width: 4%'><input   type=text name='salespackage[" + line + "].funit' readonly=true class='form-control funit' value=" + d.data[i].funit + "></td>"+
                                    "<td style='width: 4%'><input   type=text name='salespackage[" + line + "].grossweight' readonly=true class='form-control grossweight' value=" + d.data[i].grossweight + "></td>"+
                                    "<td style='width: 4%'><input   type=text name='salespackage[" + line + "].unitweight' readonly=true class='form-control unitweight' value=" + d.data[i].unitweight + "></td>";
                            if (type.indexOf("add") > 0) {
                                html += "<td style='width: 4%'><input   type=text name='salespackage[" + line + "].unitqty'  value=0 class='form-control unitqty' onchange='count_add(this.parentNode.parentNode)'></td>";
                            } else {
                                html += "<td style='width: 4%'><input   type=text name='salespackage[" + line + "].unitqty'  value=0 class='form-control unitqty' onchange='count_edit(this.parentNode.parentNode)'></td>";

                            }
                            html += "<td style='width: 4%'><input   class='form-control mpq' readonly=true name='salespackage[" + line + "].mpq' value=" + d.data[i].mpq + "></td>" +
                                    "<td style='width: 4%'><input   class='form-control qty'  name='salespackage[" + line + "].qty' value=0 ></td>" +
                                    "<input   class='form-control itemid' type=hidden readonly=true name='salespackage[" + line + "].itemid' value=" + d.data[i].itemid + " >" + "</tr>";
                        }

                        var html2 = "<table class='table table-bordered table-hover table-striped bjui-tabledit'><tr>" +
                                "<td  style='width: 4%'><input   class='form-control'  value='合计'></td>" +
                                "<td style='width: 4%'><input   type='text'  class='form-control' value></td>" +
                                "<input   type='hidden'  class='form-control' value>" +
                                "<input   type='hidden'  class='form-control' value>" +
                                "<input   type='hidden'  class='form-control' value>" +
                                "<td style='width: 11%'><input   type='text'  class='form-control' value></td>" +
                                "<td style='width: 4%'><input   type='text'  class='form-control' value></td>" +
                                "<td style='width: 4%'><input   type='text'  class='form-control' value></td>" +
                                "<td style='width: 26%'><input   type='text'  class='form-control' value></td>" +
                                "<td style='width: 7%'><input   type='text'  class='form-control' value></td>" +
                                "<td style='width: 4%'><input   type='text'  class='form-control' value></td>" +
                                "<td style='width: 4%'><input   type='text'  class='form-control' value></td>" +
                                "<td style='width: 4%'><input   type='text'  class='form-control' value></td>" +
                                "<td style='width: 4%'><input   type='text'  class='form-control' value></td>" +
                                "<td style='width: 4%'><input   type='text'  class='form-control' value></td>" +
                                "<td style='width: 4%'><input   type='text'  class='form-control' value></td>" +
                                "<td style='width: 4%'><input   type='text'  class='form-control' value></td>" +
                                "<td style='text-align: center;width: 4%'><input   type='text' id='countunitqty' readonly=true class='form-control' value=" + countmpq + "></td>" +
                                "<td style='text-align: center;width: 4%'><input   type='text' id='countmpq'readonly=true  class='form-control' value=" + countmpq + "></td>" +
                                "<td style='text-align: center;width: 4%'><input   type='text' id='countqty' readonly=true class='form-control' value=" + countqty + "></td>" +
                                "</tr></table>";

                        if (type.indexOf("add") > 0) {
                            //如果是新增
                            //如果是第一次就添加合计栏
                            if (isfirst == 0) {
                                $("#sales_order_dismantling_add_detail_table tbody").append(html);
                                countline += d.data.length;
                                $("#sales_order_count").append(html2);
                                //新增合计栏之后次数加1
                                isfirst += 1;
                            } else {
                                //如果选择相同的套餐，则不追加
                                if ($("#salespackage").val().trim() != typename.trim()) {
                                    //把html代码写入明细行table中
                                    $("#sales_order_dismantling_add_detail_table tbody").append(html);
                                    countline += d.data.length;

                                }
                                count_add();
                            }
                            //让选择的行变成class变成selected，其他行变成readonly
                            $("#sales_order_dismantling_add_detail_table tbody tr").click(function () {
                                $(this).removeClass("readonly")
                                        .addClass("selected").siblings("tr").removeClass("selected")
                                        .addClass("readonly");
                            })
                        } else {
                            //如果是编辑
                            //如果选择相同的套餐，则不追加
                            if ($("#salespackage").val().trim() != typename.trim()) {
                                //把html代码写入明细行table中
                                $("#sales_order_dismantling_edit_detail_table tbody").append(html);
                                countline += d.data.length;

                                count_edit();
                            }
                            //让选择的行变成class变成selected，其他行变成readonly
                            $("#sales_order_dismantling_edit_detail_table tbody tr").click(function () {
                                $(this).removeClass("readonly")
                                        .addClass("selected").siblings("tr").removeClass("selected")
                                        .addClass("readonly");
                            })
                        }

                        var salespackagename = $("#sales_package_list .datagrid-selected-tr>td:eq(2)").text();//业务员id
                        var salespackagetype = $("#sales_package_list .datagrid-selected-tr>td:eq(3)").text();//业务员id

                        //如果是套餐则修改页面上套餐名称字段,如果是个性包则不需要修改
                        if ("套餐" == salespackagetype) {
                            $("#salespackage").val(salespackagename);
                        }
                        //关闭对话
                        BJUI.dialog('closeCurrent',this);
                    } else  {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }


    </script>
</head>
<body>
<div class="bjui-pageContent">
    <div style="margin-bottom:15px;">
        <a href="javascript:;" data-toggle="lookupback" onclick="sales_package_selected()" class="btn btn-blue"
           data-args="" title="选择本项" data-icon="check" id="selected_salespackage"><i class="fa fa-check"></i> 选择</a>
        <button type="button" class="btn-close btn" data-icon="close"><i class="fa fa-close"></i> 关闭</button>
    </div>
    <table id="sales_package_list">

    </table>
</div>
</body>
</html>