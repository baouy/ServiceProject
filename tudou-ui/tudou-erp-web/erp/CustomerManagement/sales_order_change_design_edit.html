<!DOCTYPE html>
<html lang="en">
<head>
    <style type="text/css">
        .footer td {
            padding: 0;
        }

        .footer input {
            border-radius: 0;
            border-right: none;
            border-top: none;
            border-bottom: none;
        }
    </style>

    <script type="text/javascript">
        /***
         * 销售变更单编辑页面（设计师）
         * */
                //定义全局变量，已做个性包和套餐的区分
        var typedocument = "套餐";
        //是否为第一次,判断是否需要追加合计栏
        var isfirst = 0;
        //获取该记录的详情
        //        var selected = $("#sales_order_change_design_list").find('tr.datagrid-selected-tr');
        if(thisid==0){
            var selected = $("#sales_order_change_design_list").find('tr.datagrid-selected-tr')[0].lastChild.innerText;
        }else{
            //获取该记录的详情
            var selected=thisid;
            thisid=0;
        }
        countline = 0;
        $.ajax({
            url: '/v1/sochange/findeditsalechangeorders?id=' + selected,
            dataType: 'json',
            type: 'GET',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function (d) {
                if (d.state == 200) {
                    if (d.data.tsochangeValid.state == "已提交") {
                        $("#sales_order_change_design_nocommit_btn").removeAttr("disabled");
                        $("#sales_order_change_design_commit_btn").attr("disabled", "disabled");
                        $("#sales_order_change_design_ed_de").attr("disabled", "disabled");
                    } else if (d.data.tsochangeValid.state == "新增") {
                        $("#sales_order_change_design_nocommit_btn").attr("disabled", "disabled");
                    }
                    $("#doc_edit").val(d.data.tsochangeValid.doc);
                    $("#state_edit").val(d.data.tsochangeValid.state);
//                    $("#stores_edit").val(d.data.tsochangeValid.stores);
                    $("#custsales_edit").val(d.data.tsochangeValid.custsales);
                    $("#custusername_edit").val(d.data.tsochangeValid.custusername);
                    $("#mobile_edit").val(d.data.tsochangeValid.mobile);
                    $("#receivedaddress_edit").val(d.data.tsochangeValid.receivedaddress);
                    $("#businessdate_edit").val(d.data.tsochangeValid.businessdate);
                    $("#paymentaccount_edit").val(d.data.tsochangeValid.paymentaccount);
                    $("#sodoc_edit").val(d.data.tsochangeValid.sodoc);
                    $("#details_edit").val(d.data.tsochangeValid.details);
                    $("#id_edit").val(d.data.tsochangeValid.id);

                    var html = "";
                    if (d.data.tsochangedetailValidList.length !== 0) {
                        for (var i = 0; i < d.data.tsochangedetailValidList.length; i++) {
                            var isnonstandard = d.data.tsochangedetailValidList[i].isnonstandard;
                            if(isnonstandard==false){
                                isnonstandard="不是";
                            }
                            if(isnonstandard==true){
                                isnonstandard="是";
                            }
                            html += "<tr>" +
                                    "<td style='width: 3%'><input type=text  name='salesorder[" + i + "].linenum' readonly=true class='form-control linenum' value=" + d.data.tsochangedetailValidList[i].linenum + "></td>" +
                                    "<td style='width: 3%'><input type=text   name='salesorder[" + i + "].linestate' readonly=true class='form-control linestate' value=" + d.data.tsochangedetailValidList[i].linestate + "></td>" +
                                    "<td style='width: 12%'><input type=text   name='salesorder[" + i + "].itemno' readonly=true class='form-control itemno' value=" + d.data.tsochangedetailValidList[i].itemno + "></td>" +
                                    "<td style='width: 3%'><input type=text   name='salesorder[" + i + "].itemclass' readonly=true class='form-control itemclass' value=" + d.data.tsochangedetailValidList[i].itemclass + "></td>" +
                                    "<td style='width: 3%'><input type=text   name='salesorder[" + i + "].brand' readonly=true class='form-control brand' value=" + d.data.tsochangedetailValidList[i].brand + "></td>" +
                                    "<td style='width: 27%'><input type=text  name='salesorder[" + i + "].partname' readonly=true class='form-control partname' value=" + d.data.tsochangedetailValidList[i].partname + "></td>" +
                                    "<td style='width: 7%'><input type=text  name='salesorder[" + i + "].partspec' readonly=true class='form-control partspec' value=" + d.data.tsochangedetailValidList[i].partspec + "></td>" +
                                    "<td style='width: 3%'><input type=text   name='salesorder[" + i + "].partstyle' readonly=true class='form-control partstyle' value=" + d.data.tsochangedetailValidList[i].partstyle + "></td>" +
                                    "<td style='width: 3%'><input type=text   name='salesorder[" + i + "].colorlevel' readonly=true class='form-control colorlevel' value=" + d.data.tsochangedetailValidList[i].colorlevel + "></td>" +
                                    "<td style='width: 3%'><input type=text   name='salesorder[" + i + "].material' readonly=true class='form-control material' value=" + d.data.tsochangedetailValidList[i].material + "></td>" +
                                    "<td style='width: 3%'><input type=text   name='salesorder[" + i + "].usingphase' readonly=true class='form-control usingphase' value=" + d.data.tsochangedetailValidList[i].usingphase + "></td>" +
                                    "<td style='width: 3%'><input type=text   name='salesorder[" + i + "].funit' readonly=true class='form-control funit' value=" + d.data.tsochangedetailValidList[i].funit + "></td>" +
                                    "<td style='width: 3%'><input type=text   name='salesorder[" + i + "].grossweight' readonly=true class='form-control grossweight' value=" + d.data.tsochangedetailValidList[i].grossweight + "></td>" +
                                    "<td style='width: 3%'><input type=text  name='salesorder[" + i + "].unitweight' readonly=true class='form-control unitweight' value=" + d.data.tsochangedetailValidList[i].unitweight + "></td>" +
                                    "<td style='width: 3%'><input type=text   name='salesorder[" + i + "].oldunitqty' readonly=true class='form-control unitqty' value=" + d.data.tsochangedetailValidList[i].oldunitqty + "></td>" +
                                    "<td style='width: 3%'><input   name='salesorder[" + i + "].modifyunitqty'  value=" + d.data.tsochangedetailValidList[i].modifyunitqty + " class='form-control modifyunitqty' onchange='count_change_edit(this.parentNode.parentNode)'></td>" +
                                    "<td style='width: 3%'><input   class='form-control mpq' readonly=true name='salesorder[" + i + "].mpq' value=" + d.data.tsochangedetailValidList[i].mpq + "></td>" +
                                    "<td style='width: 3%'><input class='form-control qty' readonly=true name='salesorder[" + i + "].oldqty' value="+d.data.tsochangedetailValidList[i].oldqty+" ></td>" +
                                    "<td style='width: 3%'><input   class='form-control modifyqty' readonly=true name='salesorder[" + i + "].modifyqty' value="+d.data.tsochangedetailValidList[i].modifyqty+" ></td>" +
                                    "<td style='width: 3%'><input   class='form-control changeqty' readonly=true name='salesorder[" + i + "].changeqty' value="+d.data.tsochangedetailValidList[i].changeqty+" ></td>" +
                                    "<td style='width: 3%'><input   class='form-control soucrelinenum'readonly=true name='salesorder[" + i + "].soucrelinenum' value=" + d.data.tsochangedetailValidList[i].soucrelinenum+" ></td>" +
                                    "<input class='form-control itemid'  type=hidden readonly=true name='salesorder[" + i + "].itemid' value=" + d.data.tsochangedetailValidList[i].itemid + " >" +
                                    "<input    name='salesorder[" + i + "].id' class='form-control id'  type='hidden' value=" + d.data.tsochangedetailValidList[i].id + ">" +"</tr>";

                        }

                        var html2 = "<table class='table table-bordered table-hover table-striped bjui-tabledit'><tr>" +
                                "<td style='width: 3%'><input class='form-control'    value='合计'></td>" +
                                "<td style='width: 3%'><input type='text'   class='form-control' value></td>" +
                                "<td style='width: 12%'><input type='text'   class='form-control' value></td>" +
                                "<td style='width: 3%'><input type='text'    class='form-control' value></td>" +
                                "<td style='width: 3%'><input type='text'    class='form-control' value></td>" +
                                "<td style='width: 27%'><input type='text'    class='form-control' value></td>" +
                                "<td style='width: 7%'><input type='text'    class='form-control' value></td>" +
                                "<td style='width: 3%'><input type='text'  class='form-control' value></td>" +
                                "<td style='width: 3%'><input type='text'  class='form-control' value></td>" +
                                "<td style='width: 3%'><input type='text'   class='form-control' value></td>" +
                                "<td style='width: 3%'><input type='text'   class='form-control' value></td>" +
                                "<td style='width: 3%'><input type='text'   class='form-control' value></td>" +
                                "<td style='width: 3%'><input type='text'    class='form-control' value></td>" +
                                "<td style='width: 3%'><input type='text'   class='form-control' value></td>" +
                                "<td style='text-align: center;width: 3%'><input  type='text' id='countunitqty' readonly=true class='form-control' value=0></td>" +
                                "<td style='text-align: center;width: 3%'><input  type='text' id='countmodifyunitqty' readonly=true class='form-control' value=0></td>" +
                                "<td style='text-align: center;width: 3%'><input   type='text' id='countmpq'readonly=true  class='form-control' value=0></td>" +
                                "<td style='text-align: center;width: 3%'><input   type='text' id='countqty' readonly=true class='form-control' value=0></td>" +
                                "<td style='text-align: center;width: 3%'><input   type='text' id='countmodifyqty' readonly=true class='form-control' value=0></td>" +
                                "<td style='text-align: center;width: 3%'><input  type='text' id='countchangeqty' readonly=true class='form-control' value=0></td>" +
                                "<td style='width: 3%'><input type='text'   class='form-control' value></td>" +
                                "</tr></table>";
                        $("#sales_order_change_design_edit_detail_table tbody").append(html);
                        countline = $("#sales_order_change_design_edit_detail_table tbody tr").length;//todo

                        $("#sales_order_change_edit_count").append(html2);
                        count_change_edit();

                    }

                    $("#sales_order_change_design_edit_detail_table tbody tr").click(function () {
                        $(this).removeClass("readonly")
                                .addClass("selected").siblings("tr").removeClass("selected")
                                .addClass("readonly");
                    })
                } else  {
                    BJUI.alertmsg('error', d.content, {
                        displayMode: 'fade',
                        alertTimeout: 1000,
                        displayPosition: 'middlecenter'
                    });
                }
            }
        });

        /**
         * 当table中单位用户量unitqty值发生改变时对某些数量进行计算
         * @param theRow
         */
        function count_change_edit(theRow) {
            //根据单位用户量unitqty,和最小包装MPQ mpq计算出所需数量qty
            //qty=unitqty/mpq 向上取整
            var unitqty = $(theRow).find(".unitqty").val();//单位用户量
            var modifyunitqty = $(theRow).find(".modifyunitqty").val();//修改单位用户量
            var mpq = $(theRow).find(".mpq").val();//最小包装MPQ
            var qty = $(theRow).find(".qty").val();//数量
            var modifyqty = Math.ceil(modifyunitqty / mpq);//修改数量数量
            var changeqty = modifyqty-qty;//数量
            $(theRow).find(".modifyqty").val(modifyqty);//数量
            $(theRow).find(".changeqty").val(changeqty);//数量


            //重新合计各数量
            var sumunitqty = 0;
            var summodifyunitqty=0;
            var sunmpq = 0;
            var sumqty = 0;
            var summodifqty=0;
            var sumchangeqty=0;

            for (var i = 0; i < $("#sales_order_change_design_edit_detail_table tbody tr").length; i++) {
                if ($("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(14) input").val() != '') {
                    sumunitqty += parseInt($("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(14) input").val());
                }
                if ($("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(15) input").val() != '') {
                    summodifyunitqty += parseInt($("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(15) input").val());
                }
                if ($("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(16) input").val() != '') {
                    sunmpq += parseInt($("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(16) input").val());
                }

                if ($("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(17) input").val() != '') {
                    sumqty += parseInt($("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(17) input").val());
                }
                if ( $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(18) input").val() != '') {
                    summodifqty +=parseInt($("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(18) input").val());
                }
                if ( $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(19) input").val() != '') {
                    sumchangeqty +=parseInt($("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(19) input").val());
                }
                $("#sales_order_change_edit_count  td:eq(14) input").val(sumunitqty);
                $("#sales_order_change_edit_count  td:eq(15) input").val(summodifyunitqty);
                $("#sales_order_change_edit_count  td:eq(16) input").val(sunmpq);
                $("#sales_order_change_edit_count  td:eq(17) input").val(sumqty);
                $("#sales_order_change_edit_count  td:eq(18) input").val(summodifqty);
                $("#sales_order_change_edit_count  td:eq(19) input").val(sumchangeqty);
            }
        }

        /**
         * 打开套餐选择界面
         * */
        function select_sales_package(type) {
            typedocument = type;
            //打开编辑界面
            $(this).dialog({
                id: "storage_edit",
                title: "选择套餐_edit",
                url: "CustomerManagement/sales_package_change_select.html",

                width: 1050,
                height: 600,
                mask: true
            });
        }

        /**
         * 编辑
         * */
        function sales_order_change_design_reset() {
            if ($("#businessdate_edit").val() !== "" && $("#custusername_edit").val() !== "") {
                var tsochangedetailValidList = [];
                var obj = new Object();
                var tsochangeValid = new Object();
                var selectedId = $("#sales_order_change_design_edit_table input[name='id']").val();
                tsochangeValid = {
                    doc: $("#doc_edit").val(),
//                    stores: $("#stores_edit").val(),
                    custsales: $("#custsales_edit").val(),
                    custusername: $("#custusername_edit").val(),
                    mobile: $("#mobile_edit").val(),
                    receivedaddress: $("#receivedaddress_edit").val(),
                    businessdate: $("#businessdate_edit").val(),
                    paymentaccount: $("#paymentaccount_edit").val(),
                    salespackage: $("#salespackage_edit").val(),
                    details: $("#details_edit").val(),
                    custsalesid: $("#custsalesid_edit").val(),
                    custid: $("#custid_edit").val(),
                    sodoc: $("#sodoc_edit").val(),
//                    storesid: $("#storesid_edit").val(),
                    id: selectedId
                }
                var salesordertable = $("#sales_order_change_design_edit_detail_table tbody tr");
                for (var i = 0; i < salesordertable.length; i++) {
                    var isnonstandard =$("input[name='salesorder[" + i + "].isnonstandard']").val();
                    if(isnonstandard=="是"){
                        isnonstandard=true;
                    }
                    if(isnonstandard=="不是"){
                        isnonstandard=false;
                    }
                    obj = {
                        linenum: $("input[name='salesorder[" + i + "].linenum']").val(),//ok
                        linestate: $("input[name='salesorder[" + i + "].linestate']").val(),//ok
//                        worker: $("input[name='salesorder[" + i + "].worker']").val(),//ok
//                        materialdetailed: $("input[name='salesorder[" + i + "].materialdetailed']").val(),
//                        isnonstandard: isnonstandard,
                        itemno: $("input[name='salesorder[" + i + "].itemno']").val(),
                        itemclass: $("input[name='salesorder[" + i + "].itemclass']").val(),
                        brand: $("input[name='salesorder[" + i + "].brand']").val(),
                        partname: $("input[name='salesorder[" + i + "].partname']").val(),
                        partspec: $("input[name='salesorder[" + i + "].partspec']").val(),
                        partstyle: $("input[name='salesorder[" + i + "].partstyle']").val(),
                        colorlevel: $("input[name='salesorder[" + i + "].colorlevel']").val(),
                        material: $("input[name='salesorder[" + i + "].material']").val(),
                        usingphase: $("input[name='salesorder[" + i + "].usingphase']").val(),
                        funit: $("input[name='salesorder[" + i + "].funit']").val(),
                        oldunitqty: $("input[name='salesorder[" + i + "].oldunitqty']").val(),
                        modifyunitqty: $("input[name='salesorder[" + i + "].modifyunitqty']").val(),
                        mpq: $("input[name='salesorder[" + i + "].mpq']").val(),
                        oldqty: $("input[name='salesorder[" + i + "].oldqty']").val(),
                        modifyqty: $("input[name='salesorder[" + i + "].modifyqty']").val(),
                        changeqty: $("input[name='salesorder[" + i + "].changeqty']").val(),
                        sourcenum: $("#sodoc_edit").val(),
                        soucrelinenum: $("input[name='salesorder[" + i + "].soucrelinenum']").val(),
                        itemid: $("input[name='salesorder[" + i + "].itemid']").val(),
                        grossweight: $("input[name='salesorder[" + i + "].grossweight']").val(),
                        unitweight: $("input[name='salesorder[" + i + "].unitweight']").val(),
                        id: $("input[name='salesorder[" + i + "].id']").val()
                    };
                    tsochangedetailValidList.push(obj);
                }
                objOb = {
                    tsochangedetailValidList,
                    tsochangeValid
                };
                $.ajax({
                    url: '/v1/sochange/resetsalechangeorders',
                    contentType: 'application/json',
                    dataType: 'json',
                    type: 'POST',
                    data: JSON.stringify(objOb),
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (d) {
                        if (d.state == 200) {
                            $("#sales_order_change_design_edit_detail_table tbody tr").addClass("readonly");
                            $('#sales_order_change_design_list').datagrid("refresh");
//                            BJUI.dialog("closeCurrent", this);
                            thisid=selectedId;
                            BJUI.dialog("refresh", this);
                            BJUI.alertmsg('info', d.content, {
                                displayMode: 'fade',
                                alertTimeout: 1000,
                                displayPosition: 'middlecenter'
                            });
                        } else {
                            BJUI.alertmsg('error', d.content, {
                                displayMode: 'fade',
                                alertTimeout: 1000,
                                displayPosition: 'middlecenter'
                            });
                        }
                    }
                });
            } else {
//                $("#purchase_tips").alertmsg('info', '填写内容', {
//                    displayMode: 'fade',
//                    alertTimeout: 1000,
//                    displayPosition: 'middlecenter'
//                });
            }
        }

        /**
         *
         * 提交
         * **/
        function sales_order_change_design_edit_commit() {

            $("#sales_order_change_design_commit_btn").attr("disabled", "disabled");
            //提交前必须先保存
//            sales_order_change_design_reset();
            var id = $("#sales_order_change_design_edit_table input[name='id']").val();
            $.ajax({
                url: '/v1/sochange/commitsalechangeorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: id
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#sales_order_change_design_commit_btn").attr("disabled", "disabled");
                        $("#sales_order_change_design_save_btn").attr("disabled", "disabled");
                        $("#sales_order_change_design_nocommit_btn").removeAttr("disabled");
                        $("#sales_order_change_design_ed_de").attr("disabled", "disabled");
                        $('#sales_order_change_design_list').datagrid("refresh");
                        $("#state_edit").val("已提交");
                        //改变各行提交状态
                        for (var i = 0; i < $("#sales_order_change_design_edit_detail_table tbody tr").length; i++) {
                            $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(1) input").val("已提交")
                        }
                    }else {
                        $("#sales_order_change_design_commit_btn").removeAttr("disabled");

                        BJUI.alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }
        /**
         * 收回
         * **/
        function sales_order_change_design_edit_giveup_commit() {

            $("#sales_order_change_design_nocommit_btn").attr("disabled", "disabled");

            var id = $("#sales_order_change_design_edit_table input[name='id']").val();
            $.ajax({
                url: '/v1/sochange/giveupcommitsalechangeorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: id
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#sales_order_change_design_save_btn").removeAttr("disabled");
                        $("#sales_order_change_design_commit_btn").removeAttr("disabled");
                        $("#sales_order_change_design_ed_de").removeAttr("disabled");
                        $("#sales_order_change_design_nocommit_btn").attr("disabled", "disabled");
                        $('#sales_order_change_design_list').datagrid("refresh");
                        $("#state_edit").val("新增");
                        for (var i = 0; i < $("#sales_order_change_design_edit_detail_table tbody tr").length; i++) {
                            $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") td:eq(1) input").val("新增")
                        }
                    }else  {
                        $("#sales_order_change_design_nocommit_btn").removeAttr("disabled");

                        BJUI.alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }

            });
        }



        /**
         * 删除明细行
         */
        function sales_order_design_del_row() {
            if (1 < $("#sales_order_change_design_edit_detail_table tbody tr").length) {

                var id = $("#sales_order_change_design_edit_detail_table").find(".selected").find(".id").val();

                if (id !== undefined) {
                    sales_del_row(id);
                } else {
                    re_arr_edit_detail_table();
                }
            }
        }

        /**
         * （删除明细行数据前）弹框
         * **/
        var deleteRowId;
        function sales_del_row(id) {
            deleteRowId = id;
            if (1 < $("#sales_order_change_design_edit_detail_table tbody tr").length) {
                $(this).alertmsg('confirm', '确定要删除该行信息吗',
                        {
                            displayMode: 'slide',
                            displayPosition: 'middlecenter',
                            cancelName: '关闭',
                            okName: '确认',
                            title: '删除',
                            okCall: 'salesOrderDelete'
                        });
            }
        }
        /**
         * （确认弹框后）删除明细行数据（实际）
         * **/
        function salesOrderDelete() {
            $.ajax({
                url: '/v1/sochange/deletesalechangeordersdetail',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: deleteRowId
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        //重新排列各行
                        re_arr_edit_detail_table();

                    } else  {
                        BJUI.alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }

        /**
         * （删除整单前）弹框
         * **/
        function sales_order_change_design_delete() {
            BJUI.alertmsg('confirm', '确定要删除吗?', {
                displayMode: 'fade',
                displayPosition: 'middlecenter',
                okName: "是",
                cancelName: "否",
                okCall: 'delete_order'
            });
        }
        /**
         * （确认弹框后）删除整单
         */
        function delete_order() {
            var selected = $("#sales_order_change_design_edit_table input[name='id']").val();
            $.ajax({
                url: '/v1/sochange/deletesalechangeorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: selected
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.dialog("closeCurrent", this);

                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $('#sales_order_change_design_list').datagrid("refresh");
                    } else  {
                        BJUI.alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }
        /**
         * 删除选中行并刷新明细表数据
         */
        function re_arr_edit_detail_table(){
            $("#sales_order_change_design_edit_detail_table").find(".selected").remove();
            for (var i = 0; i < $("#sales_order_change_design_edit_detail_table tbody tr").length; i++) {
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(0)").attr("name", "salesorder[" + i + "].linenum");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(1)").attr("name", "salesorder[" + i + "].linestate");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(2)").attr("name", "salesorder[" + i + "].itemno");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(3)").attr("name", "salesorder[" + i + "].itemclass");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(4)").attr("name", "salesorder[" + i + "].brand");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(5)").attr("name", "salesorder[" + i + "].partname");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(6)").attr("name", "salesorder[" + i + "].partspec");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(7)").attr("name", "salesorder[" + i + "].partstyle");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(8)").attr("name", "salesorder[" + i + "].colorlevel");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(9)").attr("name", "salesorder[" + i + "].material");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(10)").attr("name", "salesorder[" + i + "].usingphase");

                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(11)").attr("name", "salesorder[" + i + "].funit");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(12)").attr("name", "salesorder[" + i + "].grossweight");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(13)").attr("name", "salesorder[" + i + "].unitweight");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(14)").attr("name", "salesorder[" + i + "].oldunitqty");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(15)").attr("name", "salesorder[" + i + "].modifyunitqty");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(16)").attr("name", "salesorder[" + i + "].mpq");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(17)").attr("name", "salesorder[" + i + "].oldqty");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(18)").attr("name", "salesorder[" + i + "].modifyqty");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(19)").attr("name", "salesorder[" + i + "].changeqty");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(20)").attr("name", "salesorder[" + i + "].soucrelinenum");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(21)").attr("name", "salesorder[" + i + "].itemid");
                $("#sales_order_change_design_edit_detail_table tbody tr:eq(" + i + ") input:eq(22)").attr("name", "salesorder[" + i + "].id");

            }
            count_change_edit();
        }
    </script>
</head>
<body>
<div class="bjui-pageContent">
    <form data-toggle="validate" data-toggle="validate">
        <div style="margin:0px 0px 10px 0px;">
            <button class="btn btn-blue" data-icon="save" id="sales_order_change_design_save_btn"
                    onclick="sales_order_change_design_reset()">保存
            </button>
            <button type="button" class="btn btn-green" data-icon="thumbs-up"
                    id="sales_order_change_design_commit_btn" onclick="sales_order_change_design_edit_commit()">提交
            </button>
            <button type="button" class="btn btn-orange" data-icon="thumbs-down"
                    id="sales_order_change_design_nocommit_btn" onclick="sales_order_change_design_edit_giveup_commit()">收回
            </button>
            <button type="button" class="btn btn-red" data-icon="times"
                    id="sales_order_change_design_ed_de" onclick="sales_order_change_design_delete()">删除
            </button>
            <button class="btn-close btn" data-icon="close"><i class="fa fa-close"></i>关闭</button>
        </div>
        <table class="table table-bordered table-hover table-striped table-top bjui-tabledit"
               id="sales_order_change_design_edit_table" width="100%">

            <input type="hidden" name="id" id="id_edit" value="">
            <!--<input type="hidden" name="invoice.custid" value="" id="custid">-->
            <!--<input type="hidden" name="invoice.custsalesid" value="" id="custsalesid">-->
            <!--<input type="hidden" name="invoice.salespackageid" value="" id="salespackageid">-->
            <!--<input type="hidden" name="invoice.storesid" value="" id="storesid">-->
            <tbody>

            <!--主表第一行-->
            <tr>
                <td>
                    <label for="doc_edit" class="control-label x90">单号：</label>
                    <input type="text" id="doc_edit" value="" name="doc" size="15" readonly="true">
                </td>
                <td>
                    <label for="state_edit" class="control-label x90">状态：</label>
                    <input type="text" id="state_edit" value="" name="state" style="width: 150px" readonly="true">
                </td>
                <!--<td>-->
                <!--<label for="stores_edit" class="control-label x90">门店：</label>-->
                <!--<input type="text" id="stores_edit" value="" name="stores" style="width: 150px" readonly="true">-->
                <!--</td>-->

                <td>
                    <label for="custsales_edit" class="control-label x90">客户经理：</label>
                    <input type="text" id="custsales_edit" name="custsales" style="width: 150px" readonly="true">
                </td>
                <td>
                    <label class="control-label x90" for="custusername_edit">客户姓名：</label>
                    <input type="text" id="custusername_edit" name="custusername" style="width: 150px" readonly="true">

                </td>
            </tr>
            <!--主表第二行-->
            <tr>

                <td>
                    <label class="control-label x90" for="mobile_edit">手机号：</label>
                    <input type="text" id="mobile_edit" name="mobile" style="width: 150px"
                           readonly="true">
                </td>
                <td>
                    <label for="receivedaddress_edit" class="control-label x90">送货地址：</label>
                    <input type="text" id="receivedaddress_edit" name="receivedaddress" class="receivedaddress"
                           data-rule="required" style="width: 150px" readonly="true">
                </td>
                <td>
                    <label for="businessdate_edit" class="control-label x90">业务日期：</label>
                    <input type="text" id="businessdate_edit" value="" name="businessdate" data-toggle="datepicker"
                           data-rule="required" style="width: 150px">
                </td>
                <td>
                    <label for="paymentaccount_edit" class="control-label x90">活动政策：</label>
                    <input type="text" id="paymentaccount_edit" value="" class="paymentaccount"
                           style="width: 150px">
                </td>
            </tr>
            <!--主表第三行-->
            <tr>

                <td>
                    <label for="sodoc_edit" class="control-label x90">销售订单：</label>
                    <!--<input type="text" id="salespackage" value="" class="salespackage"-->
                    <!--data-rule="required" style="width: 150px">-->
                    <input type="text" id="sodoc_edit" value="" name="sodoc" data-toggle="datepicker"
                           data-rule="required" style="width: 150px">

                </td>
                <td colspan="3"><label for="details_edit" class="control-label x90">备注：</label>
                    <textarea type="text" id="details_edit" value="" name="details" size="15"
                              style="width:80%;resize: none"></textarea></td>

            </tr>
            </tbody>
        </table>

        <div style="margin:50px 0 10px 0;">
            <!--<button class="btn-default" data-toggle="tableditadd" data-target="#sales_order_change_design_edit_detail_table" data-num="1">-->
            <!--选择个性包-->
            <!--</button>-->
            <!--<button class="btn-default doc_lookup doc_lookup"  data-toggle="lookupbtn" data-url="CustomerManagement/sales_package_select.html" data-group="salespackage" data-id="sales_package" data-title="套餐选择">选择个性包</button>-->
            <button type="button" class="btn btn-green" data-icon="edit" onclick="select_sales_package('个性包')">选择个性包
            </button>

            <button class="btn-orange" onclick="sales_order_design_del_row()">删除行</button>
            <button class="btn-blue" data-toggle="dialog" data-mask="true">查看附件</button>
        </div>

        <div id="tableContanier">
            <table class="table table-bordered table-hover table-striped bjui-tabledit"
                   id="sales_order_change_design_edit_detail_table" data-single-noindex="true">
                <!--表格的头，先加载-->
                <thead>
                <tr>
                    <th title="">行号</th>
                    <th title="">行状态</th>
                    <th title="">料号</th>
                    <th title="">分类</th>
                    <th title="">品牌</th>
                    <th title="">商品名称</th>
                    <th title="">规格</th>
                    <th title="">型号</th>
                    <th title="">颜色</th>
                    <th title="">材质</th>
                    <th title="">使用阶段</th>
                    <th title="">单位</th>
                    <th title="">毛重</th>
                    <th title="">重量单位</th>
                    <th title="">单位用户量</th>
                    <th title="">修改单位用户量</th>
                    <th title="">最小包装MPQ</th>
                    <th title="">原数量</th>
                    <th title="">修改数量</th>
                    <th title="">变更数量</th>
                    <!--<th title="">销售订单号</th>-->
                    <th title="">销售订单行号</th>
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <div id="sales_order_change_edit_count"></div>
    </form>
</div>
</body>
</html>