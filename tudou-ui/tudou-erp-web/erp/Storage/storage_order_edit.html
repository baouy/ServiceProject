<!DOCTYPE html>
<html lang="en">
<head>
    <style type="text/css">
        .footer td {
            padding: 0;
        }

        .footer input {
            border-radius: 0;
            border-right: none;
            border-top: none;
            border-bottom: none;
        }

    </style>
    <script type="text/javascript">

        function storage_reset() {
            var materialsNum = $("#storage_order_table tbody tr:last td:eq(2) input").val();
            //部分字段不能为空
            if ($("#requireddate").val() !== "" && materialsNum !== "") {
//            $("#storage_order_table tbody tr").addClass("readonly");
                var tipdetailValidList = [];
                var obj = new Object();
                var tipValid = new Object();
                var selectedId = $("#storage_main_table input[name='id']").val();
                tipValid = {
                    warehousename:$("#warehousename").val(),
                    supplierid:$("#supplierid").val(),
                    suppliername:$("#suppliername").val(),
                    supplierbatchno:$("#supplierbatchno").val(),
                    batchno:$("#batchno").val(),
                    podoc:$("#podoc").val(),
                    details:$("#details").val(),
                    warehouseid:$("#warehouseid").val(),
                    id:selectedId
                }
                var ordertable = $("#storage_order_ed tbody tr");
                for (var i = 0; i < ordertable.length; i++) {
                    obj = {
                        itemid: $("input[name='order[" + i + "].itemid']").val(),//ok
                        linenum: $("input[name='order[" + i + "].linenum']").val(),//ok
                        linestate: $("input[name='order[" + i + "].linestate']").val(),//ok
                        itemno: $("input[name='order[" + i + "].itemno']").val(),//ok
                        partname: $("input[name='order[" + i + "].partname']").val(),
                        partspec: $("input[name='order[" + i + "].partspec']").val(),
                        partstyle: $("input[name='order[" + i + "].partstyle']").val(),
                        material: $("input[name='order[" + i + "].material']").val(),
                        colorlevel: $("input[name='order[" + i + "].colorlevel']").val(),
                        brand: $("input[name='order[" + i + "].brand']").val(),
                        funit: $("input[name='order[" + i + "].funit']").val(),
                        noinqty: $("input[name='order[" + i + "].noinqty']").val(),
                        qty: $("input[name='order[" + i + "].qty']").val(),
                        warehousename: $("input[name='order[" + i + "].warehousename']").val(),
                        linedetails: $("input[name='order[" + i + "].linedetails']").val(),
                        recqty: $("input[name='order[" + i + "].recqty']").val(),
                        returnqty: $("input[name='order[" + i + "].returnqty']").val(),
                        sourcenum: $("input[name='order[" + i + "].sourcenum']").val(),
                        soucrelinenum: $("input[name='order[" + i + "].soucrelinenum']").val(),
                        warehouseid: $("#warehouseid").val(),
                        id: $("input[name='order[" + i + "].id']").val(),
                        grossweight: $("input[name='order[" + i + "].grossweight']").val(),
                        unitweight: $("input[name='order[" + i + "].unitweight']").val(),

                    };
                    tipdetailValidList.push(obj);
                }
                objOb = {
                    tipdetailValidList,
                    tipValid
                };
                $.ajax({
                    url: '/v1/pi/resetstorageorders',
                    contentType: 'application/json',
                    dataType: 'json',
                    type: 'POST',
                    data: JSON.stringify(objOb),
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (d) {
                        if (d.state == 200) {
                            $("#storage_main_table tbody tr").addClass("readonly");
                            $('#storage_order_list').datagrid("refresh");
                            BJUI.dialog("closeCurrent", this);
                            BJUI.alertmsg('info', d.content, {
                                displayMode: 'fade',
                                alertTimeout: 1000,
                                displayPosition: 'middlecenter'
                            });
                        } else  {
                            BJUI.alertmsg('error', d.content, {
                                displayMode: 'fade',
                                alertTimeout: 1000,
                                displayPosition: 'middlecenter'
                            });
                        }
                    }
                });
            } else {
                $("#storage_tips").alertmsg('info', '填写内容', {
                    displayMode: 'fade',
                    alertTimeout: 1000,
                    displayPosition: 'middlecenter'
                });
            }
        }
        /**
         * 审核
         * **/
        function storage_order_edit_audit() {

            $("#storage_audit").attr("disabled", "disabled");
            var id = $("#storage_main_table input[name='id']").val();
            $.ajax({
                url: '//v1/pi/reviewedstorageorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: id
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#storage_save").attr("disabled", "disabled");
                        $("#storage_delete").attr("disabled", "disabled");
                        $("#storage_audit").attr("disabled", "disabled");
                        $("#storage_giveup").removeAttr("disabled");
                        $('#storage_order_list').datagrid("refresh");
                        $("#state").val("已审核");
                        for (var i = 0; i < $("#storage_order_ed tbody tr").length; i++) {
                            $("#storage_order_ed tbody tr:eq(" + i + ") td:eq(1) input").val("已审核")
                        }
                    } else  {
                        $("#storage_audit").removeAttr("disabled");

                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }

        /**
         * 弃审
         * **/
        function storage_order_edit_giveup_audit() {

            $("#storage_giveup").attr("disabled", "disabled");
            var id = $("#storage_main_table input[name='id']").val();
            $.ajax({
                url: '/v1/pi/giveupreviewedstorageorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: id
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#storage_save").removeAttr("disabled");
                        $("#storage_delete").removeAttr("disabled");
                        $("#storage_audit").removeAttr("disabled");
                        $("#storage_giveup").attr("disabled", "disabled");
                        $('#storage_order_list').datagrid("refresh");
                        $("#state").val("新增");
                        for (var i = 0; i < $("#storage_order_ed tbody tr").length; i++) {
                            $("#storage_order_ed tbody tr:eq(" + i + ") td:eq(1) input").val("新增")
                        }
                    } else  {
                        $("#storage_giveup").removeAttr("disabled");

                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }

        /**
         * 删除
         * **/
        function storage_order_edit_del() {
            if ($("#storage_main_table input[name='id']").val() !== "") {
                BJUI.alertmsg('confirm', '确定要删除吗?', {
                    displayMode: 'fade',
                    displayPosition: 'middlecenter',
                    okName: "是",
                    cancelName: "否",
                    okCall: 'deletestoragerow'
                });
            }
        }

        function deletestoragerow() {
            var selected = $("#storage_main_table input[name='id']").val();
            $.ajax({
                url: '/v1/pi/deletestorageorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: selected
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        BJUI.dialog("closeCurrent", this);
                        $('#storage_order_list').datagrid("refresh");
                    } else  {
                        BJUI.alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }
        ;



        function storage_edit_delete_row() {
            if (1 < $("#storage_order_ed tbody tr").length) {
                var id = $("#storage_order_ed").find(".selected").find(".id").val();
                if (id !== undefined) {//如果改行不是新增的，那就掉接口删除数据库中的数据
                    storage_del_row(id);
                } else {
                    $("#storage_order_ed").find(".selected").remove();//如果是新增的那就直接在页面删除就好，因为还没写进数据库
                }
            }else{
                alert(1)
                BJUI.alertmsg('info', "请保证明细行至少有一行", {
                    displayMode: 'fade',
                    alertTimeout: 1000,
                    displayPosition: 'middlecenter'
                });
            }
        }
        $("#storage_order_ed").on('bjui.initUI', function () {
            $("#storage_order_ed tbody tr").click(function () {
                $(this).removeClass("readonly")
                        .addClass("selected").siblings("tr").removeClass("selected")
                        .addClass("readonly");
            })
        })


        /**
         * 删除列表中的数据
         * **/
        var deleteRowId;
        function storage_del_row(id) {
            deleteRowId = id;
            if (1 < $("#storage_order_ed tbody tr").length) {
                $(this).alertmsg('confirm', '确定要删除该行信息吗',
                        {
                            displayMode: 'slide',
                            displayPosition: 'middlecenter',
                            cancelName: '关闭',
                            okName: '确认',
                            title: '删除',
                            okCall: 'storageDelete'
                        });
            }
        }

        function storageDelete() {
            $.ajax({
                url: '/v1/pi/deletestorageordersdetail',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: deleteRowId
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#storage_order_ed").find(".selected").remove();//如果是新增的那就直接在页面删除就好，因为还没写进数据库
                        for (var i = 0; i < $("#storage_order_ed tbody tr").length; i++) {
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(0)").attr("name", "test[" + i + "].linenum");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(1)").attr("name", "test[" + i + "].linestate");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(2)").attr("name", "test[" + i + "].itemno");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(3)").attr("name", "test[" + i + "].partname");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(4)").attr("name", "test[" + i + "].partspec");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(5)").attr("name", "test[" + i + "].partstyle");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(6)").attr("name", "test[" + i + "].colorlevel");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(7)").attr("name", "test[" + i + "].material");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(8)").attr("name", "test[" + i + "].brand");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(9)").attr("name", "test[" + i + "].funit");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(10)").attr("name", "test[" + i + "].noinqty");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(11)").attr("name", "test[" + i + "].qty");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(12)").attr("name", "test[" + i + "].grossweight");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(13)").attr("name", "test[" + i + "].unitweight");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(14)").attr("name", "test[" + i + "].warehousename");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(15)").attr("name", "test[" + i + "].linedetails");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(16)").attr("name", "test[" + i + "].recqty");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(17)").attr("name", "test[" + i + "].returnqty");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(18)").attr("name", "test[" + i + "].sourcenum");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(19)").attr("name", "test[" + i + "].soucrelinenum");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(20)").attr("name", "test[" + i + "].itemid");
                            $("#storage_order_ed tbody tr:eq(" + i + ") input:eq(21)").attr("name", "test[" + i + "].id");
                        }
                        count_edit();
                    } else  {
                        BJUI.alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }
    </script>
</head>
<body>
<div class="bjui-pageContent">
    <form data-toggle="validate" data-toggle="validate">
        <div style="margin:0px 0px 10px 0px;">
            <button class="btn btn-blue" data-icon="save" id="storage_save" onclick="storage_reset()">保存</button>
            <button type="button" class="btn btn-green" data-icon="thumbs-up" id="storage_audit"
                    onclick="storage_order_edit_audit()">审核
            </button>
            <button type="button" class="btn btn-orange" data-icon="thumbs-down" id="storage_giveup"
                    onclick="storage_order_edit_giveup_audit()">弃审
            </button>
            <button type="button" class="btn btn-red" data-icon="times" id="storage_delete"
                    onclick="storage_order_edit_del()">删除
            </button>
            <button class="btn-close btn" data-icon="close"><i class="fa fa-close"></i>关闭</button>
        </div>

        <table class="table table-bordered table-hover table-striped table-top" width="100%" id="storage_main_table">
            <input type="hidden" name="id" value="" id="id">
            <input type="hidden" id="warehouseid">
            <input type="hidden" id="supplierid">
            <tbody>
            <tr>
                <td>
                    <label for="doc" class="control-label x90">单据号：</label>
                    <input type="text" id="doc" value="" name="doc" size="15" readonly="true">
                </td>
                <td>
                    <label for="businessdate" class="control-label x90">入库日期：</label>
                    <input type="text" id="businessdate" value="" name="businessdate" data-toggle="datepicker"
                           style="width: 150px" readonly="true">
                </td>
                <td>
                    <label for="state" class="control-label x90">状态：</label>
                    <input type="text" id="state" value="" name="state" style="width: 150px" readonly="true">
                </td>
                <td>
                    <label for="orgname" class="control-label x90">组织：</label>
                    <input type="text" id="orgname" value="" name="orgname" style="width: 150px" readonly="true">
                </td>
            </tr>
            <tr>
                <td>
                    <label class="control-label x90">仓库</label>
                    <input type="text" name="storage.warehousename" id="warehousename" data-rule="required"
                           data-url="Storage/storage_selecte.html" data-toggle="lookup" data-group="storage"
                           class="doc_lookup" data-title="仓库选择" style="width: 150px">
                </td>
                <td>
                    <label class="control-label x90" for="suppliername">供应商</label>

                    <input type="text" id="suppliername" value="" name="storageInfo.suppliername" data-rule="required"
                           style="width: 150px">
                </td>
                <td>
                    <label for="supplierbatchno" class="control-label x90">供应商批次号：</label>
                    <input type="text" id="supplierbatchno" value="" name="supplierbatchno"
                           style="width: 150px">
                </td>
                <td>
                    <label for="batchno" class="control-label x90">入库批次：</label>
                    <input type="text" id="batchno" value="" class="batchno" name="batchno"
                           style="width: 150px">
                </td>
            </tr>
            <tr>
                <td>
                    <label for="podoc" class="control-label x90">采购单号：</label>
                    <input type="text" id="podoc" value="" class="podoc" name="storageInfo.podoc" data-rule="required"
                           style="width: 150px">
                </td>
                <td colspan="3"><label for="details" class="control-label x90">备注：</label>
                    <textarea type="text" id="details" value="" name="details" size="15"
                              style="width:150px;resize: none"></textarea></td>
            </tr>
            </tbody>
        </table>
        <div style="margin:50px 0 10px 0;">
            <button class="btn-orange" data-toggle="dialog" data-mask="true" onclick="storage_edit_delete_row()">删除行
            </button>
        </div>

        <table class="table table-bordered table-hover table-striped bjui-tabledit" id="storage_order_ed"
               data-single-noindex="true">
            <thead>
            <tr>
                <th title="">行号</th>
                <th title="">行状态</th>
                <th title="">料号</th>
                <th title="">品名</th>
                <th title="">规格</th>
                <th title="">型号</th>
                <th title="">颜色</th>
                <th title="">材质</th>
                <th title="">品牌</th>
                <th title="">单位</th>
                <th title="">采购未入库数</th>
                <th title="">入库数</th>
                <th title="">毛重</th>
                <th title="">重量单位</th>
                <th title="">仓库</th>
                <th title="">行备注</th>
                <th title="">退货关联数</th>
                <th title="">退货数</th>
                <th title="">来源单号</th>
                <th title="">来源行号</th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
        <div id="count_edit"></div>

    </form>
</div>
<!--部分字段未填写是弹出消息提示用-->
<div id="storage_tips"></div>
</body>
</html>