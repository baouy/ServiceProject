<!DOCTYPE html>
<html lang="en">
<head>
    <script type="text/javascript">

        /**
         * 新增
         * */
        function delivery_order_save() {
            if ($("#warehousename ").val() !== "") {
                var tdeliverydetailValidList = [];
                var obj = new Object();
                var tdeliveryValid = new Object();
                tdeliveryValid = {
                    orderno: $("#orderno").val(),
                    applyorderno: $("#applyorderno").val(),
                    state: $("#state").val(),
                    businessdate: $("#businessdate").val(),
                    receiveduser: $("#receiveduser").val(),
                    receivedphone: $("#receivedphone").val(),
                    receivedaddress: $("#receivedaddress").val(),
                    warehousename: $("#warehousename").val(),
                    driver: $("#driver").val(),
                    driverphone: $("#driverphone").val(),
                    plandate: $("#plandate").val(),
                    plantime: $("#plantime").val(),
                    details: $("#details").val(),
                    contractid: $("#contractid").val(),
                    contractdoc: $("#contractdoc").val(),
                    custname: $("#custname").val(),
                }

                if ($("#delivery_order_add tbody tr").length < 1) {
                    BJUI.alertmsg('error', "至少的有一行明细行记录", {
                        displayMode: 'fade',
                        alertTimeout: 1000,
                        displayPosition: 'middlecenter'
                    });
                } else {
                    var ordertable = $("#delivery_order_add tbody tr");
                    for (var i = 0; i < ordertable.length; i++) {
                        obj = {
                            itemid: $("input[name='delivery_apply[" + i + "].itemid']").val(),//ok
                            linenum: $("input[name='delivery_apply[" + i + "].linenum']").val(),//ok
                            itemno: $("input[name='delivery_apply[" + i + "].itemno']").val(),//ok
                            partname: $("input[name='delivery_apply[" + i + "].partname']").val(),
                            warehousename: $("input[name='delivery_apply[" + i + "].warehousename']").val(),
                            locationname: $("input[name='delivery_apply[" + i + "].locationname']").val(),
                            funit: $("input[name='delivery_apply[" + i + "].funit']").val(),
                            planapplyqty: $("input[name='delivery_apply[" + i + "].planapplyqty']").val(),
                            applyqty: $("input[name='delivery_apply[" + i + "].applyqty']").val(),
                            partspec: $("input[name='delivery_apply[" + i + "].partspec']").val(),
                            partstyle: $("input[name='delivery_apply[" + i + "].partstyle']").val(),
                            colorlevel: $("input[name='delivery_apply[" + i + "].colorlevel']").val(),
                            material: $("input[name='delivery_apply[" + i + "].material']").val(),
                            brand: $("input[name='delivery_apply[" + i + "].brand']").val(),
                            sourcenum: $("input[name='delivery_apply[" + i + "].sourcenum']").val(),
                            soucrelinenum: $("input[name='delivery_apply[" + i + "].soucrelinenum']").val(),
                            recqty: $("input[name='delivery_apply[" + i + "].recqty']").val(),
                            receivedqty: $("input[name='delivery_apply[" + i + "].receivedqty']").val(),
                            salesorderno: $("input[name='delivery_apply[" + i + "].salesorderno']").val(),
                            salesorderlinenum: $("input[name='delivery_apply[" + i + "].salesorderlinenum']").val(),
                            grossweight: $("input[name='delivery_apply[" + i + "].grossweight']").val(),
                            unitweight: $("input[name='delivery_apply[" + i + "].unitweight']").val(),
                        };
                        tdeliverydetailValidList.push(obj);
                    }

                    objOb = {
                        tdeliverydetailValidList,
                        tdeliveryValid
                    };

                    $("#save_btn").attr("disabled", "disabled");
                    $.ajax({
                        url: "/v1/delivery/adddelivery",
                        contentType: 'application/json',
                        dataType: 'json',
                        type: 'POST',
                        data: JSON.stringify(objOb),
                        xhrFields: {
                            withCredentials: true
                        },
                        crossDomain: true,
                        success: function (d) {
                            if (d.state == 200) {
                                BJUI.alertmsg('info', d.content, {
                                    displayMode: 'fade',
                                    alertTimeout: 1000,
                                    displayPosition: 'middlecenter'
                                });
//                        //刷新采购入库单列表
                                $("#delivery_order_list").datagrid("refresh");
//                        //修改按钮状态
//                        $("#order_audit").removeAttr("disabled");
//                        $("#order_delete").removeAttr("disabled");
//                        $("#save_btn").attr("disabled", "disabled");
//                        $("#order_selected").attr("disabled", "disabled");
//
//                        //显示后台传过来的字段
//                        $("input[name='id']").val(d.data.id);
//                        $("#doc").val(d.data.doc);
//                        $("#businessdate").val(d.data.businessdate);
//                        $("#state").val(d.data.state);
//                        $("#orgname").val(d.data.orgname);
//
//                        for (var i = 0; i < $("#delivery_order_add tbody tr").length; i++) {
//                            $("#delivery_order_add tbody tr:eq(" + i + ") td:eq(1) input").val("新增")
//                        }
                                BJUI.dialog("closeCurrent", this);
                            } else {
                                $("#save_btn").removeAttr("disabled");

                                BJUI.alertmsg('error', d.content, {
                                    displayMode: 'fade',
                                    alertTimeout: 1000,
                                    displayPosition: 'middlecenter'
                                });
                            }
                        }
                    })
                }
            }
        }
        /**
         * 审核
         * **/
        function delivery_order_add_audit() {
            var id = $("#delivery_order_table input[name='id']").val();
            $.ajax({
                url: '/v1/pi/revieweddeliveryorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: id
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $('#delivery_order_list').datagrid("refresh");
                        $("#order_audit").attr("disabled", "disabled");//不能审核
                        $("#order_giveup_audit").removeAttr("disabled"); //弃审点亮
                        $("#order_delete").attr("disabled", "disabled");
                    } else {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }
        /**
         * 弃审
         * **/
        function delivery_order_add_giveup_audit() {
            var id = $("#delivery_order_table input[name='id']").val();
            $.ajax({
                url: '/v1/pi/giveuprevieweddeliveryorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: id
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $('#delivery_order_list').datagrid("refresh");
                        //设置按钮可选不可选
                        $("#order_giveup_audit").attr("disabled", "disabled");
                        $("#order_audit").removeAttr("disabled");
                        $("#order_delete").removeAttr("disabled");
                    } else {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }


        function delivery_add_delete_row() {
            if (1 < $("#delivery_order_add tbody tr").length) {
                var id = $("#delivery_order_add").find(".selected").find(".id").val();
                if (id !== undefined) {//如果改行不是新增的，那就掉接口删除数据库中的数据
                    delivery_del_row(id);
                } else {
                    re_arr_add_detail_table();

                }
            } else {
                BJUI.alertmsg('info', "请保证明细行至少有一行", {
                    displayMode: 'fade',
                    alertTimeout: 1000,
                    displayPosition: 'middlecenter'
                });
            }
        }
        $("#delivery_order_add").on('bjui.initUI', function () {
            $("#delivery_order_add tbody tr").click(function () {
                $(this).removeClass("readonly")
                        .addClass("selected").siblings("tr").removeClass("selected")
                        .addClass("readonly");
            })
        })


        /**
         * 删除列表中的数据
         * **/
        var deleteRowId;
        function delivery_del_row(id) {
            deleteRowId = id;
            if (1 < $("#delivery_order_add tbody tr").length) {
                $(this).alertmsg('confirm', '确定要删除该行信息吗',
                        {
                            displayMode: 'slide',
                            displayPosition: 'middlecenter',
                            cancelName: '关闭',
                            okName: '确认',
                            title: '删除',
                            okCall: 'deliveryDelete'
                        });
            }
        }

        function deliveryDelete() {
            $.ajax({
                url: '/v1/pi/deletedeliveryordersdetail',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: deleteRowId
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        re_arr_add_detail_table();
                    } else {
                        BJUI.alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }
        function count_add(theRow) {


            //重新合计各数量
            var sumplanapplyqty = 0;
            var sumapplyqty = 0;
            var sumrecqty = 0;
            var sumreceivedqty = 0;
            var sumgrossweight = 0;

            for (var i = 0; i < $("#delivery_order_add tbody tr").length; i++) {
                if ($("#delivery_order_add tbody tr:eq(" + i + ") td:eq(9) input").val() != '') {
                    sumplanapplyqty += parseInt($("#delivery_order_add tbody tr:eq(" + i + ") td:eq(9) input").val());
                }
                if ($("#delivery_order_add tbody tr:eq(" + i + ") td:eq(10) input").val() != '') {
                    sumapplyqty += parseInt($("#delivery_order_add tbody tr:eq(" + i + ") td:eq(10) input").val());
                }
                if ($("#delivery_order_add tbody tr:eq(" + i + ") td:eq(18) input").val() != '') {
                    sumrecqty += parseInt($("#delivery_order_add tbody tr:eq(" + i + ") td:eq(18) input").val());
                }

                if ($("#delivery_order_add tbody tr:eq(" + i + ") td:eq(19) input").val() != '') {
                    sumreceivedqty += parseInt($("#delivery_order_add tbody tr:eq(" + i + ") td:eq(19) input").val());
                }
                if ($("#delivery_order_add tbody tr:eq(" + i + ") td:eq(7) input").val() != '') {
                    sumgrossweight += parseInt($("#delivery_order_add tbody tr:eq(" + i + ") td:eq(7) input").val()*$("#delivery_order_add tbody tr:eq(" + i + ") td:eq(10) input").val());
                }
                $("#delivery_add_count  td:eq(9) input").val(sumplanapplyqty);
                $("#delivery_add_count  td:eq(10) input").val(sumapplyqty);
                $("#delivery_add_count  td:eq(18) input").val(sumrecqty);
                $("#delivery_add_count  td:eq(7) input").val(sumgrossweight);
            }
        }
        function re_arr_add_detail_table(){
            $("#delivery_order_add").find(".selected").remove();//如果是新增的那就直接在页面删除就好，因为还没写进数据库
            for (var i = 0; i < $("#delivery_order_add tbody tr").length; i++) {
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(0)").attr("name", "delivery_apply[" + i + "].linenum");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(1)").attr("name", "delivery_apply[" + i + "].linestate");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(2)").attr("name", "delivery_apply[" + i + "].itemno");

                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(3)").attr("name", "delivery_apply[" + i + "].partname");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(4)").attr("name", "delivery_apply[" + i + "].warehousename");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(5)").attr("name", "delivery_apply[" + i + "].locationname");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(6)").attr("name", "delivery_apply[" + i + "].funit");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(7)").attr("name", "delivery_apply[" + i + "].planapplyqty");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(8)").attr("name", "delivery_apply[" + i + "].applyqty");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(9)").attr("name", "delivery_apply[" + i + "].partspec");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(10)").attr("name", "delivery_apply[" + i + "].partstyle");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(11)").attr("name", "delivery_apply[" + i + "].colorlevel");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(12)").attr("name", "delivery_apply[" + i + "].material");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(13)").attr("name", "delivery_apply[" + i + "].brand");

                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(14)").attr("name", "delivery_apply[" + i + "].sourcenum");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(15)").attr("name", "delivery_apply[" + i + "].soucrelinenum");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(16)").attr("name", "delivery_apply[" + i + "].recqty");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(17)").attr("name", "delivery_apply[" + i + "].receivedqty");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(18)").attr("name", "delivery_apply[" + i + "].itemid");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(19)").attr("name", "delivery_apply[" + i + "].id");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(20)").attr("name", "delivery_apply[" + i + "].salesorderno");
                $("#delivery_order_add tbody tr:eq(" + i + ") input:eq(21)").attr("name", "delivery_apply[" + i + "].salesorderlinenum");
            }
            count_add();
        }
    </script>
</head>
<body>
<div class="bjui-pageContent">
    <form data-toggle="validate" data-toggle="validate">
        <!--按钮区域-->
        <div style="margin:15px;">
            <button class="btn btn-blue" data-icon="save" id="save_btn" onclick="delivery_order_save()">保存</button>
            <button type="button" class="btn btn-green" data-icon="thumbs-up" disabled="disabled" id="order_audit"
                    onclick="delivery_order_add_audit()">审核
            </button>
            <button type="button" class="btn btn-orange" data-icon="thumbs-down" disabled="disabled"
                    id="order_giveup_audit" onclick="delivery_order_add_giveup_audit()">弃审
            </button>
            <button type="button" class="btn btn-red" data-icon="times" disabled="disabled" id="order_delete"
                    onclick="delivery_order_delete()">删除
            </button>
            <button class="btn-close btn" data-icon="close"><i class="fa fa-close"></i>关闭</button>
            <!--选择采购单,并获取传回来的值,放到data-group中-->
            <button id="order_selected" class="btn-default doc_lookup doc_lookup" data-toggle="lookupbtn"
                    data-url="Storage/delivery_apply_selecte.html" data-group="applyInfo" data-id="delivery_order_se"
                    data-title="选择发货申请单">选择发货申请单
            </button>
        </div>

        <table class="table table-bordered table-hover table-striped table-top bjui-tabledit" id="delivery_order_table"
               width="100%">
            <!--将取出来的值放到table中-->
            <input name="applyInfo.contractid" id="contractid" type="hidden">
            <input name="applyInfo.contractdoc" id="contractdoc" type="hidden">
            <input name="applyInfo.custname" id="custname" type="hidden">
            <input name="id" type="hidden">
            <tbody>
            <tr>
                <td>
                    <label for="orderno" class="control-label x90">单据号：</label>
                    <!--只读-->
                    <input type="text" id="orderno" value="" name="orderno" size="15" readonly="true">
                </td>
                <td>
                    <label for="applyorderno" class="control-label x90">申请单号：</label>
                    <input type="text" id="applyorderno" value="" name="applyInfo.orderno"
                           style="width: 150px" readonly="true">
                </td>
                <td>
                    <label for="state" class="control-label x90">状态：</label>
                    <input type="text" id="state" value="" name="state" style="width: 150px" readonly="true">
                </td>
                <td>
                    <label for="businessdate" class="control-label x90">业务日期：</label>
                    <input type="text" id="businessdate" value="" name="businessdate" data-toggle="datepicker"
                           style="width: 150px">
                </td>
            </tr>
            <tr>
                <td>
                    <label class="control-label x90" for="receiveduser">收货人</label>
                    <!--选择仓库-->
                    <input type="text" name="applyInfo.receiveduser" id="receiveduser"
                           style="width: 150px">
                </td>
                <td>
                    <label class="control-label x90" for="receivedphone">收货人手机</label>

                    <input type="text" id="receivedphone" value="" name="applyInfo.receivedphone"
                           style="width: 150px">
                    <!--<input type="text" id="suppliername" value="" name="supplier.suppliername" data-url="PurchaseManagement/purchase_supplier.html" data-on-load="checkHasSup" data-toggle="lookup" data-group="supplier" data-id="purchase_spplier"  data-rule="required" style="width: 150px">-->
                </td>
                <td>
                    <label for="receivedaddress" class="control-label x90">收货地址：</label>
                    <input type="text" id="receivedaddress" value="" name="applyInfo.receivedaddress" readonly="true"
                           style="width: 150px">
                </td>
                <td>
                    <label for="warehousename" class="control-label x90">出货仓库：</label>
                    <input type="text" name="storage.warehousename" id="warehousename" data-rule="required"
                           data-url="Storage/storage_selecte.html" data-toggle="lookup" data-group="storage"
                           class="doc_lookup" data-title="仓库选择" style="width: 150px">
                </td>
            </tr>
            <tr>
                <td>
                    <label for="driver" class="control-label x90">送货司机：</label>
                    <input type="text" id="driver" value="" name="driver"
                           style="width: 150px">
                </td>
                <td>
                    <label for="driverphone" class="control-label x90">送货司机电话：</label>
                    <input type="text" id="driverphone" value="" name="driverphone"
                           style="width: 150px">
                </td>
                <td>
                    <label for="plandate" class="control-label x90">计划出货日期：</label>
                    <input type="text" id="plandate" value="" class="plandate" name="applyInfo.requiredate"
                           data-toggle="datepicker" data-rule="required"
                           readonly="true" style="width: 150px">
                </td>
                <td>
                    <label for="plantime" class="control-label x90">计划到货时间：</label>
                    <input type="text" id="plantime" value="" class="plantime" name="applyInfo.requiretime"
                           data-rule="required" readonly="true"
                           style="width: 150px">
                </td>
            </tr>
            <tr>
                <td colspan="3"><label for="details" class="control-label x90">备注：</label>
                    <textarea type="text" id="details" value="" name="details" size="15"
                              style="width:150px;resize: none"></textarea></td>
            </tr>
            </tbody>
        </table>

        <div id="tableContanier">

            <div style="margin:50px 0 10px 0;">
                <button class="btn-orange" onclick="delivery_add_delete_row()">删除行</button>
            </div>

            <table class="table table-bordered table-hover table-striped bjui-tabledit" id="delivery_order_add"
                   data-single-noindex="true">
                <!--表格的头，先加载-->
                <thead>
                <tr>
                    <th title="">行号</th>
                    <th title="">行状态</th>
                    <th title="">料号</th>
                    <th title="">品名</th>
                    <th title="">仓库</th>
                    <th title="">库位</th>
                    <th title="">单位</th>
                    <th title="">毛重</th>
                    <th title="">重量单位</th>
                    <th title="">申请数</th>
                    <th title="">发货数</th>
                    <th title="">规格</th>
                    <th title="">型号</th>
                    <th title="">颜色</th>
                    <th title="">材质</th>
                    <th title="">品牌</th>
                    <th title="">申请单号</th>
                    <th title="">申请行号</th>
                    <th title="">关联数</th>
                    <th title="">收货数</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div id="delivery_add_count"></div>

    </form>
</div>
</body>
</html>