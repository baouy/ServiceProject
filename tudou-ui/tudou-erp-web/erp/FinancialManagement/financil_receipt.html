<html>

<head>
	<script type="text/javascript">

		var roleid = $.cookie("roleid");

		if (roleid != 10 && roleid != 6){
			$('#financial_vr_pay_yes').remove();
			$('#financial_vr_pay_no').remove();
		}

		$('#financial_vr_datagrid').datagrid({

			local: 'remote',
			dataUrl: '/v1/financial/voucherlist',
			dataType: 'json',
			sortAll: false,
			loadType: 'get',
			filterAll: true,
			height:'95%',
			columns: [
				{name: 'id', width: '90', label: '订单号', hide:true},
				{name: 'invoicedoc', width: '130', label: '收款单号'},
				{name: 'agreementdoc', width: '80', label: '定金协议号'},
				{name: 'sodoc', width: '100', label: '合同号'},
				{name: 'username', width: '60', label: '姓名'},
				{name: 'mobile', width: '100', label: '手机号'},
				{name: 'paymenttype', width: '80', label: '收款类型'},
				{name: 'paymentamount', width: '100', label: '收款金额'},
				{name: 'paymentmethods', width: '60', label: '收款方式'},
				{name: 'platform', width: '50', label: '发起平台'},
				{name: 'paymentaccount', width: '100', label: '收据号'},
				{name: 'state', width: '50', label: '状态'},
				{name: 'ispay', width: '60', label: '是否收款', type:'select',items:[{'true':'是'}, {'false':'否'}]},
				{name: 'projectmanager', width: '60', label: '验房人员'},
				{name: 'bombstate', width: '60', label: '验房状态'},
				{name: 'details', width: '150', label: '备注'},
				{name: 'createuser', width: '60', label: '创建人'},
				{name: 'createtime', width: '100', label: '创建时间'},
				{name: 'reviewuser', width: '60', label: '审核人'},
				{name: 'reviewtime', width: '100', label: '审核时间'},
				{name: 'orgname', width: '90', label: '组织'}],
			paging: {pageSize: 50, selectPageSize: '50,100,200', pageCurrent: 1},
			columnMenu: true,
			columnShowhide: true,
			columnFilter: true,
			columnLock: false,
			fullGrid: false,
			dblOnClick: 'finnancil_rececipt_editDialog',
		});

		var deltype, editid;
		function finnancil_rececipt_editDialog() {
			var selected = $("#financial_vr_datagrid").find('tr.datagrid-selected-tr');
			if (selected.length == 0) {
				$(this).alertmsg('error', '请在列表中选择要操作的对象。');
			} else if (selected.length > 1) {
				$(this).alertmsg('error', '请选择唯一的操作对象。');
			} else {
				if (selected[0].cells[1].innerText > 0) {
					$(this).dialog({
						id: 'financil_receipt_edit',
						url: 'FinancialManagement/financil_receipt_edit.html',
						title: '编辑',
						width: '1050',
						height: '400',
						mask: true
					});
					editid = selected[0].cells[1].innerText;
				}
			}
		}

		function getvrselectedKey() {
			var selected = $("#financial_vr_datagrid").find('tr.datagrid-selected-tr');
			var selectedKey = "";
			selected.each(function (index, item) {
				selectedKey += item.cells[1].innerText + ",";
			});
			selectedKey = selectedKey.substring(0, selectedKey.length - 1);
			return selectedKey;
		}

		function financial_vr_audit(type, index) {
			var resetKeys;
			if (index == 1) {
				resetKeys = editid;
			} else {
				resetKeys = getvrselectedKey();
			}
			if (resetKeys.length > 0) {
				$.ajax({
					url: '/v1/financial/audit?ids=' + resetKeys + '&type=' + type,
					dataType: 'json',
					type: 'POST',
					xhrFields: {
						withCredentials: true
					},
					crossDomain: true,
					success: function (d) {
						if (d.state == 200) {
							$(this).alertmsg('ok', '操作成功');
							$('#financial_vr_datagrid').datagrid('refresh');
							if (index == 1) {
								if (type) {
									$("#financial_vr_state").val('审核');
									chooseItems(51);
								} else {
									$("#financial_vr_state").val('新增');
									chooseItems(48);
								}
							}
						} else {
							$(this).alertmsg('warn', d.content);
						}

					}
				});
			} else {
				$(this).alertmsg('error', '请选择要操作的对象。');
			}
		}

		function financial_vr_delete() {
			var resetKeys;
			if (deltype) {
				resetKeys = editid;
			} else {
				resetKeys = getvrselectedKey();
			}

			if (resetKeys.length > 0) {
				$.ajax({
					url: '/v1/financial/delete?ids=' + resetKeys,
					dataType: 'json',
					type: 'POST',
					xhrFields: {
						withCredentials: true
					},
					crossDomain: true,
					success: function (d) {
						if (d.state == 200) {
							$(this).alertmsg('ok', '操作成功');
							$('#financial_vr_datagrid').datagrid('refresh');
							if (deltype) {
								BJUI.dialog('closeCurrent', this);
							}
						} else {
							$(this).alertmsg('warn', d.content);
						}
					}
				});
			} else {
				$(this).alertmsg('error', '请选择要操作的对象。');
			}
		}

		function showalert(del) {
			deltype = del;
			$(this).alertmsg('confirm', '确定删除吗?', {okCall: 'financial_vr_delete'});
		}

		function chooseItems(val) {
			if (val == 51) {
				$('#f_save').attr('disabled', "true");
				$('#f_audit').attr('disabled', "true");
				$('#f_del').attr('disabled', "true");
				$('#f_ss').attr('disabled', "true");
				$('#f_ct').attr('disabled', "true");
			} else {
				$('#f_save').removeAttr("disabled");
				$('#f_audit').removeAttr("disabled");
				$('#f_del').removeAttr("disabled");
				$('#f_ss').removeAttr("disabled");
				$('#f_ct').removeAttr("disabled");
			}
		}

		function financial_vr_back(json) {
			if (json.state == 200) {
				BJUI.dialog('closeCurrent', this);
				$('#financial_vr_datagrid').datagrid('refresh');
			}
		}

		var projectmanageids;
		function change_project_manage() {
			projectmanageids = getvrselectedKey();
			if (projectmanageids.length == 0) {
				$(this).alertmsg('error', '请选择要操作的对象。');
				return;
			}

			$(this).dialog({
						id: 'engineering_project_edit',
						url: 'FinancialManagement/financil_projectmanage_table.html',
						title: '质检人员',
						width: '700',
						height: '700',
						mask: true
					}
			);
		}

		var ispay;
		function showalert_pay(pay) {
			ispay = pay;
			$(this).alertmsg('confirm', '确定收款吗?', {okCall: 'financial_vr_pay'});
		}

		function financial_vr_pay(){
			var resetKeys = getvrselectedKey();
			if (resetKeys.length > 0) {
				$.ajax({
					url: '/v1/financial/change_pay?ids=' + resetKeys + '&type=' + ispay,
					dataType: 'json',
					type: 'POST',
					xhrFields: {
						withCredentials: true
					},
					crossDomain: true,
					success: function (d) {
						if (d.state == 200) {
							$(this).alertmsg('ok', "操作成功");
							$('#financial_vr_datagrid').datagrid('refresh');
						} else {
							$(this).alertmsg('warn', d.content);
						}
					}
				});
			} else {
				$(this).alertmsg('warn', '请选择要操作的对象。');
			}
		}

		function checkDataInvoice(){
			var fileDir = $("#upfile").val();
			if(fileDir.length == 0){
				return false;
			}
			var suffix = fileDir.substr(fileDir.lastIndexOf("."));
			if("" == fileDir){
				$(this).alertmsg('info', '选择EXCEL格式的文件导入');
				return false;
			}
			if(".xls" != suffix && ".xlsx" != suffix ){
//				alert("选择Excel格式的文件导入！");
				$(this).alertmsg('info', '选择EXCEL格式的文件导入');
				return false;
			}
			return true;
		}

		function importInvoiceExcel(){
			if (!checkDataInvoice()){
				$("#upfile").val("");
				return;
			}
			$.ajax({
				url: '/v1/financial/invoice_excel_post',
				type: 'POST',
				cache: false,
				data: new FormData($('#form1_Invoice')[0]),
				processData: false,
				contentType: false
			}).done(function(res) {
				if (res.state == 200){
					$(this).alertmsg('ok', '导入成功');
					$('#customer_list_tabel').datagrid('refresh');
				}else{
					var content = '';
					for (var i = 0; i < res.data.length ; i++){
						content +=res.data[i]+"<br>";
					}

					$(this).alertmsg('info',content,{autoClose:false,title:'导入电话重复项'});
				}
				$("#upfile").val("");
			}).fail(function(res) {
				$("#upfile").val("");
				$(this).alertmsg('error', '导入失败,请重新导入');
			});
		}

	</script>
</head>

<body>
<div class="bjui-pageContent">
	<div style="margin:0px 0px 10px 0px;">
		<button type="button" class="btn btn-blue" data-icon="plus" data-url="FinancialManagement/financil_receipt_new.html" data-width="1050"
				data-height="400" data-toggle="dialog" data-id="personnel_n" data-mask="true">新增
		</button>
		<button type="button" class="btn btn-green" data-icon="edit" onclick="finnancil_rececipt_editDialog()">编辑
		</button>
		<button type="button" class="btn btn-green" data-icon="thumbs-up" onclick="financial_vr_audit(true,0)">审核</button>
		<button type="button" class="btn btn-orange" data-icon="thumbs-down" onclick="financial_vr_audit(false,0)">弃审</button>
		<button type="button" class="btn btn-red" data-icon="times" onclick="showalert(false)">删除</button>
		<button type="button" class="btn-default" data-icon="user" onclick="change_project_manage()">验房人员</button>

		<button type="button" id="financial_vr_pay_yes" class="btn btn-green" data-icon="thumbs-up" onclick="showalert_pay(true)">确认收款</button>
		<button type="button" id="financial_vr_pay_no" class="btn btn-orange" data-icon="thumbs-down" onclick="showalert_pay(false)">取消收款</button>

		<form id="form1_Invoice" action="/v1/customer/customer_excel_post" method="post"  enctype="multipart/form-data" class="fa">
			<input type="file" name="file" id="upfile" style="visibility: hidden; position: absolute;" onchange="importInvoiceExcel()">
			<button type="button" class="btn btn-blue" data-icon="sign-in" onclick="upfile.click()"><i class="fa fa-sign-in"></i>导入</button>
		</form>

	</div>
	<table id="financial_vr_datagrid" class="table table-hover" data-width="100%"></table>
</div>
</body>

</html>