<html>
<head>
	<script type="text/javascript">
		contract_detail();
		function contract_detail(){
			var selected = $("#contract_list_datagrid").find('tr.datagrid-selected-tr');
			$.ajax({
				url: '/v1/contract/contract_detail?cid='+selected[0].lastChild.innerText,
				dataType: 'json',
				type: 'GET',
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function(d){
					if(d.state == 200){
						var val;
						for(var i in d.data){
							$.CurrentDialog.find("#contract_"+i).val(d.data[i]);
							if (i == "stateid") {
								val = d.data["stateid"];
								if (val == 51){
									$('#contract_save_btn').attr("disabled","disabled");
									$('#contract_financil_btn').attr("disabled","disabled");

								}
							}
							if (i == "doormodel"){
								$.CurrentDialog.find("#contract_" + i).selectpicker('val',d.data[i]);
							}
							if (i == "provincename") {
								$.CurrentDialog.find("#contract_" + i).selectpicker('val',d.data[i]);
							}
							if (i == "cityname") {
								$.CurrentDialog.find("#contract_" + i).selectpicker('val',d.data[i]);
							}
							if (i == "districtname") {
								$.CurrentDialog.find("#contract_" + i).selectpicker('val',d.data[i]);
							}
							if (i == "contracttype") {
								$.CurrentDialog.find("#contract_" + i).selectpicker('val',d.data[i]);
							}

						}
						cl_chooseItems(val);
						 invoiceId = selected[0].lastChild.innerText;
						contract_invoice(invoiceId);
					}
				}
			});
		}
		/***
		 * 获取跟进收款单列表 编辑
		 * */
		function contract_invoice(id) {
				$('#invoice_notes').datagrid({
				local: 'remote',
				dataUrl: '/v1/financial/customer_voucherlist?contractid='+id,
				dataType: 'json',
				sortAll: false,
				loadType: 'get',
				filterAll: true,
				height:'95%',
				columns: [
					{name: 'businessdate', width: '100', label: '收款日期'},
					{name: 'invoicedoc', width: '120', label: '收款单号'},
					{name: 'paymentmethods', width: '80', label: '收款方式'},
					{name: 'paymentamount', width: '100', label: '收款金额'},
					{name: 'paymenttype', width: '80', label: '收款类型'},
					{name: 'agreementdoc', width: '80', label: '定金协议号'},
					{name: 'state', width: '80', label: '单据状态'},
					{name: 'createuser', width: '70', label: '创建人'},
					{name: 'details', width: '150', label: '备注'},
					{name: 'id', width: '80', label: '主键', hide: true}
				],
				templateWidth: 600,
				showLinenumber: true,
				paging: {pageSize: 50, selectPageSize: '50,100,200', pageCurrent: 1},
				columnMenu: true,
				columnShowhide: true,
				columnFilter: true,
				columnLock: false,
				fullGrid: false,

			});}


		$(function () {
			var roleid = $.cookie("roleid");
			if (roleid == '5'){
				$('#contract_contractdoc').attr('name',"contractdoc");
				$('#contract_contractdoc').removeAttr("readonly");
			}
		});

		$('#contract_standardtime').blur(function(){
			chaneValueDate();
		});

		$('#contract_persontime').blur(function(){
			chaneValueDate();
		});

		$('#contract_standardcost').blur(function(){
			changeValue();
		});

		$('#contract_personproject').blur(function(){
			changeValue();
		});

		$('#contract_servicecost').blur(function(){
			changeValue();
		});

		$('#contract_taxes').blur(function(){
			changeValue();
		});

		$('#contract_contractamount').blur(function(){
			changeMoney();
		});

		$('#contract_firstamount').blur(function(){
			changeMoney();
		});

		function chaneValueDate() {
			var a1 = parseFloat($('#contract_standardtime').val());
			a1 = isNaN(a1)?0.0:a1;
			var a2 = parseFloat($('#contract_persontime').val());
			a2 = isNaN(a2)?0.0:a2;
			var a = a1 + a2;
			$('#contract_totaltime').val(a);
		}

		function changeValue() {
			var a = parseFloat($('#contract_standardcost').val()) + parseFloat($('#contract_personproject').val()) + parseFloat($('#contract_servicecost').val()) + parseFloat($('#contract_taxes').val());

			var a1 = parseFloat($('#contract_standardcost').val());
			a1 = isNaN(a1)?0.0:a1;
			var a2 = parseFloat($('#contract_personproject').val());
			a2 = isNaN(a2)?0.0:a2;
			var a3 = parseFloat($('#contract_servicecost').val());
			a3 = isNaN(a3)?0.0:a3;
			var a4 = parseFloat($('#contract_taxes').val());
			a4 = isNaN(a4)?0.0:a4;

			var a = a1 + a2 + a3 + a4;
			var af=a*0.95;
			$('#contract_contractamount').val(a);
			$('#contract_firstamount').val(af.toFixed(2));
			changeMoney();
		}

		function changeMoney(){

			var a1 = parseFloat($('#contract_contractamount').val());
			a1 = isNaN(a1)?0.0:a1;
			var a2 = parseFloat($('#contract_firstamount').val());
			a2 = isNaN(a2)?0.0:a2;

			var a = a1 - a2;
			$('#contract_lastpayment').val(a.toFixed(2));

		}

	</script>
</head>
<body>
<div class="bjui-pageContent">
	<form action="/v1/contract/contract_reset" data-toggle="validate" data-callback="contract_back" id="contract_info">
		<input type="hidden" value="" name="id" id="contract_id">
		<input type="hidden" value="" name="custid_fk" id="contract_custid_fk">
		<input type="hidden" value="" name="invoiceid" id="contract_invoiceid">
		<input type="hidden" value="" name="supervision" id="contract_supervision">
		<input type="hidden" value="" name="supervisionid" id="contract_supervisionid">
		<div style="margin:15px;">
			<button type="submit" class="btn btn-blue" data-icon="save" data-icon="save" id="contract_save_btn">保存</button>
			<button type="button" class="btn-close" data-icon="close">关闭</button>
			<!--<button class="btn-default" data-url="FinancialManagement/financil_contract_customer_table.html" data-width="1050" data-height="400"-->
			<!--data-toggle="dialog" data-id="contract_c" data-mask="true">客户列表</button>-->

			<button class="btn-default" data-icon="money" data-url="FinancialManagement/financil_contract_vouchar_table.html" data-width="850" data-height="700"
					data-toggle="dialog" data-id="contract_c" data-mask="true" id="contract_financil_btn">订金列表</button>
		</div>
		<table class="table table-condensed table-hover" width="100%">
			<tbody>
			<tr>
				<td>
					<label for="contract_contractdoc" class="control-label x90">合同单号：</label>
					<input type="text" name="contractdoc" id="contract_contractdoc" value=""  size="15" readonly="true">
				</td>
				<td>
					<label for="contract_orgname" class="control-label x90">组织：</label>
					<input type="text" id="contract_orgname" value="" size="15" readonly="true">
				</td>
				<td>
					<label for="contract_contractdate" class="control-label x90">合同日期：</label>
					<input type="text" name="contractdate" id="contract_contractdate" data-toggle="datepicker"  value="" size="15"  data-rule="required">
				</td>
				<td>
					<label for="contract_state" class="control-label x90">状态：</label>
					<input type="text" id="contract_state" value="" name="state" size="15" readonly="true">
				</td>
			</tr>
			<tr>
				<td>
					<label for="contract_custcode" class="control-label x90">客户编码：</label>
					<input type="text" id="contract_custcode" value="" name="custcode"  size="15" readonly="true" data-rule="required">
				</td>
				<td>
					<label for="contract_designer" class="control-label x90">设计师：</label>
					<input type="hidden" value="" name="designerid" id="contract_designerid">
					<input type="text" id="contract_designer" value="" name="designer" size="15" data-rule="required" >
				</td>
				<td>
					<label for="contract_custsales" class="control-label x90">客户经理：</label>
					<input type="hidden" value="" name="custsalesid" id="contract_custsalesid">
					<input type="text" id="contract_custsales" name="custsales" value="" size="15" data-rule="required" >
				</td>
				<td>
					<label for="contract_beautychat" class="control-label x90">渠道员：</label>
					<input type="hidden" value="" name="beautychatid" id="contract_beautychatid">
					<input type="text" id="contract_beautychat" name="beautychat" value="" size="15" readonly="true">
				</td>
			</tr>
			<tr>
				<td>
					<label for="contract_custname" class="control-label x90">姓名：</label>
					<input type="text" id="contract_custname" name="custname" value=""  size="15" readonly="true">
				</td>
				<td>
					<label for="contract_mobile" class="control-label x90">手机号：</label>
					<input type="text" name="mobile" id="contract_mobile" value=""  size="15" readonly="true">
				</td>
				<td>
					<label for="contract_idnumber" class="control-label x90">身份证：</label>
					<input type="text" name="idnumber" id="contract_idnumber" value=""  size="15" data-rule="required">
				</td>
				<td>
					<label for="contract_shippingaddress" class="control-label x90">送货地址：</label>
					<input type="text" name="shippingaddress" id="contract_shippingaddress" value=""  size="15" data-rule="required">
				</td>
			</tr>
			<tr>
				<td>
					<label for="contract_wechat" class="control-label x90">微信号码：</label>
					<input type="text" name="wechat" id="contract_wechat" value=""  size="15" data-rule="required">
				</td>
				<td>
					<label for="contract_contracttype" class="control-label x90">合同类型：</label>
					<select name="contracttype" id="contract_contracttype" data-toggle="selectpicker" data-rule="required">
						<option value="" selected="true">请选择</option>
						<option value="一签">一签</option>
						<option value="二签">二签</option>
						<option value="多签">多签</option>
						<option value="草签">草签</option>
						<option value="七日合同">七日合同</option>
					</select>
				</td>
				<td>
					<label for="contract_agent" class="control-label x90">委托代理人：</label>
					<input type="text" name="agent" id="contract_agent" value=""  size="15">
				</td>
				<td>
					<label for="contract_agentmobile" class="control-label x90">委托代理人电话：</label>
					<input type="text" name="agentmobile" id="contract_agentmobile" value=""  size="15">
				</td>

			</tr>

			<tr>
				<td>
					<label for="contract_buildarea" class="control-label x90">建筑面积：</label>
					<input type="text" name="buildarea" id="contract_buildarea" value=""  size="15" data-rule="number">
				</td>
				<td>
					<label for="contract_usearea" class="control-label x90">使用面积：</label>
					<input type="text" name="usearea" id="contract_usearea" value=""  size="15" data-rule="number">
				</td>
				<td>
					<label for="contract_area" class="control-label x90">项目计价面积：</label>
					<input type="text" name="area" id="contract_area" value=""  size="15" data-rule="required;number">
				</td>
				<td>
				</td>
			</tr>

			<tr>
				<td>
					<label for="contract_provincename" class="control-label x90">省：</label>
					<select name="provincename" id="contract_provincename" data-toggle="selectpicker" data-rule="required">
						<option value="浙江省" selected="true">浙江省</option>
					</select>
				</td>
				<td>
					<label for="contract_cityname" class="control-label x90">市：</label>
					<select name="cityname" id="contract_cityname" data-toggle="selectpicker" data-rule="required">
						<option value="杭州市" selected="true">杭州市</option>
					</select>
				</td>
				<td>
					<label for="contract_districtname" class="control-label x90">区：</label>
					<select name="districtname" id="contract_districtname" data-toggle="selectpicker" data-rule="required">
						<option value="" selected="true">请选择</option>
						<option value="上城区">上城区</option>
						<option value="下城区" >下城区</option>
						<option value="江干区" >江干区</option>
						<option value="拱墅区" >拱墅区</option>
						<option value="西湖区" >西湖区</option>
						<option value="滨江区" >滨江区</option>
						<option value="萧山区" >萧山区</option>
						<option value="余杭区" >余杭区</option>
						<option value="桐庐县" >桐庐县</option>
						<option value="淳安县" >淳安县</option>
						<option value="建德市" >建德市</option>
						<option value="富阳市" >富阳市</option>
						<option value="临安市" >临安市</option>
					</select>
				</td>
				<td>
					<label for="contract_road" class="control-label x90">街道：</label>
					<input type="text" name="road" id="contract_road" value=""  size="15" data-rule="required">
				</td>
			</tr>
			<tr>
				<td>
					<label for="contract_community" class="control-label x90">小区名称：</label>
					<input type="text" name="community" id="contract_community" value=""  size="15" data-rule="required">
				</td>
				<td>
					<label for="contract_building" class="control-label x90">栋数：</label>
					<input type="text" name="building" id="contract_building" value=""  size="15" data-rule="required">
				</td>
				<td>
					<label for="contract_unit" class="control-label x90">单元：</label>
					<input type="text" name="unit" id="contract_unit" value=""  size="15" data-rule="required">
				</td>
				<td>
					<label for="contract_room" class="control-label x90">房号：</label>
					<input type="text" name="room" id="contract_room" value=""  size="15" data-rule="required">
				</td>
			</tr>
			<tr>
				<td>
					<label for="contract_rooms" class="control-label x90">室：</label>
					<input type="text" name="rooms" id="contract_rooms" value=""  size="15" data-rule="required">
				</td>
				<td>
					<label for="contract_hall" class="control-label x90">厅：</label>
					<input type="text" name="hall" id="contract_hall" value=""  size="15" data-rule="required">
				</td>
				<td>
					<label for="contract_kitchen" class="control-label x90">厨：</label>
					<input type="text" name="kitchen" id="contract_kitchen" value=""  size="15" data-rule="required">
				</td>
				<td>
					<label for="contract_toilet" class="control-label x90">卫：</label>
					<input type="text" name="toilet" id="contract_toilet" value=""  size="15" data-rule="required">
				</td>
			</tr>
			<tr>
				<td>
					<label for="contract_balcony" class="control-label x90">阳台：</label>
					<input type="text" name="balcony" id="contract_balcony" value="" size="15" data-rule="required">
				</td>

				<td>
					<label for="contract_standardtime" class="control-label x90">标准工期：</label>
					<input type="text" name="standardtime" id="contract_standardtime" value="" size="15" data-rule="required;number" onkeyup="value=value.replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,'')">
				</td>

				<td>
					<label for="contract_persontime" class="control-label x90">个性化工期：</label>
					<input type="text" name="persontime" id="contract_persontime" value="" size="15" data-rule="required;number" onkeyup="value=value.replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,'')">
				</td>
				<td>
					<label for="contract_totaltime" class="control-label x90">总工期：</label>
					<input type="text" name="totaltime" id="contract_totaltime" value="" size="15" data-rule="required;number" readonly="true">
				</td>
			</tr>
			<tr>
				<td>
					<label for="contract_startdate" class="control-label x90">计划开工：</label>
					<input type="text" name="startdate" id="contract_startdate" data-toggle="datepicker" value=""  size="15" >
				</td>
				<td>
					<label for="contract_deposit" class="control-label x90">已付定金：</label>
					<input type="text" name="deposit" id="contract_deposit" value="" size="15" data-rule="required;number">
				</td>
				<td>
					<label for="contract_standardcost" class="control-label x90">标准项目造价：</label>
					<input type="text" name="standardcost" id="contract_standardcost" value="" size="15" data-rule="required;number" onkeyup="value=value.replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,'')">
				</td>
				<td>
					<label for="contract_personproject" class="control-label x90">个性化项目造价：</label>
					<input type="text" name="personproject" id="contract_personproject" value="" size="15" data-rule="required;number" onkeyup="value=value.replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,'')">
				</td>
			</tr>
			<tr>
				<td>
					<label for="contract_servicecost" class="control-label x90">远程服务：</label>
					<input type="text" name="servicecost" id="contract_servicecost" value="" size="15" data-rule="required;number" onkeyup="value=value.replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,'')">
				</td>
				<td>
					<label for="contract_taxes" class="control-label x90">税款预算：</label>
					<input type="text" name="taxes" id="contract_taxes" value="" size="15" data-rule="required;number" onkeyup="value=value.replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,'')">
				</td>
				<td>
					<label for="contract_contractamount" class="control-label x90">合同金额：</label>
					<input type="text" name="contractamount" id="contract_contractamount" value=""  size="15" data-rule="required;number" readonly="true">
				</td>
				<td>
					<label for="contract_firstamount" class="control-label x90">首付金额：</label>
					<input type="text" name="firstamount" id="contract_firstamount" value="" data-rule="required;number" size="15">
				</td>
			</tr>
			<tr>
				<td>
					<label for="contract_lastpayment" class="control-label x90">尾款金额：</label>
					<input type="text" name="lastpayment" id="contract_lastpayment" value=""  size="15" data-rule="required;number" readonly="true">
				</td>
				<td colspan="3">
					<label for="contract_details" class="control-label x90">备注：</label>
					<textarea name="details" id="contract_details" data-toggle="autoheight" cols="60" rows="1" ></textarea>
				</td>
			</tr>
			<tr>
				<td colspan="4">
					<label for="contract_preferential" class="control-label x90">优惠政策：</label>
					<textarea name="preferential" id="contract_preferential" data-toggle="autoheight" cols="90" rows="1" ></textarea>
				</td>
			</tr>
			</tbody>
		</table>
	</form>
	<div id="bjui bjui-sidebar" style="margin-top: 10px">
			<ul class="nav nav-tabs" role="tablist">
				<li class="active in"><a style="font-size: 13px" href="#notes" role="tab" data-toggle="tab" data-target="#notes">收款记录</a></li>
				<!--<li><a style="font-size: 13px" href="CustomerManagement/customer_cash.html" role="tab" data-toggle="ajaxtab"-->
					   <!--data-target="#messages" data-reload="false" onclick="customer_edit_changeValue(3)">收款信息</a></li>-->
			</ul>
			<div class="tab-content">
					<form action="" data-toggle="validate" id="notes_list" class="pageForm nice-validator n-red"
						  novalidate="novalidate">
						<table class="table table-bordered table-hover table-striped table-top" id="invoice_notes"
							   data-width="100%" data-initnum="0" data-single-noindex="true" data-toggle="tabledit">
						</table>
					</form>
			</div>
	</div>
</div>

</body>
</html>
