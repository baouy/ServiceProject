<script type="text/javascript">

	var roleid = $.cookie("roleid");

	if (roleid != 10 && roleid != 6) {
		$('#financil_contract_pay_yes').remove();
		$('#financil_contract_pay_no').remove();
	}

	$('#contract_list_datagrid').datagrid({
		local: 'remote',
		dataUrl: '/v1/contract/list',
		dataType: 'json',
		sortAll: false,
		loadType: 'get',
		filterAll: true,
		height: '95%',
		columns: [{name: 'contractdoc', width: '110', label: '合同单号'},
			{name: 'custname', width: '70', label: '姓名'},
			{name: 'mobile', width: '100', label: '手机号'},
			{name: 'community', width: '100', label: '小区名'},
			{name: 'area', width: '70', label: '面积'},
			{name: 'state', width: '50', label: '状态'},
			{name: 'ispay', width: '50', type: 'select', label: '是否收款', items: [{'true': '是'}, {'false': '否'}]},
			{name: 'startdate', width: '100', label: '开工日期'},
			{name: 'contractamount', width: '100', label: '合同金额'},
			{name: 'firstamount', width: '100', label: '首付金额'},
			{name: 'details', width: '150', label: '备注'},
			{name: 'designer', width: '70', label: '设计师'},
			{name: 'custsales', width: '70', label: '客户经理'},
			{name: 'orgname', width: '70', label: '组织'},
			{name: 'createuser', width: '70', label: '制单人'},
			{name: 'createtime', width: '100', label: '制单人时间'},
			{name: 'reviewuser', width: '70', label: '审核人'},
			{name: 'reviewtime', width: '100', label: '审核时间'},
			{name: 'id', width: '80', label: '', hide: true}
		],
		paging: {pageSize: 20, selectPageSize: '50,100,200', pageCurrent: 1},
		columnMenu: true,
		columnShowhide: true,
		columnFilter: true,
		columnLock: false,
		fullGrid: false,
		dblOnClick: 'contract_checkDialog',

	});

	var cl_deltype, cl_editid;
	function contract_checkDialog() {
		var selected = $("#contract_list_datagrid").find('tr.datagrid-selected-tr');
		if (selected.length == 0) {
			$(this).alertmsg('error', '请在列表中选择要操作的对象。');
		} else if (selected.length > 1) {
			$(this).alertmsg('error', '请选择唯一的操作对象。');
		} else {
			if (selected[0].lastChild.innerText > 0) {
				cl_editid = selected[0].lastChild.innerText;
				$(this).dialog({
					id: 'engineering_project_edit',
					url: 'FinancialManagement/financil_contract_edit.html',
					title: '编辑',
					width: '1050',
					height: '600',
					mask: true
				});
			}
		}
	}

	function getclselectedKey() {
		var selected = $("#contract_list_datagrid").find('tr.datagrid-selected-tr');
		var selectedKey = "";
		selected.each(function (index, item) {
			selectedKey += selected[0].lastChild.innerText + ",";
		});
		selectedKey = selectedKey.substring(0, selectedKey.length - 1);
		return selectedKey;
	}

	function financial_cl_audit(type, index) {
		var resetKeys;
		if (index == 1) {
			resetKeys = cl_editid;
		} else {
			resetKeys = getclselectedKey();
		}
		if (resetKeys.length > 0) {
			$.ajax({
				url: '/v1/contract/contract_edittype?ids=' + resetKeys + '&type=' + type,
				dataType: 'json',
				type: 'POST',
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function (d) {
					if (d.state == 200) {
						$(this).alertmsg('ok', '操作成功');
						$('#contract_list_datagrid').datagrid('refresh');
						if (index == 1) {
							if (type) {
								$("#contract_state").val('审核');
								cl_chooseItems(51);
							} else {
								$("#contract_state").val('新增');
								cl_chooseItems(48);
							}
						}
					} else {
						$(this).alertmsg('warn', d.content);
					}

				}
			});
		} else {
			$(this).alertmsg('error', '请选择要操作的对象。');
		}
	}

	function financial_cl_delete() {
		var resetKeys;
		if (cl_deltype) {
			resetKeys = cl_editid;
		} else {
			resetKeys = getclselectedKey();
		}

		if (resetKeys.length > 0) {
			$.ajax({
				url: '/v1/contract/contract_delete?ids=' + resetKeys,
				dataType: 'json',
				type: 'POST',
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function (d) {
					if (d.state == 200) {
						$(this).alertmsg('ok', '操作成功');
						$('#contract_list_datagrid').datagrid('refresh');
						if (deltype) {
							BJUI.dialog('closeCurrent', this);
						}
					} else {
						$(this).alertmsg('warn', d.content);

					}
				}
			});
		} else {
			$(this).alertmsg('error', '请选择要操作的对象。');
		}
	}

	function showalert_cl(del) {
		deltype = del;
		$(this).alertmsg('confirm', '确定删除吗?', {okCall: 'financial_cl_delete'});
	}


	function cl_chooseItems(val) {
		if (val == 51) {
			$('#c_save').attr('disabled', "true");
			$('#c_audit').attr('disabled', "true");
			$('#c_at').removeAttr("disabled");
			$('#c_del').attr('disabled', "true");
			$('#c_csl').attr('disabled', "true");

		} else {
			$('#c_save').removeAttr("disabled");
			$('#c_audit').removeAttr("disabled");
			$('#c_at').attr('disabled', "true");
			$('#c_del').removeAttr("disabled");
			$('#c_csl').removeAttr("disabled");
		}
	}

	function contract_back(json) {
		if (json.state == 200) {
			BJUI.dialog('closeCurrent', this);
			$('#contract_list_datagrid').datagrid('refresh');
		} else {
			var content = json.content;
			$(this).alertmsg('error', content);
		}
	}

	var contract_ispay;
	function showalert_contract_pay(pay) {
		contract_ispay = pay;
		$(this).alertmsg('confirm', '确定收款吗?', {okCall: 'financial_contract_pay'});
	}

	function financial_contract_pay() {
		var resetKeys = getclselectedKey();
		if (resetKeys.length > 0) {
			$.ajax({
				url: '/v1/contract/change_pay?ids=' + resetKeys + '&type=' + contract_ispay,
				dataType: 'json',
				type: 'POST',
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function (d) {
					if (d.state == 200) {
						$(this).alertmsg('ok', "操作成功");
						$('#contract_list_datagrid').datagrid('refresh');
					} else {
						$(this).alertmsg('warn', d.content);
					}
				}
			});
		} else {
			$(this).alertmsg('warn', '请选择要操作的对象。');
		}
	}


	function checkDataContract(){
		var fileDir = $("#upfile_c").val();
		if(fileDir.length == 0){
			return false;
		}
		var suffix = fileDir.substr(fileDir.lastIndexOf("."));
		if("" == fileDir){
			$(this).alertmsg('info', '选择EXCEL格式的文件导入');
			return false;
		}
		if(".xls" != suffix && ".xlsx" != suffix ){
			$(this).alertmsg('info', '选择EXCEL格式的文件导入');
			return false;
		}
		return true;
	}

	function import_Contract_Excel(){
		if (!checkDataContract()){
			$("#upfile_c").val("");
			return;
		}
		$.ajax({
			url: '/v1/contract/test_contract_excel_post',
			type: 'POST',
			cache: false,
			data: new FormData($('#form1_Contract')[0]),
			processData: false,
			contentType: false
		}).done(function(res) {
			if (res.state == 200){
				$(this).alertmsg('ok', '导入成功');
				$('#contract_list_datagrid').datagrid('refresh');
			}else{
				var content = '';
				for (var i = 0; i < res.data.length ; i++){
					content +=res.data[i]+"<br>";
				}

				$(this).alertmsg('info',content,{autoClose:false,title:'导入电话重复项'});
			}
			$("#upfile_c").val("");
		}).fail(function(res) {
			$("#upfile_c").val("");
			$(this).alertmsg('error', '导入失败,请重新导入');
		});
	}


</script>
<div class="bjui-pageContent">
	<div style="margin:0px 0px 10px 0px;">
		<button type="button" class="btn btn-blue" data-icon="plus"
				data-url="FinancialManagement/financil_contract_new.html" data-width="1050" data-height="600"
				data-toggle="dialog" data-id="personnel_n" data-mask="true">新增
		</button>
		<button type="button" class="btn btn-green" data-icon="edit" onclick="contract_checkDialog()">编辑</button>
		<button type="button" class="btn btn-green" data-icon="thumbs-up" onclick="financial_cl_audit(true,0)"
				data-width="1050" data-height="400" data-id="contract_d">审核
		</button>
		<button type="button" class="btn btn-orange" data-icon="thumbs-down" onclick="financial_cl_audit(false,0)"
				data-width="1050" data-height="400" data-id="contract_qd">弃审
		</button>
		<button type="button" class="btn btn-red" data-icon="times" onclick="showalert_cl(false)" data-width="1050"
				data-height="400" data-id="personnel_d">删除
		</button>

		<button type="button" id="financial_contract_pay_yes" class="btn btn-green" data-icon="thumbs-up"
				onclick="showalert_contract_pay(true)">确认收款
		</button>
		<button type="button" id="financial_contract_pay_no" class="btn btn-orange" data-icon="thumbs-down"
				onclick="showalert_contract_pay(false)">取消收款
		</button>

		<form id="form1_Contract" action="/v1/contract/test_contract_excel_post" method="post"  enctype="multipart/form-data" class="fa">
			<input type="file" name="file" id="upfile_c" style="visibility: hidden; position: absolute;" onchange="import_Contract_Excel()">
			<button type="button" class="btn btn-blue" data-icon="sign-in" onclick="upfile_c.click()"><i class="fa fa-sign-in"></i>导入</button>
		</form>

	</div>
	<table id="contract_list_datagrid" class="table table-hover" data-width="100%"></table>
</div>