<html>

<head>
    <script type="text/javascript">
        $('#customer_activcost_tabel').datagrid({
            local: 'remote',
            dataUrl: '/v1/customer/customer_activcost_list',
            dataType: 'json',
            sortAll: false,
            loadType: 'GET',
            filterAll: true,
            height:'95%',
            columns:
                    [{name: 'id', width: '117', label: 'id',hide:true},
                        {name: 'type', width: '95', label: '来源', type:'lookup',
                            attrs: {'data-url':'Channel/channel_activtype.html','data-width':1000,'data-title':"来源选择",'readonly':"true"}
                        },
                        {name: 'activname', width: '70', label: '二级来源',attrs:{'readonly':"true"}},
                        {name: 'activnewname', width: '70', label: '三级来源',attrs:{'readonly':"true"}},
                        {name: 'costtime', width: '100', label: '费用日期',type:'date', pattern: 'yyyy-MM-dd',
                    attrs: {'readonly': "true"}   },
                        {name: 'costendtime', width: '100', label: '费用结束日期',type:'date', pattern: 'yyyy-MM-dd',
                            attrs: {'readonly': "true"}   },
                        {name: 'cost', width: '70', label: '费用'},
                        {name: 'rebates', width: '70', label: '比例',render: function(value) {
                            if (value > 0){
                                value += '%'
                            }
                            return value;
                        }},
                        {name: 'actualconsume', width: '70', label: '实际费用',attrs:{'readonly':"true"}},
                    ],
            paging: {pageSize: 50, selectPageSize: '50,100,200', pageCurrent: 1},
            hiddenFields: ['userid','id','depcode'],
            columnMenu: true,
            columnShowhide: true,
            columnFilter: true,
            columnLock: false,
            fullGrid: false,
            showToolbar: true,
            toolbarItem: 'add,save,del,cancel, import',
            delConfirm:true,
            delPK:'id',
            delType:'POST',
            delUrl:'/v1/customer/activcost_del',
            saveAll: true,
            editUrl:'/v1/customer/activcost_post',
            editdblOnclick: true,
            importOption:'channel_excel_onclick',
        });

        function channel_excel_onclick(){
            console.log('a');
            $('#upfile_channel').click();
        }

        function importExcel_channel() {
            if (!checkData_channel()) {
                $("#upfile_channel").val("");
                return;
            }
            $.ajax({
                url: '/v1/customer/activtype_excel_post',
                type: 'POST',
                cache: false,
                data: new FormData($('#form1_channel')[0]),
                processData: false,
                contentType: false
            }).done(function (res) {
                if (res.state == 200) {
                    $(this).alertmsg('ok', '导入成功');
                    $('#customer_activcost_tabel').datagrid('refresh');
                } else {
                    var content = '';
                    for (var i = 0; i < res.data.length; i++) {
                        content += res.data[i] + "<br>";
                    }

                    $(this).alertmsg('info', content, {autoClose: false, title: '导入错误'});
                }
                $("#upfile_channel").val("");
            }).fail(function (res) {
                $("#upfile_channel").val("");
                $(this).alertmsg('error', '导入失败,请重新导入');
            });
        }

        function checkData_channel() {
            var fileDir = $("#upfile_channel").val();
            if (fileDir.length == 0) {
                return false;
            }
            var suffix = fileDir.substr(fileDir.lastIndexOf("."));
            if ("" == fileDir) {
                $(this).alertmsg('info', '选择EXCEL格式的文件导入');
                return false;
            }
            if (".xls" != suffix && ".xlsx" != suffix) {
//				alert("选择Excel格式的文件导入！");
                $(this).alertmsg('info', '选择EXCEL格式的文件导入');
                return false;
            }
            return true;
        }

    </script>
</head>

<body>
<div class="bjui-pageContent" style="margin-top: -10px;">
    <form id="form1_channel" action="/v1/customer/activtype_excel_post" method="post"
          enctype="multipart/form-data" class="fa">
        <input type="file" name="file" id="upfile_channel" style="visibility: hidden; position: absolute;"
               onchange="importExcel_channel()">
        </button>
    </form>
    <table id="customer_activcost_tabel" class="table table-hover" data-width="100%"></table>
</div>
</body>

</html>