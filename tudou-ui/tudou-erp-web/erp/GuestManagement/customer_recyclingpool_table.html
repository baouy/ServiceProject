<script>

	var c_r_table = '#customer_recyclingpool_table'
	$(c_r_table).datagrid({
		local: 'remote',
		dataUrl: '/v1/newcustomer/customer_recyclingpool',
		dataType: 'json',
		sortAll: false,
		loadType: 'get',
		filterAll: true,
		height:'94%',
		columns:
				[{name: 'nextfellowtime', width: '150', label: '下次沟通时间'},
					{name: 'completion', width: '60', label: '完成度'},
					{name: 'intentiontype', width: '95', label: '意向度',type:'select',items: [{'意向客户': '意向客户'}, {'非意向': '非意向'},{'非意向(无人接听/关机)': '非意向(无人接听/关机)'},{'非意向(随便注册)': '非意向(随便注册)'},{'非意向(直接挂断)': '非意向(直接挂断)'},{'非意向(本市非服务范围内)': '非意向(本市非服务范围内)'},{'非意向(外地)': '非意向(外地)'},{'非意向(不足70㎡)': '非意向(不足70㎡)'},{'非意向(房子已装修好)': '非意向(房子已装修好)'},{'非意向(房子太旧)': '非意向(房子太旧)'},{'非意向(大于180㎡)': '非意向(大于180㎡)'},{'非意向(户型不符)': '非意向(户型不符)'},{'非意向(其他)': '非意向(其他)'}]},
					{name: 'cusname', width: '70', label: '姓名'},
					{name: 'mobile', width: '90', label: '电话'},
					{name: 'village', width: '100', label: '小区名称'},
					{name: 'roommodel', width: '70', label: '毛坯平层',type:'select',items: [{'毛坯平层': '毛坯平层'}, {'旧房平层': '旧房平层'}, {'复式毛坯': '复式毛坯'}, {'跃层毛坯': '跃层毛坯'}, {'排屋毛坯': '排屋毛坯'}, {'别墅毛坯': '别墅毛坯'}, {'其他': '其他'}, {'NO':'未填写'}]},
					{name: 'newbudget', width: '70', label: '预算',type:'select',items: [{'7万以下': '7万以下'}, {'7万': '7万'}, {'8万': '8万'}, {'9万': '9万'}, {'10万': '10万'}, {'11万': '11万'}, {'12万': '12万'}, {'13万': '13万'}, {'14万': '14万'}, {'15万': '15万'}, {'15万以上': '15万以上'}, {'NO':'未填写'}]},
					{name: 'area', width: '70', label: '面积',type:'select',items: [{'1': '70㎡以下'}, {'2': '70㎡-80㎡'}, {'3':'80㎡-90㎡'},{'4': '90㎡-100㎡'}, {'5': '100㎡-110㎡'}, {'6':'110㎡-120㎡'}, {'7':'120㎡以上'},{'0':'未填写'}]},
					{name: 'roomstatus', width: '70', label: '交房状态',type:'select',items: [{'现房': '现房'}, {'期房': '期房'}, {'NO':'未填写'}]},
					{name: 'followdate', width: '100', label: '最后一次跟进时间'},
					{name: 'followdetails', width: '200', label: '最后一次跟进内容'},
					{name: 'state', width: '90', label: '状态',type:'select',items: [{'新增': '新增'},{'待跟进': '待跟进'}, {'已邀约': '已邀约'}, {'已分配': '已分配'}, {'已签到': '已签到'}, {'接待中': '接待中'}, {'已付定金': '已付定金'},{'已签约': '已签约'},{'施工中': '施工中'},{'已竣工': '已竣工'}]},
					{name: 'details', width: '150', label: '备注(关注点)'},
					{name: 'marktime', width: '150', label: '到场时间'},
					{name: 'record', width: '150', label: '来源备注'},
                    {name: 'source', width: '150', label: '报名渠道来源',type:'select',items:function(){
                        if (source_content == undefined){
                            source_content = new Array();
                            $.ajax({
                                url: "/v1/other/getalltype?type=10",
                                dataType: 'json',
                                async: false,
                                type: 'GET',
                                xhrFields: {
                                    withCredentials: true
                                },
                                crossDomain: true,
                                success: function (d) {
                                    if (d.state == 200){
                                        var c
                                        for (var i = 0 ; i < d.data.length; i ++){
                                            var b = d.data[i].enumname;
                                            c = new Object();
                                            c[b]= b;
                                            source_content.push(c)
                                        }
                                    }
                                }
                            });
                        }
                        return source_content;
                    }},
					{name: 'mobilesalesdepname', width: '70', label: '美客部门',id:'mobilesalesdepname',type:'select',items:function(){
						if (mobilesalesdepname_content == undefined){
							mobilesalesdepname_content = new Array();
							$.ajax({
								url: '/v1/other/getorgdepdeatil?pid=40',
								dataType: 'json',
								async: false,
								type: 'GET',
								xhrFields: {
									withCredentials: true
								},
								crossDomain: true,
								success: function (d) {
									if (d.state == 200){
										var c
										for (var i = 0 ; i < d.data.length; i ++){
											var b = d.data[i].org_name;
											c = new Object();
											c[b]= b;
											mobilesalesdepname_content.push(c)
										}
									}
								}
							});
						}
						return mobilesalesdepname_content;
					}},
                    {name: 'mobilesales', width: '70', label: '美客员',type:'select',items:function(){
                        if (mobilesales_content == undefined){
                            mobilesales_content = new Array();
                            $.ajax({
                                url: '/v1/user/getdepcode_userlist?code=001002010',
                                dataType: 'json',
                                async: false,
                                type: 'GET',
                                xhrFields: {
                                    withCredentials: true
                                },
                                crossDomain: true,
                                success: function (d) {
                                    if (d.state == 200){
                                        var c
                                        for (var i = 0 ; i < d.data.length; i ++){
                                            var b = d.data[i].flower_name;
                                            c = new Object();
                                            c[b]= b;
                                            mobilesales_content.push(c)
                                        }
                                    }
                                }
                            });
                        }
                        return mobilesales_content;
                    }},
					{name: 'custsalesdepname', width: '70', label: '销售部门',type:'select',items:function(){
						if (custsalesdepname_content == undefined){
							custsalesdepname_content = new Array();
							$.ajax({
								url: '/v1/other/getorgdepdeatil?pid=37',
								dataType: 'json',
								async: false,
								type: 'GET',
								xhrFields: {
									withCredentials: true
								},
								crossDomain: true,
								success: function (d) {
									if (d.state == 200){
										var c
										for (var i = 0 ; i < d.data.length; i ++){
											var b = d.data[i].org_name;
											c = new Object();
											c[b]= b;
											custsalesdepname_content.push(c)
										}
									}
								}
							});
						}
						return custsalesdepname_content;
					}},
					{name: 'custsales', width: '70', label: '客户经理',type:'select',items:function(){
						if (custsales_content == undefined){
							custsales_content = new Array();
							$.ajax({
								url: '/v1/user/getdepcode_userlist?code=001002007',
								dataType: 'json',
								async: false,
								type: 'GET',
								xhrFields: {
									withCredentials: true
								},
								crossDomain: true,
								success: function (d) {
									if (d.state == 200){
										var c
										for (var i = 0 ; i < d.data.length; i ++){
											var b = d.data[i].flower_name;
											c = new Object();
											c[b]= b;
											custsales_content.push(c)
										}
									}
								}
							});
						}
						return custsales_content;
					}},
					/*{name: 'firstamout', width: '70', label: '预定金'},*/
                    {name: 'bookingsituation', width: '70', label: '预售情况'},
					{name: 'orgname', width: '70', label: '组织'},
					{name: 'activitytime', width: '150', label: '最后一次报名时间'},
					{name: 'createtime', width: '150', label: '创建时间'},
					{name: 'lasttime', width: '150', label: '更新时间'},
				],
		paging: {pageSize: 50, selectPageSize: '50,100,200', pageCurrent: 1},
		hiddenFields: ['id','mobilesalesid'],
		toolbarCustom:'<button type="button" class="btn btn-green" data-icon="edit" onclick="recyclingpool_make()"><i class="fa fa-edit"></i>捞取</button>',
		showToolbar: true,
		columnMenu: true,
		columnShowhide: true,
		columnFilter: true,
		columnLock: false,
		fullGrid: false,
		clickRow:'customer_recyclingpool_clickRow',
		headSureBack:'guest_headSureBack'
	});

	var g_r_id = null;
	function customer_recyclingpool_clickRow() {
		var selected = $(c_r_table).data('selectedDatas');
		if (selected[0] != undefined){
			if (selected[0].id != g_r_id){
				g_r_id = selected[0].id;
				$(this).bjuiajax('doLoad', {
					url: 'GuestManagement/recyclingpool_follow_table.html',
					target: '#customer_recyclingpool_follow_div',
					loadingmask: false
				});
			}
		}
	}

	function recyclingpool_make() {
		var selected = recyclingpool_make_getselectedKey();
		if(selected.length > 0){
			$.ajax({
            	url: '/v1/newcustomer/customer_recyclingpool_make?ids='+selected,
				dataType: 'json',
				type: 'POST',
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function (d) {
					if (d.state == 200) {
						$(this).alertmsg('info', '捞取成功');
						$('#customer_recyclingpool_table').datagrid('refresh');
					}
				}
			});
		}else{
			$(this).alertmsg('warn', '请选择要操作的对象。')
		}
	}


	function recyclingpool_make_getselectedKey() {
		var selected = $(c_r_table).data('selectedDatas');
		var selectedKey = "";
		$.each(selected,function (i) {
			selectedKey += selected[i].id + ",";
		});

		selectedKey = selectedKey.substring(0, selectedKey.length - 1);
		return selectedKey;
	}

	function guest_headSureBack() {

		$("select[name='mobilesalesdepname']").change(function() {
			var mt = $("select[name='mobilesalesdepname'] option:selected").val()
			depname_ajax($("select[name='mobilesales']"),mt);

		});
		$("select[name='custsalesdepname']").change(function() {
			var mt = $("select[name='custsalesdepname'] option:selected").val()
			depname_ajax($("select[name='custsales']"),mt);
		});

	}

	function depname_ajax(selectpicker,name) {
		$.ajax({
			url: '/v1/user/getdepname_userlist',
			dataType: 'json',
			type: 'GET',
			data:{
				name:name
			},
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			success: function (d) {
				if (d.state == 200) {
					selectpicker.find('option').remove();
					selectpicker.append($('<option value="">全部</option>'));
					$.each(d.data, function (i) {
						selectpicker.append($("<option value=" + d.data[i].flower_name + ">" + d.data[i].flower_name + "</option>"));
					});
					selectpicker.selectpicker('refresh');
					g_r_id = null;
					$(this).bjuiajax('doLoad', {
						url: 'GuestManagement/recyclingpool_follow_table.html',
						target: '#customer_recyclingpool_follow_div',
						loadingmask: true
					});
				}
			}
		});
	}

</script>

<div style="border: 0px solid green;width: 100% !important;position: relative;height: 60%;">
	<table id="customer_recyclingpool_table" class="table table-hover" data-width="100%"></table>
</div>

<div id="customer_recyclingpool_follow_div" style="border: 0px solid green;width: 100% !important;position: relative;height: 40%;">
	<script>
		$(this).bjuiajax('doLoad', {
			url: 'GuestManagement/recyclingpool_follow_table.html',
			target: '#customer_recyclingpool_follow_div',
			loadingmask: true
		});
	</script>
</div>