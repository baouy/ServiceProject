<!DOCTYPE html>
<html lang="en">
<head>
    <script type="text/javascript">
        var isPurchase = false;
        var childtabelList = [];//子表的数据集,
        var selected = $("#purchase_request_list").find('tr.datagrid-selected-tr');
        var purchaseState = $("#purchase_request_list").find('tr.datagrid-selected-tr td:eq(4)').text();

        /**
         * 采购申请单详情数据(返回数据tprValid数组中),包括原料表的数据(在tprdetailValidList数组中)
         * **/
        $.ajax({
            url: "/v1/pr/findeditprocurement?id=" + selected[0].lastChild.innerText,
            dataType: 'json',
            type: 'GET',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function (d) {
                if (d.state == 200) {
                    isPurchase = d.data.tprValid.ispo;

                    if (d.data.tprValid.state == "新增") {
                        $("#purchase_save_btn").removeAttr("disabled");
                        $("#purchase_audit_btn").removeAttr("disabled");
                        $("#purchase_noaudit_btn").attr("disabled", "disabled");
                        $("#purchase_delete_btn").removeAttr("disabled");
                        $("#purchase_create_po_bt").attr("disabled", "disabled")
                    } else {//已审核
                        if (d.data.tprValid.ispo) {//已生成
                            $("#purchase_save_btn").attr("disabled", "disabled");
                            $("#purchase_audit_btn").attr("disabled", "disabled");
                            $("#purchase_noaudit_btn").attr("disabled", "disabled");
                            $("#purchase_delete_btn").attr("disabled", "disabled");
                            $("#purchase_create_po_bt").attr("disabled", "disabled");
                        } else {
                            $("#purchase_save_btn").attr("disabled", "disabled");
                            $("#purchase_audit_btn").attr("disabled", "disabled");
                            $("#purchase_noaudit_btn").removeAttr("disabled");
                            $("#purchase_delete_btn").attr("disabled", "disabled");
                            $("#purchase_create_po_bt").removeAttr("disabled");
                        }
                    }
                    if (d.data.tprValid.typedocument == "发货采购") {
                        $("#purchase_add").attr("disabled", "disabled");
                    }
                    $("#podoc").val(d.data.tprValid.podoc);
                    $("#id").val(d.data.tprValid.id);
                    $("#businessdate").val(d.data.tprValid.businessdate);
                    $("#state").val(d.data.tprValid.state);
                    $("#orgname").val(d.data.tprValid.orgname);
                    $("#requireddate").val(d.data.tprValid.requireddate);
                    $("#details").val(d.data.tprValid.details);
                    $("#receiveduser").val(d.data.tprValid.receiveduser);
                    $("#receivedphone").val(d.data.tprValid.receivedphone);
                    $("#receivedaddress").val(d.data.tprValid.receivedaddress);
                    $("#contractid").val(d.data.tprValid.contractid);
                    childtabelList = d.data.tprdetailValidList;
                    createTable();//渲染子表
                } else {
                    BJUI.alertmsg('error', d.content, {
                        displayMode: 'fade',
                        alertTimeout: 1000,
                        displayPosition: 'middlecenter'
                    });
                }
            }
        })
        /***
         *原料表的渲染
         * */
        function createTable() {
            var count = 0;
            var html = "";
            if (childtabelList !== 0) {
                for (var i = 0; i < childtabelList.length; i++) {
                    count += childtabelList[i].prqty;
                    html += "<tr class=readonly>" +
                            "<td style='width: 4%'><input type=text name=test[" + i + "].linenum class='linenum form-control' readonly=true   size=2 value=" + childtabelList[i].linenum + "></td>" +
                            "<td style='width: 5%'><input type=text name=test[" + i + "].linestate class=form-control readonly=true value=" + childtabelList[i].linestate + "></td>" +
                            "<td style='width: 8%'><input type=text name=test[" + i + "].itemno class='form-control itemno'  data-toggle='dialog'  value= " + childtabelList[i].itemno + " onclick=selectedMaterials(" + i + ")></td>" +
                            "<td style='width:  18%'><input type=text name=test[" + i + "].partname class='form-control partname' readonly=true   value=" + childtabelList[i].partname + "></td>" +
                            "<td style='width:  5%'><input type=text name=test[" + i + "].partstyle class='form-control partstyle' readonly=true value=" + childtabelList[i].partstyle + "></td>" +
                            "<td style='width:  5%'><input type=text name=test[" + i + "].partspec class='form-control partspec' readonly=true value=" + childtabelList[i].partspec + "></td>" +
                            "<td style='width:  5%'><input type=text name=test[" + i + "].colorlevel class='form-control colorlevel' readonly=true value=" + childtabelList[i].colorlevel + "></td>" +
                            "<td style='width:  5%'><input type=text name=test[" + i + "].material class='form-control material' readonly=true value=" + childtabelList[i].material + "></td>" +
                            "<td style='width:  5%'><input type=text name=test[" + i + "].brand class='form-control brand' readonly=true value=" + childtabelList[i].brand + "></td>" +
                            "<td style='width:  5%'><input type=text name=test[" + i + "].prqty class='form-control prqty' onchange='countNmu()' data-rule='number' value=" + childtabelList[i].prqty + "></td>" +
                            "<td style='width:  5%'><input type=text name=test[" + i + "].funit class='form-control funit' readonly=true value=" + childtabelList[i].funit + "></td>" +
                            "<td style='width:  5%'><input type=text name=test[" + i + "].grossweight class='form-control grossweight' readonly=true value=" + childtabelList[i].grossweight + "></td>" +
                            "<td style='width:  5%'><input type=text name=test[" + i + "].unitweight class='form-control unitweight' readonly=true value=" + childtabelList[i].unitweight + "></td>" +
                            "<td style='width:  5%'><input type=text name=test[" + i + "].linedetails class='form-control linedetails' value=" + childtabelList[i].linedetails + "></td>" +
                            "<td style='width:  5%'><input type=text name=test[" + i + "].poqty class='form-control poqty' readonly=true value=" + childtabelList[i].poqty + "></td>" +
                            "<td style='width:  5%'><input type=text name=test[" + i + "].sourcenum class='form-control sourcenum' readonly=true value=" + childtabelList[i].sourcenum + "></td>" +
                            "<td style='width:  5%'><input type=text name=test[" + i + "].soucrelinenum class='form-control soucrelinenum' readonly=true value=" + childtabelList[i].soucrelinenum + "></td>" +
                            "<input type=hidden name=test[" + i + "].itemid class='form-control itemid' style='display: none' value=" + childtabelList[i].itemid + ">" +
                            "<input type=hidden name=test[" + i + "].id class='form-control id'  value=" + childtabelList[i].id + ">" +
                            "</tr>";//<a class='btn btn-red' onclick=purchase_del_row("+childtabelList[i].id+")>删</a>
                }
                $("#purchase_count").append("<table class='table table-bordered table-hover table-striped bjui-tabledit'><tr>" +
                        "<td style='width: 4%'><input class='form-control' value='合计'></td>" +
                        "<td style='width: 5%'><input type='text'  class='form-control' value></td>" +
                        "<td style='width: 8%'><input type='text' class='form-control' value></td>" +
                        "<td style='width: 18%'><input type='text'  class='form-control' value></td>" +
                        "<td style='width:  5%'><input type='text'  class='form-control' value></td>" +
                        "<td style='width:  5%'><input type='text' class='form-control' value></td>" +
                        "<td style='width:  5%'><input type='text'  class='form-control' value></td>" +
                        "<td style='width:  5%'><input type='text'  class='form-control' value></td>" +
                        "<td style='width:  5%'><input type='text'  class='form-control' value></td>" +
                        "<td style='text-align: center;width:  5%'><input type='text'  class='form-control' value=" + count + "></td>" +
                        "<td style='width:  5%'><input type='text'  class='form-control' value></td>" +
                        "<td style='text-align: center;width:  5%'><input type='text'  class='form-control'></td>" +

                        "<td style='width:  5%'><input type='text' class='form-control' value></td>" +
                        "<td style='width:  5%'><input type='text' class='form-control' value></td>" +
                        "<td style='width:  5%'><input type='text'  class='form-control' value></td>" +
                        "<td style='width:  5%'><input type='text' class='form-control' value></td>" +
                        "<td style='width:  5%'><input type='text'  class='form-control' value></td>" +
                        "</tr></table>");
                $("#purchase_re_table tbody").html(html);
            }
            $("#purchase_re_table tbody tr").click(function () {
                $(this).removeClass("readonly")
                        .addClass("selected").siblings("tr").removeClass("selected")
                        .addClass("readonly");
            })
        }

        $("#purchase_re_table").on('bjui.initUI', function () {
            $("#purchase_re_table tbody tr").click(function () {
                $(this).removeClass("readonly")
                        .addClass("selected").siblings("tr").removeClass("selected")
                        .addClass("readonly");
            })
        })
        function countNmu() {
            var sum = 0;
            for (var i = 0; i < $("#purchase_re_table tbody tr").length; i++) {
                console.log($("#purchase_re_table tbody tr:eq(" + i + ") td:eq(9) input").val())
                sum += parseInt($("#purchase_re_table tbody tr:eq(" + i + ") td:eq(9) input").val());
                $("#purchase_count table tbody tr td:eq(9) input").val(sum)
            }
        }
        /**
         * 删除列表中的数据
         * **/
        var deleteRowId;
        function purchase_del_row(id) {
            deleteRowId = id;
            if (1 < $("#purchase_re_table tbody tr").length) {
                $(this).alertmsg('confirm', '确定要删除该行信息吗',
                        {
                            displayMode: 'slide',
                            displayPosition: 'middlecenter',
                            cancelName: '关闭',
                            okName: '确认',
                            title: '删除',
                            okCall: 'purchaseDelete'
                        });
            }
        }
        /**
         * 删除行
         * @param theRow
         */
        function purchaseDelete() {
            $.ajax({
                url: '/v1/pr/deleteprocurementdetail',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: deleteRowId
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        countNmu();
                        $("#purchase_tips").alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#purchase_re_table tr input[value='" + deleteRowId + "']").parents("tr").remove();
                        for (var i = 0; i < $("#purchase_re_table tbody tr").length; i++) {
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(0)").attr("name", "test[" + i + "].linenum");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(1)").attr("name", "test[" + i + "].linestate");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(2)").attr("name", "test[" + i + "].itemno");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(2)").attr("data-group", "test[" + i + "]");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(2)").siblings("span").attr("data-group", "test[" + i + "]");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(2)").siblings("span").attr("for", "test[" + i + "].itemno");

                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(3)").attr("name", "test[" + i + "].partname");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(4)").attr("name", "test[" + i + "].partstyle");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(5)").attr("name", "test[" + i + "].partspec");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(6)").attr("name", "test[" + i + "].colorlevel");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(7)").attr("name", "test[" + i + "].material");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(8)").attr("name", "test[" + i + "].brand");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(9)").attr("name", "test[" + i + "].prqty");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(10)").attr("name", "test[" + i + "].funit");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(11)").attr("name", "test[" + i + "].grossweight");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(12)").attr("name", "test[" + i + "].unitweight");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(13)").attr("name", "test[" + i + "].linedetails");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(14)").attr("name", "test[" + i + "].poqty");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(15)").attr("name", "test[" + i + "].sourcenum");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(16)").attr("name", "test[" + i + "].soucrelinenum");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(17)").attr("name", "test[" + i + "].itemid");
                            $("#purchase_re_table tbody tr:eq(" + i + ") input:eq(18)").attr("name", "test[" + i + "].id");
                        }
                    } else {
                        $("#purchase_tips").alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });


        }


        /**
         * 选中原材料
         * **/
        function selectedMaterials(id) {
            localStorage.setItem("purchase_selected_material", id);
            $(this).dialog({
                id: "purchase_request",
                title: "材料选则",
                url: "PurchaseManagement/purchase_materials.html",
                height: 400,
                mask: true
            });
        }
        ;
        function purchase_reset() {
            var materialsNum = $("#purchase_re_table tr:last td:eq(2) input").val();
            if ($("#requireddate").val() !== "" && materialsNum !== "") {
                $("#purchase_re_table tbody tr").addClass("readonly");
                var tprdetailValidList = [];
                var obj = new Object();
                var tprValid = new Object();
                var selectedId = $("#purchase_main_table input[name='id']").val();

                tprValid = {
                    requireddate: $("#requireddate").val(),
//                    details:$("#details").val(),
                    podoc: $("#podoc").val(),
                    businessdate: $("#businessdate").val(),
                    contractid: $("#contractid").val(),
//                    state:$("#state").val(),
                    id: selectedId
                }
                var purchasetable = $("#purchase_re_table tbody tr");
                for (var i = 0; i < purchasetable.length; i++) {
                    obj = {
//                    linenum:$("input[name='test["+i+"].linenum']").val(),
                        linestate: $("input[name='test[" + i + "].linestate']").val(),
                        itemno: $("input[name='test[" + i + "].itemno']").val(),
                        partname: $("input[name='test[" + i + "].partname']").val(),
                        partstyle: $("input[name='test[" + i + "].partstyle']").val(),
                        partspec: $("input[name='test[" + i + "].partspec']").val(),
                        colorlevel: $("input[name='test[" + i + "].colorlevel']").val(),
                        material: $("input[name='test[" + i + "].material']").val(),
                        brand: $("input[name='test[" + i + "].brand']").val(),
                        prqty: $("input[name='test[" + i + "].prqty']").val(),
                        funit: $("input[name='test[" + i + "].funit']").val(),
                        linedetails: $("input[name='test[" + i + "].linedetails']").val(),
                        poqty: $("input[name='test[" + i + "].poqty']").val(),
                        sourcenum: $("input[name='test[" + i + "].sourcenum']").val(),
                        soucrelinenum: $("input[name='test[" + i + "].soucrelinenum']").val(),
                        itemid: $("input[name='test[" + i + "].itemid']").val(),
                        id: $("input[name='test[" + i + "].id']").val(),
                        grossweight: $("input[name='test[" + i + "].grossweight']").val(),
                        unitweight: $("input[name='test[" + i + "].unitweight']").val()
                    };
                    tprdetailValidList.push(obj);
                }
                objOb = {
                    tprdetailValidList,
                    tprValid
                };
                $.ajax({
                    url: '/v1/pr/resetprocurement',
                    contentType: 'application/json',
                    dataType: 'json',
                    type: 'POST',
                    data: JSON.stringify(objOb),
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (d) {
                        if (d.state == 200) {
                            $('#purchase_request_list').datagrid("refresh");
                            BJUI.dialog("closeCurrent", this);
                            $("#purchase_tips").alertmsg('info', d.content, {
                                displayMode: 'fade',
                                alertTimeout: 1000,
                                displayPosition: 'middlecenter'
                            });
                            $("#podoc").val(d.data.podoc);
//                        $("#requireddate").val(d.data.requireddate);
                            $("#state").val(d.data.state);
                            $("#orgname").val(d.data.orgname);
                            $("#businessdate").val(d.data.businessdate);
                            $("#purchase_audit_btn").removeAttr("disabled");
                            $("input[name='id']").val(d.data.id);
                        } else {
                            BJUI.alertmsg('error', d.content, {
                                displayMode: 'fade',
                                alertTimeout: 1000,
                                displayPosition: 'middlecenter'
                            });
                        }
                    }
                });
            } else {
                $("#purchase_tips").alertmsg('info', '填写内容', {
                    displayMode: 'fade',
                    alertTimeout: 1000,
                    displayPosition: 'middlecenter'
                });
            }


        }


        /**
         * 审核
         */
        function purchase_edit_audit() {
            $("#purchase_audit_btn").attr("disabled", "disabled");

            var id = $("#purchase_main_table input[name='id']").val();
            $.ajax({
                url: '/v1/pr/reviewedprocurement',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: id
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        $("#purchase_tips").alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#purchase_audit_btn").attr("disabled", "disabled");
                        if (!isPurchase) { //是否显示生成采购单
                            $("#purchase_create_po_bt").removeAttr("disabled");
                        }
                        $("#purchase_save_btn").attr("disabled", "disabled");
                        $("#purchase_delete_btn").attr("disabled", "disabled");
                        $("#purchase_noaudit_btn").removeAttr("disabled");
                        $('#purchase_request_list').datagrid("refresh");
                        $("#state").val("已审核");

                        for (var i = 0; i < $("#purchase_re_table tbody tr").length; i++) {
                            $("#purchase_re_table tbody tr:eq(" + i + ") td:eq(1) input").val("已审核");
                        }

                    } else {
                        $("#purchase_audit_btn").removeAttr("disabled");

                        $("#purchase_tips").alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
//                    $("#purchase_audit_btn").attr("disabled","disabled");
//                    $("#purchase_noaudit_btn").removeAttr("disabled");
                    }
                }
            });
        }

        /***
         * 弃审
         * */
        function purchase_giveup_audit() {

            $("#purchase_noaudit_btn").attr("disabled", "disabled");

            var id = $("#purchase_main_table input[name='id']").val();
            $.ajax({
                url: '/v1/pr/giveupreviewedprocurement',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: id
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        $("#purchase_tips").alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#purchase_noaudit_btn").attr("disabled", "disabled");
                        $("#purchase_create_po_bt").attr("disabled", "disabled");
                        $("#purchase_delete_btn").removeAttr("disabled");
                        $("#purchase_audit_btn").removeAttr("disabled");
                        $('#purchase_request_list').datagrid("refresh");
                        $("#purchase_save_btn").removeAttr("disabled");
                        $("#state").val("新增");

                        for (var i = 0; i < $("#purchase_re_table tbody tr").length; i++) {
                            $("#purchase_re_table tbody tr:eq(" + i + ") td:eq(1) input").val("新增");
                        }

                    } else {
                        $("#purchase_noaudit_btn").removeAttr("disabled");

                        $("#purchase_tips").alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }


        function delete_purchase() {
            var selected = $("#purchase_main_table input[name='id']").val();
            $.ajax({
                url: '/v1/pr/deleteprocurement',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: selected
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        $("#purchase_tips").alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $('#purchase_request_list').datagrid("refresh");
                        BJUI.dialog("closeCurrent", this);
                    } else {
                        $("#purchase_tips").alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }

        function purchase_detail_delete_audit() {
            $("#purchase_tips").alertmsg('confirm', '确定要删除吗?', {
                displayMode: 'fade',
                displayPosition: 'middlecenter',
                okName: "是",
                cancelName: "否",
                okCall: 'delete_purchase'
            });

        }

        function purchase_create_po() {
            var podoc = $("#podoc").val();

            $("#purchase_create_po_bt").attr("disabled", "disabled");
            $.ajax({
                url: '/v1/pr/generateprocurementorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    podoc: podoc
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        $("#purchase_tips").alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $('#purchase_request_list').datagrid("refresh");
                        $("#purchase_create_po_bt").attr("disabled", "disabled");
                        BJUI.dialog("closeCurrent", this);
                    } else {
                        $("#purchase_create_po_bt").removeAttr("disabled");
                        $("#purchase_tips").alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });

                    }
                }
            });
        }

        $("#purchase_add").click(function () {
            var materialsNum = $("#purchase_re_table tr:last td:eq(2) input").val();
            if (materialsNum == "") {
                $(this).attr("data-toggle", "");
                $("#purchase_tips").alertmsg('info', '填写内容', {
                    displayMode: 'fade',
                    alertTimeout: 1000,
                    displayPosition: 'middlecenter',
                    okCall: 'addPurchase'
                });
            } else {
                $(this).attr("data-toggle", "tableditadd");
            }
        })
        function addPurchase() {
            $(this).attr("data-toggle", "tableditadd");
        }

        function purchase_requset_delete_row() {
            if (1 < $("#purchase_re_table tbody tr").length) {
                var id = $("#purchase_re_table").find(".selected").find(".id").val();
                if (id !== undefined) {
                    purchase_del_row(id);
                } else {
                    $("#purchase_re_table").find(".selected").remove();
                }
            }

        }
    </script>
</head>
<body>
<div class="bjui-pageContent">
    <form data-toggle="validate" data-toggle="validate">
        <div style="margin:0px 0px 10px 0px;">
            <button class="btn btn-blue" data-icon="save" onclick="purchase_reset()" id="purchase_save_btn">保存</button>
            <button type="button" class="btn btn-green" data-icon="thumbs-up" id="purchase_audit_btn"
                    onclick="purchase_edit_audit()">审核
            </button>
            <button type="button" class="btn btn-orange" data-icon="thumbs-down" id="purchase_noaudit_btn"
                    onclick="purchase_giveup_audit()">弃审
            </button>
            <button type="button" class="btn btn-red" data-icon="times" onclick="purchase_detail_delete_audit()"
                    id="purchase_delete_btn">删除
            </button>
            <button class="btn-close btn" data-icon="close"><i class="fa fa-close"></i>关闭</button>
            <button class="btn btn-green" onclick="purchase_create_po()" disabled="disabled" id="purchase_create_po_bt">
                生成采购单
            </button>
        </div>

        <table class="table table-bordered table-hover table-striped table-top bjui-tabledit" width="100%"
               id="purchase_main_table">
            <input type="hidden" name="id" value="" id="id">
            <input type="hidden" name="contractid" value="" id="contractid">
            <tbody>
            <tr>
                <td>
                    <label for="podoc" class="control-label x90">单据号：</label>
                    <input type="text" id="podoc" value="" name="podoc" size="15" readonly="true">
                </td>
                <td>
                    <label for="businessdate" class="control-label x90">申请日期：</label>
                    <input type="text" id="businessdate" value="" name="businessdate" style="width: 150px"
                           readonly="true">
                </td>
                <td>
                    <label for="state" class="control-label x90">状态：</label>
                    <input type="text" id="state" value="" name="state" style="width: 150px" readonly="true">
                </td>
                <td>
                    <label for="orgname" class="control-label x90">组织：</label>
                    <input type="text" id="orgname" value="" name="orgname" style="width: 150px" readonly="true">
                </td>
            </tr>
            <tr>
                <td>
                    <label for="receiveduser" class="control-label x90">收货人：</label>
                    <input type="text" id="receiveduser" value="" name="applyInfo.receiveduser" style="width: 150px"
                           readonly="true">
                </td>
                <td><label for="receivedphone" class="control-label x90">收货人手机：</label>
                    <input type="text" id="receivedphone" value="" name="applyInfo.receivedphone" style="width: 150px"
                           readonly="true"></td>
                <td>
                    <label for="receivedaddress" class="control-label x90">收货地址：</label>
                    <input type="text" id="receivedaddress" value="" name="applyInfo.receivedaddress"
                           style="width: 150px"
                           readonly="true">
                </td>
                <td>
                    <label for="requireddate" class="control-label x90">要求交期：</label>
                    <input type="text" id="requireddate" value="" name="requireddate" data-toggle="datepicker"
                           data-rule="required" style="width: 150px">
                </td>

            </tr>
            <tr>
                <td colspan="3"><label for="details" class="control-label x90">备注：</label>
                    <textarea type="text" id="details" value="" name="details" size="15"
                              style="width:300px;height:25px;resize: none"></textarea></td>
            </tr>
            </tbody>
        </table>

        <div style="margin:50px 0 10px 0;">
            <button class="btn-default" data-toggle="tableditadd" data-target="#purchase_re_table" data-initnum="1"
                    id="purchase_add" data-num="1">新增行
            </button>
            <button class="btn-orange" data-toggle="dialog" data-mask="true" onclick="purchase_requset_delete_row()">
                删除行
            </button>
            <!--<button class="btn-blue" data-toggle="dialog" data-mask="true">查看附件</button>-->
        </div>
        <table class="table table-bordered table-hover table-striped bjui-tabledit" data-toggle="tabledit"
               data-initnum="1" data-layout-h="0" id="purchase_re_table" data-single-noindex="true">
            <thead>
            <tr>
                <th title="行号"><input type="text" name="test[#index#].linenum" class="no" readonly="true"
                                      class="linenumber" value="0"></th>
                <th title="行状态"><input type="text" name="test[#index#].linestate" readonly="true" value=""></th>
                <th title="料号"><input type="text" name="test[#index#].itemno" placeholder="必填项" data-rule="required"
                                      data-toggle="lookupbtn" class="doc_lookup form-control materialname"
                                      data-group="test[#index#]" data-title="材料选择"
                                      data-url="PurchaseManagement/purchase_materials.html"></th>
                <th title="品名"><input type="text" name="test[#index#].partname" placeholder="" readonly="true"></th>
                <th title="型号"><input type="text" name="test[#index#].partstyle" placeholder="" readonly="true"></th>
                <th title="规格"><input type="text" name="test[#index#].partspec" placeholder="" readonly="true"></th>
                <th title="颜色"><input type="text" name="test[#index#].colorlevel" placeholder=""></th>
                <th title="材质"><input type="text" name="test[#index#].material" placeholder=""></th>
                <th title="品牌"><input type="text" name="test[#index#].brand" placeholder="" readonly="true"></th>
                <th title="数量"><input type="text" name="test[#index#].prqty" placeholder="" onchange='countNmu()'
                                      value="0" data-rule='number'></th>

                <th title="单位"><input type="text" name="test[#index#].funit" placeholder="" readonly="true"></th>
                <th title="重量"><input type="text" name="test[#index#].grossweight" placeholder="" value="0" readonly="true"></th>
                <th title="重量单位"><input type="text" name="test[#index#].unitweight" placeholder="" readonly="true"></th>

                <th title="行备注"><input type="text" name="test[#index#].linedetails" placeholder=""></th>
                <th title="关联数"><input type="text" name="test[#index#].poqty" placeholder="" value="0" readonly="true">
                </th>
                <th title="来源单号"><input type="text" name="test[#index#].sourcenum" placeholder="" readonly="true"></th>
                <th title="来源行号"><input type="text" name="test[#index#].soucrelinenum" placeholder="" readonly="true">
                </th>

                <input type="hidden" name="test[#index#].itemid" placeholder="" value="">

            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
        <div id="purchase_count"></div>
    </form>
</div>
<div id="purchase_tips"></div>
</body>
</html>