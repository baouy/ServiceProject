<!DOCTYPE html>
<html lang="en">
<head>
    <style type="text/css">
        .footer td {
            padding: 0;
        }

        .footer input {
            border-radius: 0;
            border-right: none;
            border-top: none;
            border-bottom: none;
        }

    </style>
    <script type="text/javascript">
        var selected = $("#purchase_order_list").find('tr.datagrid-selected-tr');
        $.ajax({
            url: '/v1/po/findeditprocurementorders?id=' + selected[0].lastChild.innerText,
            dataType: 'json',
            type: 'GET',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function (d) {
                if (d.state == 200) {
                    if (d.data.tpoValid.state == "已审核") {
                        $("#purchase_order_giveup").removeAttr("disabled");
                        $("#purchase_order_audit").attr("disabled", "disabled");
                        $("#purchse_order_delete").attr("disabled", "disabled");
                    } else if (d.data.tpoValid.state == "新增") {
                        $("#purchase_order_giveup").attr("disabled", "disabled");
                    }
                    if (d.data.tpoValid.typedocument == "发货采购订单") {
                        $("#confirm_receipt_bt").removeAttr("disabled");
                    }
                    $("#podoc").val(d.data.tpoValid.podoc);
                    $("#businessdate").val(d.data.tpoValid.businessdate);
                    $("#state").val(d.data.tpoValid.state);
                    $("#orgname").val(d.data.tpoValid.orgname);
                    $("#suppliername").val(d.data.tpoValid.suppliername);
                    $("#requireddate").val(d.data.tpoValid.requireddate);
                    $("#salesman").val(d.data.tpoValid.createuser);
                    $("#details").val(d.data.tpoValid.details);
                    $("#supplierid").val(d.data.tpoValid.supplierid);
                    $("#receiveduser").val(d.data.tpoValid.receiveduser);
                    $("#receivedphone").val(d.data.tpoValid.receivedphone);
                    $("#receivedaddress").val(d.data.tpoValid.receivedaddress);
                    $("#contractid").val(d.data.tpoValid.contractid);
                    $("#id").val(d.data.tpoValid.id);

                    var html = "";
                    var count = 0;
                    var order_taxcostamount = 0;
                    if (d.data.tpodetailValidList.length !== 0) {
                        for (var i = 0; i < d.data.tpodetailValidList.length; i++) {
                            count += d.data.tpodetailValidList[i].qty;
                            order_taxcostamount += d.data.tpodetailValidList[i].taxcostamount;
                            html += "<tr class=readonly><td><input type=text name=test[" + i + "].linenum class='linenum form-control' style='width:30px' readonly=true  size=2 value=" + d.data.tpodetailValidList[i].linenum + "></td>" +
                                    "<td><input type=text name=test[" + i + "].linestate class=form-control readonly=true style='width:40px' value=" + d.data.tpodetailValidList[i].linestate + "></td>" +
                                    "<td><span class='wrap_bjui_btn_box' style='osition: relative; display: inline-block;'>" +
                                    "<input type=text name=test[" + i + "].itemno class='form-control itemno' data-toggle='dialog' style='width:135px' value= " + d.data.tpodetailValidList[i].itemno + " onclick=orderselectedMaterials(" + i + ")></td>" +
                                    "<td><input type=text name=test[" + i + "].partname class='form-control partname' readonly=true style='width: 270px' value=" + d.data.tpodetailValidList[i].partname + " ></td>" +
                                    "<td><input type=text name=test[" + i + "].partstyle class='form-control partstyle'  readonly=true value=" + d.data.tpodetailValidList[i].partstyle + " ></td>" +
                                    "<td><input type=text name=test[" + i + "].partspec class='form-control partspec' style='width: 90px' readonly=true value=" + d.data.tpodetailValidList[i].partspec + "></td>" +
                                    "<td><input type=text name=test[" + i + "].colorlevel class='form-control colorlevel' value=" + d.data.tpodetailValidList[i].colorlevel + "></td>" +
                                    "<td><input type=text name=test[" + i + "].material class='form-control material' value=" + d.data.tpodetailValidList[i].material + "></td>" +
                                    "<td><input type=text name=test[" + i + "].brand class='form-control brand' readonly=true value=" + d.data.tpodetailValidList[i].brand + "></td>" +
                                    "<td><input type=text name=test[" + i + "].qty class='form-control qty' data-rule='number' onchange='countPrice(this.parentNode.parentNode)' value=" + d.data.tpodetailValidList[i].qty + "></td>" +
                                    "<td><input type=text name=test[" + i + "].funit class='form-control funit' readonly=true value=" + d.data.tpodetailValidList[i].funit + "></td>" +
                                    "<td><input type=text name=test[" + i + "].ipqty class='form-control ipqty' readonly=true data-rule='number'  value=" + d.data.tpodetailValidList[i].ipqty + "></td>" +
                                    "<td><input type=text name=test[" + i + "].kunit class='form-control kunit' readonly=true value=" + d.data.tpodetailValidList[i].kunit + "></td>" +
                                    "<td><input type=text name=test[" + i + "].grossweight class='form-control grossweight' readonly=true value=" + d.data.tpodetailValidList[i].grossweight + "></td>" +
                                    "<td><input type=text name=test[" + i + "].unitweight class='form-control unitweight' readonly=true value=" + d.data.tpodetailValidList[i].unitweight + "></td>" +
                                    "<td><input type=text name=test[" + i + "].taxunitprice class='taxunitprice form-control' readonly=true class=taxunitprice value=" + d.data.tpodetailValidList[i].taxunitprice + "></td>" +
                                    "<td><input type=text name=test[" + i + "].taxcostamount readonly=true class='taxcostamount form-control' value=" + d.data.tpodetailValidList[i].taxcostamount + "></td>" +
                                    "<td><input type=text name=test[" + i + "].taxamount readonly=true class='form-control taxamount' value=" + d.data.tpodetailValidList[i].taxamount + "></td>" +
                                    "<td><input type=text name=test[" + i + "].taxrate readonly=true class='form-control taxrate' value=" + d.data.tpodetailValidList[i].taxrate + "></td>" +
                                    "<td><input type=text name=test[" + i + "].notaxunitprice readonly=true class='form-control notaxunitprice' value=" + d.data.tpodetailValidList[i].notaxunitprice + " ></td>" +
                                    "<td><input type=text name=test[" + i + "].notaxcostamount readonly=true class='form-control notaxcostamount' value=" + d.data.tpodetailValidList[i].notaxcostamount + "></td>" +
                                    "<td><input type=text name=test[" + i + "].linedetails class='form-control linedetails' value=" + d.data.tpodetailValidList[i].linedetails + "></td>" +
                                    "<td><input type=text name=test[" + i + "].recqty readonly=true  class='form-control' value=" + d.data.tpodetailValidList[i].recqty + "></td>" +
                                    "<td><input type=text name=test[" + i + "].totalinqty  class='form-control' readonly=true class=totalinqty value=" + d.data.tpodetailValidList[i].totalinqty + "></td>" +
                                    "<td><input type=text name=test[" + i + "].sourcenum  readonly=true class='form-control sourcenum' value=" + d.data.tpodetailValidList[i].sourcenum + "></td>" +
                                    "<td><input type=text name=test[" + i + "].soucrelinenum   readonly=true class='form-control soucrelinenum' value=" + d.data.tpodetailValidList[i].soucrelinenum + "></td>" +
                                    "<td><input type=text name=test[" + i + "].applydeliverynum   readonly=true class='form-control applydeliverynum' value=" + d.data.tpodetailValidList[i].applydeliverynum + "></td>" +
                                    "<td><input type=text name=test[" + i + "].applydeliverylinenum   readonly=true class='form-control applydeliverylinenum' value=" + d.data.tpodetailValidList[i].applydeliverylinenum + "></td>" +
                                    "<td><input type=text name=test[" + i + "].receivedqty   readonly=true class='form-control receivedqty' value=" + d.data.tpodetailValidList[i].receivedqty + "></td>" +
                                    "<input type=hidden name=test[" + i + "].itemid class='form-control itemid'  value=" + d.data.tpodetailValidList[i].itemid + ">" +
                                    "<input type=hidden name=test[" + i + "].id class='form-control id'  value=" + d.data.tpodetailValidList[i].id + ">" +
                                    "</tr>";
                        }
                        $("#purchase_order_table tbody").html(html);

                        $("#purchase_order_table tbody").after("<tr class='footer'>" +
                                "<td>合计</td>" +
                                "<td><input type='text' class='form-control' value style='width: 44px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 135px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value=" + count + " style='width: 50px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 50px'></td>" +
                                "<td><input type='text' class='form-control' value style='width: 50px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 50px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 50px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 50px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 50px'></td>" +
                                "<td><input type='text' class='form-control' value=" + order_taxcostamount + " style='width: 90px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<td><input type='text' class='form-control' value  style='width: 45px'></td>" +
                                "<input type='text' class='form-control' value style='display: none'>" +
                                "</tr>");
                    }
                    $("#purchase_order_table tbody tr").click(function () {
                        $(this).removeClass("readonly")
                                .addClass("selected").siblings("tr").removeClass("selected")
                                .addClass("readonly");
                    })
                } else {
                    BJUI.alertmsg('error', d.content, {
                        displayMode: 'fade',
                        alertTimeout: 1000,
                        displayPosition: 'middlecenter'
                    });
                }
            }
        });
        /**
         * 删除列表中的数据
         * **/
        var deleteRowId;
        function purchase_del_row(id) {
            deleteRowId = id;
            if (1 < $("#purchase_order_table tbody tr").length) {
                $(this).alertmsg('confirm', '确定要删除该行信息吗',
                        {
                            displayMode: 'slide',
                            displayPosition: 'middlecenter',
                            cancelName: '关闭',
                            okName: '确认',
                            title: '删除',
                            okCall: 'purchaseDelete'
                        });
            }
        }

        function purchaseDelete() {
            $.ajax({
                url: '/v1/po/deleteprocurementordersdetail',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: deleteRowId
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#purchase_order_table tr input[value='" + deleteRowId + "']").parents("tr").remove();
                        $('#purchase_order_list').datagrid("refresh");
                        for (var i = 0; i < $("#purchase_order_table tbody tr").length; i++) {
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(0)").attr("name", "test[" + i + "].linenum");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(1)").attr("name", "test[" + i + "].linestate");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(2)").attr("name", "test[" + i + "].itemno");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(2)").attr("data-group", "test[" + i + "]");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(2)").siblings("span").attr("data-group", "test[" + i + "]");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(2)").siblings("span").attr("for", "test[" + i + "].itemno");

                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(3)").attr("name", "test[" + i + "].partname");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(4)").attr("name", "test[" + i + "].partstyle");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(5)").attr("name", "test[" + i + "].partspec");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(6)").attr("name", "test[" + i + "].colorlevel");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(7)").attr("name", "test[" + i + "].material");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(8)").attr("name", "test[" + i + "].brand");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(9)").attr("name", "test[" + i + "].qty");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(10)").attr("name", "test[" + i + "].funit");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(11)").attr("name", "test[" + i + "].ipqty");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(12)").attr("name", "test[" + i + "].kunit");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(13)").attr("name", "test[" + i + "].grossweight");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(14)").attr("name", "test[" + i + "].unitweight");


                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(15)").attr("name", "test[" + i + "].taxunitprice");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(16)").attr("name", "test[" + i + "].taxcostamount");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(17)").attr("name", "test[" + i + "].taxamount");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(18)").attr("name", "test[" + i + "].taxrate");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(19)").attr("name", "test[" + i + "].notaxunitprice");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(20)").attr("name", "test[" + i + "].notaxcostamount");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(21)").attr("name", "test[" + i + "].linedetails");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(22)").attr("name", "test[" + i + "].recqty");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(23)").attr("name", "test[" + i + "].totalinqty");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(24)").attr("name", "test[" + i + "].sourcenum");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(25)").attr("name", "test[" + i + "].soucrelinenum");

                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(26)").attr("name", "test[" + i + "].applydeliverynum");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(27)").attr("name", "test[" + i + "].applydeliverylinenum");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(28)").attr("name", "test[" + i + "].receivedqty");


                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(29)").attr("name", "test[" + i + "].itemid");
                            $("#purchase_order_table tbody tr:eq(" + i + ") input:eq(30)").attr("name", "test[" + i + "].id");
                        }
                    } else {
                        BJUI.alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }

        /**
         * 选中原材料
         * **/
        function orderselectedMaterials(id) {
            localStorage.setItem("purchase_selected_material", id);
            $(this).dialog({
                id: "purchaseorder",
                title: "料品选择",
                url: "PurchaseManagement/purchase_materials.html",
                height: 400,
                mask: true
            });
        }
        ;


        function countPrice(theRow) {
            var number = $(theRow).find(".qty").val();
            var index = $(theRow).index();
            $("#purchase_order_table tbody tr:eq(" + index + ")");
            var taxrate = $("#purchase_order_table tbody tr:eq(" + index + ") td .taxrate").val();//税率

            var procost = $("#purchase_order_table tbody tr:eq(" + index + ") td .taxunitprice").val();//含税采购单价
            var taxcostamount = number * procost;
            $("#purchase_order_table tbody tr:eq(" + index + ") td .taxcostamount").val(taxcostamount);//采购金额

            var notaxunitprice = procost / (1 + taxrate / 100);
            $("#purchase_order_table tbody tr:eq(" + index + ") td .notaxunitprice").val(notaxunitprice);//不含税采购单价


            var notaxcostamount = notaxunitprice * number;//不含税采购金额
            $("#purchase_order_table tbody tr:eq(" + index + ") td .notaxcostamount").val(notaxcostamount);//不含税采购单价

            var taxamount = taxcostamount - notaxcostamount;
            $("#purchase_order_table tbody tr:eq(" + index + ") td .taxamount").val(taxamount);//税额


            var sum = 0;
            var sunPrice = 0;
            for (var i = 0; i < $("#purchase_order_table tbody tr").length; i++) {
                console.log($("#purchase_order_table tbody tr:eq(" + i + ") td:eq(9) input").val())
                sum += parseInt($("#purchase_order_table tbody tr:eq(" + i + ") td:eq(9) input").val());
                sunPrice += parseInt($("#purchase_order_table tbody tr:eq(" + i + ") td:eq(16) input").val());
                $("#purchase_order_table .footer td:eq(9) input").val(sum);
                $("#purchase_order_table .footer td:eq(16) input").val(sunPrice);
            }
        }

        function purchase_order_reset() {
            var materialsNum = $("#purchase_order_table tbody tr:last td:eq(2) input").val();
            if ($("#requireddate").val() !== "" && materialsNum !== "") {
//            $("#purchase_order_table tbody tr").addClass("readonly");
                var tpodetailValidList = [];
                var obj = new Object();
                var tpoValid = new Object();
                var selectedId = $("#purchase_main_table input[name='id']").val();

                tpoValid = {
                    requireddate: $("#requireddate").val(),
                    details: $("#details").val(),
                    podoc: $("#podoc").val(),
                    businessdate: $("#businessdate").val(),
                    state: $("#state").val(),
                    requireddate: $("#requireddate").val(),
                    details: $("#details").val(),
                    contractid: $("#contractid").val(),
                    supplierid: $("#supplierid").val(),
                    id: selectedId
                }
                var purchasetable = $("#purchase_order_table tbody tr");
                for (var i = 0; i < purchasetable.length; i++) {
                    obj = {
//                    linenum:$("input[name='test["+i+"].linenum']").val(),
                        linestate: $("input[name='test[" + i + "].linestate']").val(),
                        itemno: $("input[name='test[" + i + "].itemno']").val(),
                        partname: $("input[name='test[" + i + "].partname']").val(),
                        partstyle: $("input[name='test[" + i + "].partstyle']").val(),
                        partspec: $("input[name='test[" + i + "].partspec']").val(),
                        colorlevel: $("input[name='test[" + i + "].colorlevel']").val(),
                        material: $("input[name='test[" + i + "].material']").val(),
                        brand: $("input[name='test[" + i + "].brand']").val(),
                        prqty: $("input[name='test[" + i + "].prqty']").val(),
                        funit: $("input[name='test[" + i + "].funit']").val(),
                        grossweight: $("input[name='test[" + i + "].grossweight']").val(),
                        unitweight: $("input[name='test[" + i + "].unitweight']").val(),
                        linedetails: $("input[name='test[" + i + "].linedetails']").val(),
                        qty: $("input[name='test[" + i + "].qty']").val(),
                        taxunitprice: $("input[name='test[" + i + "].taxunitprice']").val(),
                        taxcostamount: $("input[name='test[" + i + "].taxcostamount']").val(),
                        taxamount: $("input[name='test[" + i + "].taxamount']").val(),
                        taxrate: $("input[name='test[" + i + "].taxrate']").val(),
                        notaxunitprice: $("input[name='test[" + i + "].notaxunitprice']").val(),
                        taxcostamount: $("input[name='test[" + i + "].taxcostamount']").val(),
                        notaxcostamount: $("input[name='test[" + i + "].notaxcostamount']").val(),
                        recqty: $("input[name='test[" + i + "].recqty']").val(),
                        totalinqty: $("input[name='test[" + i + "].totalinqty']").val(),
                        sourcenum: $("input[name='test[" + i + "].sourcenum']").val(),
                        soucrelinenum: $("input[name='test[" + i + "].soucrelinenum']").val(),
                        applydeliverynum: $("input[name='test[" + i + "].applydeliverynum']").val(),
                        applydeliverylinenum: $("input[name='test[" + i + "].applydeliverylinenum']").val(),
                        receivedqty: $("input[name='test[" + i + "].receivedqty']").val(),
                        itemid: $("input[name='test[" + i + "].itemid']").val(),
                        id: $("input[name='test[" + i + "].id']").val()
                    };
                    tpodetailValidList.push(obj);
                }
                objOb = {
                    tpodetailValidList,
                    tpoValid
                };
                $.ajax({
                    url: '/v1/po/resetprocurementorders',
                    contentType: 'application/json',
                    dataType: 'json',
                    type: 'POST',
                    data: JSON.stringify(objOb),
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (d) {
                        if (d.state == 200) {
                            $("#purchase_order_table tbody tr").addClass("readonly");
                            $('#purchase_order_list').datagrid("refresh");
                            BJUI.dialog("closeCurrent", this);
                            BJUI.alertmsg('info', d.content, {
                                displayMode: 'fade',
                                alertTimeout: 1000,
                                displayPosition: 'middlecenter'
                            });
                        } else {
                            BJUI.alertmsg('error', d.content, {
                                displayMode: 'fade',
                                alertTimeout: 1000,
                                displayPosition: 'middlecenter'
                            });
                        }
                    }
                });
            } else {
                $("#purchase_tips").alertmsg('info', '填写内容', {
                    displayMode: 'fade',
                    alertTimeout: 1000,
                    displayPosition: 'middlecenter'
                });
            }
        }
        function purchase_edit_order_audit() {
            $("#purchase_order_audit").attr("disabled", "disabled");
            var id = $("#purchase_main_table input[name='id']").val();
            $.ajax({
                url: '/v1/po/reviewedprocurementorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: id
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#purchase_order_save").attr("disabled", "disabled");
                        $("#purchse_order_delete").attr("disabled", "disabled");
                        $("#purchase_order_audit").attr("disabled", "disabled");
                        $("#purchase_order_giveup").removeAttr("disabled");
                        $('#purchase_order_list').datagrid("refresh");
                        $("#state").val("已审核");

                        for (var i = 0; i < $("#purchase_order_table tbody tr").length; i++) {
                            $("#purchase_order_table tbody tr:eq(" + i + ") td:eq(1) input").val("已审核");
                        }
                    } else {
                        $("#purchase_order_audit").removeAttr("disabled");

                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }
        function purchase_edit_order_giveup() {

            $("#purchase_order_giveup").attr("disabled", "disabled");
            var id = $("#purchase_main_table input[name='id']").val();
            $.ajax({
                url: '/v1/po/giveupreviewedprocurementorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: id
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#purchase_order_save").removeAttr("disabled");
                        $("#purchse_order_delete").removeAttr("disabled");
                        $("#purchase_order_audit").removeAttr("disabled");
                        $("#purchase_order_giveup").attr("disabled", "disabled");
                        $('#purchase_order_list').datagrid("refresh");
                        $("#state").val("新增");

                        for (var i = 0; i < $("#purchase_order_table tbody tr").length; i++) {
                            $("#purchase_order_table tbody tr:eq(" + i + ") td:eq(1) input").val("新增");
                        }
                    } else {
                        $("#purchase_order_giveup").removeAttr("disabled");

                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }
        function purchase_edit_order_del() {
            if ($("#purchase_main_table input[name='id']").val() !== "") {
                BJUI.alertmsg('confirm', '确定要删除吗?', {
                    displayMode: 'fade',
                    displayPosition: 'middlecenter',
                    okName: "是",
                    cancelName: "否",
                    okCall: 'deletepurchaserow'
                });
            }
        }

        function deletepurchaserow() {
            var selected = $("#purchase_main_table input[name='id']").val();
            $.ajax({
                url: '/v1/po/deleteprocurementorders',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: selected
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        BJUI.dialog("closeCurrent", this);
                        $('#purchase_order_list').datagrid("refresh");
                    } else {
                        BJUI.alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }
        ;


        /**
         * 删除新增的行,没有保存到数据库中的
         * **/
        function purchase_del_new_row(theRow) {
            deleteRowId = $(theRow).index() + 1;
            if (1 < $("#purchase_order_table tbody tr").length) {
                $(this).alertmsg('confirm', '确定要删除该行信息吗',
                        {
                            displayMode: 'slide',
                            displayPosition: 'middlecenter',
                            cancelName: '关闭',
                            okName: '确认',
                            title: '删除',
                            okCall: 'purchase_del_new'
                        });
            } else {
                $(this).alertmsg('confirm', '不能删除',
                        {
                            displayMode: 'slide',
                            displayPosition: 'middlecenter',
                            cancelName: '关闭',
                            okName: '确认',
                            title: '删除',
                        });
            }

        }
        //确认删除
        function purchase_del_new() {
            $("#purchase_order_table tr:eq(" + deleteRowId + ")").remove();
        }

        function purchase_order_delete_row() {
            if (1 < $("#purchase_order_table tbody tr").length) {
                var id = $("#purchase_order_table").find(".selected").find(".id").val();
                if (id !== undefined) {
                    purchase_del_row(id);
                } else {
                    $("#purchase_order_table").find(".selected").remove();
                }
            }
        }
        $("#purchase_order_table").on('bjui.initUI', function () {
            $("#purchase_order_table tbody tr").click(function () {
                $(this).removeClass("readonly")
                        .addClass("selected").siblings("tr").removeClass("selected")
                        .addClass("readonly");
            })
        })

        function confirm_receipt() {
            var id = $("#id").val();
            var tpodetailValidList = [];
            var obj = new Object();
            var tpoValid = new Object();
            tpoValid = {
                id: id,
            }
            var purchasetable = $("#purchase_order_table tbody tr");
            for (var i = 0; i < purchasetable.length; i++) {
                obj = {
                    receivedqty: $("input[name='test[" + i + "].ipqty']").val(),
                    id: $("input[name='test[" + i + "].id']").val()
                };
                tpodetailValidList.push(obj);
            }
            objOb = {
                tpodetailValidList,
                tpoValid
            };

            $.ajax({
                url: '/v1/po/confirmreceipt',
                contentType: 'application/json',
                dataType: 'json',
                type: 'POST',
                data: JSON.stringify(objOb),
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        BJUI.alertmsg('info', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                        $("#confirm_receipt_bt").attr("disabled", "disabled");
                        $('#purchase_order_list').datagrid("refresh");
                        BJUI.dialog("closeCurrent", this);
                    } else {
                        $("#purchase_tips").alertmsg('error', d.content, {
                            displayMode: 'fade',
                            alertTimeout: 1000,
                            displayPosition: 'middlecenter'
                        });
                    }
                }
            });
        }
    </script>
</head>
<body>
<div class="bjui-pageContent">
    <form data-toggle="validate" data-toggle="validate">
        <div style="margin:0px 0px 10px 0px;">
            <button class="btn btn-blue" data-icon="save" id="purchase_order_save" onclick="purchase_order_reset()">保存
            </button>
            <button type="button" class="btn btn-green" data-icon="thumbs-up" id="purchase_order_audit"
                    onclick="purchase_edit_order_audit()">审核
            </button>
            <button type="button" class="btn btn-orange" data-icon="thumbs-down" id="purchase_order_giveup"
                    onclick="purchase_edit_order_giveup()">弃审
            </button>
            <button type="button" class="btn btn-red" data-icon="times" id="purchse_order_delete"
                    onclick="purchase_edit_order_del()">删除
            </button>
            <button class="btn-close btn" data-icon="close"><i class="fa fa-close"></i>关闭</button>
            <button class="btn btn-green" onclick="confirm_receipt()" disabled="disabled" id="confirm_receipt_bt">确认收货
            </button>

        </div>

        <table class="table table-bordered table-hover table-striped table-top bjui-tabledit" width="100%"
               id="purchase_main_table">
            <input type="hidden" name="id" value="" id="id">
            <input type="hidden" name="supplierid" value="" id="supplierid">
            <input type="hidden" name="contractid" value="" id="contractid">
            <tbody>
            <tr>
                <td>
                    <label for="podoc" class="control-label x90">单据号：</label>
                    <input type="text" id="podoc" value="" name="podoc" size="15" readonly="true">
                </td>
                <td>
                    <label for="businessdate" class="control-label x90">申请日期：</label>
                    <input type="text" id="businessdate" value="" name="businessdate" data-toggle="datepicker"
                           style="width: 150px" readonly="true">
                </td>
                <td>
                    <label for="state" class="control-label x90">状态：</label>
                    <input type="text" id="state" value="" name="state" style="width: 150px" readonly="true">
                </td>
                <td>
                    <label for="orgname" class="control-label x90">组织：</label>
                    <input type="text" id="orgname" value="" name="orgname" style="width: 150px" readonly="true">
                </td>
            </tr>
            <tr>
                <td>
                    <label class="control-label x90" for="suppliername">供应商：</label>
                    <input type="text" id="suppliername" value="" name="suppliername" style="width: 150px"
                           readonly="true">
                </td>
                <td>
                    <label for="requireddate" class="control-label x90">要求交期：</label>
                    <input type="text" id="requireddate" value="" name="requireddate" data-toggle="datepicker"
                           style="width: 150px">
                </td>
                <td>
                    <label for="salesman" class="control-label x90">业务员：</label>
                    <input type="text" id="salesman" value="" name="salesman" style="width: 150px" readonly="true">
                </td>
                <td></td>
            </tr>
            <tr>

                <td>
                    <label for="receiveduser" class="control-label x90">收货人：</label>
                    <input type="text" id="receiveduser" value="" name="applyInfo.receiveduser" style="width: 150px"
                           readonly="true">
                </td>
                <td><label for="receivedphone" class="control-label x90">收货人手机：</label>
                    <input type="text" id="receivedphone" value="" name="applyInfo.receivedphone" style="width: 150px"
                           readonly="true"></td>
                <td>
                    <label for="receivedaddress" class="control-label x90">收货地址：</label>
                    <input type="text" id="receivedaddress" value="" name="applyInfo.receivedaddress"
                           style="width: 150px"
                           readonly="true">
                </td>
            </tr>
            <tr>
                <td colspan="4"><label for="details" class="control-label x90">备注：</label>
                    <textarea type="text" id="details" value="" name="details" size="15"
                              style="width:300px;height:25px;resize: none"></textarea></td>
            </tr>
            </tbody>
        </table>

        <div style="margin:50px 0 10px 0;">
            <button class="btn-default" data-toggle="tableditadd" data-target="#purchase_order_table" data-initnum="1"
                    id="purchase_order_add" data-num="1">新增行
            </button>
            <button class="btn-orange" data-toggle="dialog" data-mask="true" onclick="purchase_order_delete_row()">删除行
            </button>
        </div>
        <div id="tableContanier">
            <table class="table table-bordered table-hover bjui-tabledit" data-toggle="tabledit" data-initnum="1"
                   data-layout-h="0" id="purchase_order_table" data-single-noindex="true">
                <thead>
                <tr>
                    <th title="行号"><input type="text" name="test[#index#].linenum" class="no" readonly="true"
                                          class="linenum" value="0"></th>
                    <th title="行状态"><input type="text" name="test[#index#].linestate" readonly="true" value=""
                                           class="linestate"></th>
                    <th title="料号"><input type="text" name="test[#index#].itemno" style="width:90px"
                                          data-rule="required" placeholder="必填项" data-toggle="lookupbtn"
                                          class="doc_lookup form-control materialname itemno" data-group="test[#index#]"
                                          data-url="PurchaseManagement/purchase_materials.html"></th>
                    <th title="品名"><input type="text" name="test[#index#].partname" placeholder="" readonly="true"
                                          class="partname"></th>
                    <th title="型号"><input type="text" name="test[#index#].partstyle" placeholder="" readonly="true"
                                          class="partstyle"></th>
                    <th title="规格"><input type="text" name="test[#index#].partspec" placeholder="" readonly="true"
                                          class="partspec"></th>
                    <th title="颜色"><input type="text" name="test[#index#].colorlevel" placeholder="" class="colorlevel">
                    </th>
                    <th title="材质"><input type="text" name="test[#index#].material" placeholder="" class="material">
                    </th>
                    <th title="品牌"><input type="text" name="test[#index#].brand" placeholder="" readonly="true"
                                          class="brand"></th>
                    <th title="采购数量"><input type="text" name="test[#index#].qty" placeholder=""
                                            onchange='countPrice(this.parentNode.parentNode)' value="0"
                                            data-rule='number'
                                            class="qty"></th>
                    <th title="采购单位"><input type="text" name="test[#index#].funit" placeholder="" readonly="true"
                                            class="funit"></th>
                    <th title="采购库存数"><input type="text" name="test[#index#].ipqty" placeholder=""
                                             value="0" data-rule='number'
                                             class="ipqty"></th>
                    <th title="库存单位"><input type="text" name="test[#index#].kunit" placeholder="" readonly="true"
                                            class="kunit"></th>

                    <th title="毛重"><input type="text" name="test[#index#].grossweight" placeholder="" readonly="true"
                                            class="grossweight"></th>
                    <th title="重量单位"><input type="text" name="test[#index#].unitweight" placeholder="" readonly="true"
                                            class="unitweight"></th>
                    <th title=采购单价 class=purchase_order_param><input type=text name=test[#index#].taxunitprice
                                                                     placeholder readonly=true class="taxunitprice"
                                                                     value="0"></th>
                    <th title=采购金额 class=purchase_order_param><input type=text name=test[#index#].taxcostamount
                                                                     placeholder readonly=true class="taxcostamount"
                                                                     value="0"></th>

                    <th title=税额 class=purchase_order_param><input type=text name=test[#index#].taxamount placeholder
                                                                   readonly=true class="taxamount"></th>
                    <th title=税率 class=purchase_order_param><input type=text name=test[#index#].taxrate placeholder
                                                                   readonly=true class="taxrate"></th>

                    <th title="不含税采购单价" class=purchase_order_param><input type=text value="0"
                                                                          name=test[#index#].notaxunitprice placeholder
                                                                          readonly=true class="notaxunitprice"></th>
                    <th title="不含税采购金额" class=purchase_order_param><input type=text value="0"
                                                                          name=test[#index#].notaxcostamount placeholder
                                                                          readonly=true class="notaxcostamount"></th>

                    <th title="行备注"><input type="text" name="test[#index#].linedetails" placeholder=""
                                           class="linedetails"></th>
                    <th title="关联数"><input type="text" name="test[#index#].recqty" placeholder="" class="recqty"
                                           value="0.0000" readonly="true"></th>

                    <th title=入库数 class=purchase_order_param><input type=text name=test[#index#].totalinqty placeholder
                                                                    value=0.0000 readonly=true class="totalinqty"></th>
                    <th title=来源单号 class=purchase_order_param><input type=text name=test[#index#].sourcenum placeholder
                                                                     value readonly=true class="sourcenum"></th>
                    <th title=来源行号 class=purchase_order_param><input type=text name=test[#index#].soucrelinenum
                                                                     placeholder value readonly=true
                                                                     class="soucrelinenum"></th>
                    <th title=发货申请单号 class=purchase_order_param><input type=text name=test[#index#].applydeliverynum
                                                                       placeholder value readonly=true
                                                                       class="applydeliverynum"></th>
                    <th title=发货申请行号 class=purchase_order_param><input type=text name=test[#index#].applydeliverylinenum
                                                                       placeholder value readonly=true
                                                                       class="applydeliverylinenum"></th>
                    <th title=收货数量 class=purchase_order_param><input type=text name=test[#index#].receivedqty
                                                                     placeholder value readonly=true
                                                                     class="receivedqty"></th>
                    <input type="hidden" name="test[#index#].itemid" style="display: none" placeholder="" value="">
                    <!--<button class="btn btn-green" onclick="purchase_save_row(this.parentNode.parentNode)">保存</button>-->
                    <!--<a class="btn btn-red" onclick="purchase_del_new_row(this.parentNode.parentNode)">删</a>-->

                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>

            <div id="purchase_order_count"></div>
        </div>
    </form>
</div>
</body>
</html>