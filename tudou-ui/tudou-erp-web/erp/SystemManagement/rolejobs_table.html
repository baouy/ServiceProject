<html>

<head>
    <script type="text/javascript">


        function setJobsRight() {
            var datas = $("#jobs2_datagrid").data('selectedDatas');
            if (datas == null || datas == undefined || datas.length == 0) {
                $(this).alertmsg('error', '请选择岗位。');
            } else if (datas.length > 1) {
                $(this).alertmsg('error', '只能选择一个岗位。');
            } else {
                var id = datas[0].id;
                var jobsName = datas[0].jobsName;
                var roleDatas = $("#role_datagrid").data('selectedDatas');
                var roleid = null;
                var roleName = null;
                if (roleDatas != null && roleDatas != undefined && roleDatas.length > 1) {
                    $(this).alertmsg('error', '只能选择一个角色。');
                } else {
                    if (roleDatas != null && roleDatas != undefined && roleDatas.length == 1) {
                        roleid = roleDatas[0].id;
                        roleName = roleDatas[0].roleName;
                    }
                    $.ajax({
                        url: '/v1/roleright/set_right',
                        dataType: 'json',
                        type: 'POST',
                        data: {
                            'id': id,
                            'jobsName': jobsName,
                            'roleid': roleid,
                            'roleName': roleName
                        },
                        xhrFields: {
                            withCredentials: true
                        },
                        crossDomain: true,
                        success: function (d) {
                            if (d.state == 200) {
                                $('#role_datagrid').datagrid('refresh');
                                $('#jobs2_datagrid').datagrid('refresh');
                                $(this).alertmsg('ok', '操作成功');

                            }
                        }
                    });
                }
            }

        }

        $('#jobs2_datagrid').datagrid({
            local: 'remote',
            dataUrl: '/v1/roleright/tjobs_list',
            dataType: 'json',
            sortAll: false,
            loadType: 'get',
            filterAll: true,
            height: '95%',
            columns: [
                {name: 'orgidfk', width: '10', label: '组织ID', hide: true},
                {name: 'roleidfk', width: '10', label: '角色ID', hide: true},
                {name: 'jobsName', width: '150', label: '岗位名称'},
                {name: 'description', width: '320', label: '岗位描述'},
                {name: 'genTime', width: '180', label: '创建时间'},
                {name: 'id', width: '80', label: '主键', hide: true}],
            paging: false,
            columnMenu: true,
            columnShowhide: true,
            columnFilter: true,
            filterThead: false,
            columnLock: false,
            fullGrid: false,
            isdisableClick: true,
            clickRow: function () {
                var datas = $("#jobs2_datagrid").data('selectedDatas');
                if (datas.length <= 0) return;
                $('#role_datagrid').datagrid('selectedRows', null, true)
                var rights = datas[0].roleidfk;
                if (rights == null || rights == undefined) return;
                else {
                    $("#role_datagrid").find('tr').each(function () {
                        var _this = this;
                        var roleidfk = $(_this).find('td:eq(4)').find('div').html();
                        if (rights == roleidfk) {
                            $('#role_datagrid').datagrid('selectedRows', parseInt($(_this).find('td:eq(0)').find('div').html()) - 1, true)
                        }
                    });
                }
            }
        });
        $('#role_datagrid').datagrid({
            local: 'remote',
            dataUrl: '/v1/roleright/roles_list',
            dataType: 'json',
            sortAll: false,
            loadType: 'get',
            filterAll: true,
            height: '95%',
            columns: [
                {name: 'roleName', width: '150', label: '角色名'},
                {name: 'dataaccess', width: '150', label: '角色权限'},
                {name: 'id', width: '80', label: '主键', hide: true}],
            paging: false,
            columnMenu: true,
            columnShowhide: true,
            columnFilter: true,
            filterThead: false,
            columnLock: false,
            showCheckboxcol: true,
            fullGrid: false
        });

        function jobsRefresh() {
            $("#jobs2_datagrid").datagrid('refresh');
        }
        function roleRefresh() {
            $("#role_datagrid").datagrid('refresh');
        }
    </script>
</head>

<body>
<div class="bjui-pageContent">
    <div class="roleLeft" style="width: 55% !important;position: relative;height: 95%;float: left;">
        <div style="margin:0px 0px 10px 0px;">
            <button class="btn btn-green" onclick="jobsRefresh();">刷新</button>
        </div>
        <table id="jobs2_datagrid" class="table table-hover" data-width="100%" disabled="true"></table>
    </div>
    <div class="roleRight" style="width: 45% !important;position: relative;height: 95%;float: left;">
        <div style="margin:0px 0px 10px 0px;">
            <button type="button" class="btn btn-orange" data-icon="undo" onclick="setJobsRight()"><i
                    class="fa fa-gg"></i>
                关联岗位角色
            </button>
            <button class="btn btn-green" onclick="roleRefresh();">刷新</button>
        </div>
        <table id="role_datagrid" class="table table-hover" data-width="100%"></table>
    </div>
</div>
</body>

</html>