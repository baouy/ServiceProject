<script type="text/javascript">

	var roleid = $.cookie("roleid");

	if (roleid != 6){
		$('#excel_post').remove();
	}


	$('#personnel_datagrid').datagrid({

		height:'95%',
		dataUrl: '/v1/personnel/list',
		dataType: 'json',
		loadType: 'get',
		sortAll: false,
		filterAll: true,
		height:'95%',
		columns: [
			{name: 'worknum', width: '90', label: '工号'},
			{name: 'username', width: '80', label: '姓名'},
			{name: 'flower_name', width: '90', label: '花名'},
			{name: 'login_name', width: '120', label: '手机号'},
//			{name: 'isconfirm', type: 'select', items: [{'true': '有效'}, {'false': '无效'}], width: '80', label: '是否确认'},
			{name: 'orgname', width: '120', label: '组织'},
			{name: 'depName', width: '120', label: '部门'},
			{name: 'jobsName', width: '120', label: '岗位'},
			{name: 'mobile', width: '120', label: '手机号'},
			{name: 'gender', width: '80', label: '性别'},
			{name: 'companyphone', width: '120', label: '公司电话'},
			{name: 'companyemail', width: '100', label: '公司邮箱'},
			{name: 'id_number', width: '150', label: '身份证号码'},
			{name: 'address', width: '150', label: '身份证地址'},
//			{name: 'householdcode', width: '70', label: '户籍编码'},
//			{name: 'householdname', width: '70', label: '户籍类型'},
//			{name: 'birthday', width: '100', label: '生日'},
//			{name: 'star', width: '100', label: '星座'},
//			{name: 'entry_date', width: '150', label: '入职日期'},
			{name: 'isactive', type: 'select', items: [{'true': '在职'}, {'false': '离职'}], width: '80', label: '人员状态'},
//			{name: 'positivedate', width: '120', label: '转正时间'},
//			{name: 'contractenddate', width: '120', label: '合同结束时间'},
//			{name: 'cardnumber', width: '150', label: '工资卡号'},
//			{name: 'bank', width: '100', label: '开户行'},
			{name: 'email', width: '100', label: '个人邮箱'},
//			{name: 'education', width: '100', label: '最高学历'},
//			{name: 'school', width: '100', label: '毕业院校'},
//			{name: 'professional', width: '100', label: '专业'},
//			{name: 'emer_contact', width: '100', label: '紧急联系人'},
//			{name: 'emer_phone', width: '100', label: '联系电话'},
//			{name: 'movematters', width: '100', label: '异动事宜'},
//			{name: 'movetime', width: '100', label: '异动日期'},
//			{name: 'leavingreason', width: '100', label: '离职原因'},
			{name: 'id', width: '80', label: '主键', hide: true}],
		paging: {pageSize: 50, selectPageSize: '50,100,200', pageCurrent: 1},
		columnMenu: true,
		columnShowhide: true,
		columnFilter: true,
		columnLock: false,
		fullGrid: false,
		dblOnClick: 'checkDialog',
	});

	function checkDialog() {
		var selected = $("#personnel_datagrid").find('tr.datagrid-selected-tr');
		if (selected.length == 0) {
			$(this).alertmsg('error', '请在列表中选择要操作的对象。');
		} else if (selected.length > 1) {
			$(this).alertmsg('error', '请选择唯一的操作对象。');
		} else {
			if (selected[0].lastChild.innerText > 0) {
				$(this).dialog({
					id: 'personnel_hr_edit',
					url: 'SystemManagement/personnel_hr_edit.html',
					title: 'HR确认',
					width: '1150',
					height: '735',
					mask: true
				});
			}
		}
	}

	function hr_leave() {
		var selected = $("#personnel_datagrid").find('tr.datagrid-selected-tr');
		if (selected.length == 0) {
			$(this).alertmsg('error', '请在列表中选择要操作的对象。');
		} else if (selected.length > 1) {
			$(this).alertmsg('error', '请选择唯一的操作对象。');
		} else {
			if (selected[0].lastChild.innerText > 0) {
				$(this).dialog({
					id: 'personnel_hr_edit',
					url: 'SystemManagement/personnel_hr_leave.html',
					title: 'HR确认',
					width: '1150',
					height: '335',
					mask: true
				});
			}
		}
	}

	function personnel_employees_edit() {
		$(this).dialog({
			id: 'personnel_employees_edit',
			url: 'SystemManagement/personnel_employees_edit.html',
			title: '员工录入',
			width: '1200',
			height: '400',
			mask: true
		});
	}

	function personnel_hr_surealert() {
		var resetKeys = personnel_getselectedKey();
		if (resetKeys.length == 0) {
			return;
		}
		$(this).alertmsg('confirm', '确定确认吗?', {okCall: 'personnel_hr_sure'});
	}

	function personnel_hr_sure() {
		var resetKeys = personnel_getselectedKey();
		if (resetKeys.length > 0) {
			$.ajax({
				url: '/v1/personnel/hr_sure?ids=' + resetKeys,
				dataType: 'json',
				type: 'POST',
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function (d) {
					if (d.state == 200) {
						$(this).alertmsg('ok', '操作成功');
						$('#personnel_datagrid').datagrid('refresh');
					}
				}
			});
		}
		else {
			$(this).alertmsg('error', '请选择要操作的对象。')
		}
	}


	function personnel_getselectedKey() {
		var selected = $("#personnel_datagrid").find('tr.datagrid-selected-tr');
		var selectedKey = "";
		selected.each(function (index, item) {
			selectedKey += item.lastChild.innerText + ",";
		});
		selectedKey = selectedKey.substring(0, selectedKey.length - 1);
		return selectedKey;
	}

	function show_delete_alert() {
		var resetKeys = personnel_getselectedKey();
		if (resetKeys.length == 0) {
			return;
		}
		$(this).alertmsg('confirm', '确定删除吗?', {okCall: 'personnel_deleteItesm'});
	}

	function show_resetpw_alert() {
		var resetKeys = personnel_getselectedKey();
		if (resetKeys.length == 0) {
			return;
		}
		$(this).alertmsg('confirm', '确定重置密码吗?', {okCall: 'personnel_resetPW'});
	}

	function personnel_resetPW() {
		var resetKeys = personnel_getselectedKey();
		if (resetKeys.length > 0) {
			$.ajax({
				url: '/v1/personnel/reset_password?ids=' + resetKeys,
				dataType: 'json',
				type: 'POST',
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function (d) {
					if (d.state == 200) {
						$(this).alertmsg('ok', '操作成功');
						$('#personnel_datagrid').datagrid('refresh');
					}
				}
			});
		}
		else {
			$("body").alertmsg('error', '请选择要操作的对象。')
		}
	}

	function personnel_deleteItesm() {
		deleteKeys = personnel_getselectedKey();
		if (deleteKeys.length > 0) {
			$.ajax({
				url: '/v1/personnel/delete_personnel?ids=' + deleteKeys,
				dataType: 'json',
				type: 'POST',
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function (d) {
					if (d.state == 200) {
						$(this).alertmsg('ok', '操作成功');
						$('#personnel_datagrid').datagrid('refresh');
					}
				}
			});
		}
		else {
			$(this).alertmsg('error', '请选择要操作的对象。')
		}
	}

	function importExcel_personnel() {
		if (!checkData_personnel()) {
			$("#upfile_personnel").val("");
			return;
		}
		$.ajax({
			url: '/v1/personnel/personnel_excel_post',
			type: 'POST',
			cache: false,
			data: new FormData($('#form1_personnel')[0]),
			processData: false,
			contentType: false
		}).done(function (res) {
			if (res.state == 200) {
				$(this).alertmsg('ok', '导入成功');
				$('#personnel_datagrid').datagrid('refresh');
			} else {
				var content = '';
				for (var i = 0; i < res.data.length; i++) {
					content += res.data[i] + "<br>";
				}

				$(this).alertmsg('info', content, {autoClose: false, title: '导入错误'});
			}
			$("#upfile_personnel").val("");
		}).fail(function (res) {
			$("#upfile_personnel").val("");
			$(this).alertmsg('error', '导入失败,请重新导入');
		});
	}

	function checkData_personnel() {
		var fileDir = $("#upfile_personnel").val();
		if (fileDir.length == 0) {
			return false;
		}
		var suffix = fileDir.substr(fileDir.lastIndexOf("."));
		if ("" == fileDir) {
			$(this).alertmsg('info', '选择EXCEL格式的文件导入');
			return false;
		}
		if (".xls" != suffix && ".xlsx" != suffix) {
//				alert("选择Excel格式的文件导入！");
			$(this).alertmsg('info', '选择EXCEL格式的文件导入');
			return false;
		}
		return true;
	}

	function hr_download() {

//		var worknum = $("input[name='worknum']").val();
//		var login_name = $("input[name='login_name']").val();
//		var isconfirm = $("select[name='isconfirm']").val();
		var isactive = $("select[name='isactive']").val();
//		var flower_name = $("input[name='flower_name']").val();
//		var username = $("input[name='username']").val();
//		var gender = $("input[name='gender']").val();
//		var indepname = $("input[name='indepname']").val();
//		var injobsname = $("input[name='injobsname']").val();
//		var mobile = $("input[name='mobile']").val();
//		var companyphone = $("input[name='companyphone']").val();
//		var id_number = $("input[name='id_number']").val();
//		var address = $("input[name='address']").val();
//		var householdcode = $("input[name='householdcode']").val();
//		var householdname = $("input[name='householdname']").val();
//		var birthday = $("input[name='birthday']").val();
//		var star = $("input[name='star']").val();
//		var entry_date = $("input[name='entry_date']").val();
//		var positivedate = $("input[name='positivedate']").val();
//		var contractenddate = $("input[name='contractenddate']").val();
//		var cardnumber = $("input[name='cardnumber']").val();
//		var bank = $("input[name='bank']").val();
//		var email = $("input[name='email']").val();
//		var companyemail = $("input[name='companyemail']").val();
//		var education = $("input[name='education']").val();
//		var school = $("input[name='school']").val();
//		var professional = $("input[name='professional']").val();
//		var emer_contact = $("input[name='emer_contact']").val();
//		var emer_phone = $("input[name='emer_phone']").val();

		var url = "/v1/personnel/personnel_hr_excel?pageCurrent=1&pageSize=10000";

//		if (worknum.length > 0) {
//			url += "&worknum=" + worknum;
//		}
//		if (login_name.length > 0) {
//			url += "&login_name=" + login_name;
//		}
//		if (isconfirm.length > 0) {
//			url += "&isconfirm=" + isconfirm;
//		}
		if (isactive.length > 0) {
			url += "&isactive=" + isactive;
		}
//		if (flower_name.length > 0) {
//			url += "&flower_name=" + flower_name;
//		}
//		if (username.length > 0) {
//			url += "&username=" + username;
//		}
//		if (gender.length > 0) {
//			url += "&gender=" + gender;
//		}
//		if (indepname.length > 0) {
//			url += "&indepname=" + indepname;
//		}
//		if (injobsname.length > 0) {
//			url += "&injobsname=" + injobsname;
//		}
//		if (mobile.length > 0) {
//			url += "&mobile=" + mobile;
//		}
//		if (companyphone.length > 0) {
//			url += "&companyphone=" + companyphone;
//		}
//		if (id_number.length > 0) {
//			url += "&id_number=" + id_number;
//		}
//		if (address.length > 0) {
//			url += "&address=" + address;
//		}
//		if (householdcode.length > 0) {
//			url += "&householdcode=" + householdcode;
//		}
//		if (birthday.length > 0) {
//			url += "&birthday=" + birthday;
//		}
//		if (star.length > 0) {
//			url += "&star=" + star;
//		}
//		if (entry_date.length > 0) {
//			url += "&entry_date=" + entry_date;
//		}
//		if (positivedate.length > 0) {
//			url += "&positivedate=" + positivedate;
//		}
//		if (contractenddate.length > 0) {
//			url += "&contractenddate=" + contractenddate;
//		}
//		if (cardnumber.length > 0) {
//			url += "&cardnumber=" + cardnumber;
//		}
//		if (bank.length > 0) {
//			url += "&bank=" + bank;
//		}
//		if (email.length > 0) {
//			url += "&email=" + email;
//		}
//		if (companyemail.length > 0) {
//			url += "&companyemail=" + companyemail;
//		}
//		if (education.length > 0) {
//			url += "&education=" + education;
//		}
//		if (school.length > 0) {
//			url += "&school=" + school;
//		}
//		if (professional.length > 0) {
//			url += "&professional=" + professional;
//		}
//		if (emer_contact.length > 0) {
//			url += "&emer_contact=" + emer_contact;
//		}
//		if (emer_phone.length > 0) {
//			url += "&emer_phone=" + emer_phone;
//		}
		window.open(url);
	}

</script>
<div class="bjui-pageContent">
	<div style="margin:0px 0px 10px 0px;">
		<button type="button" data-url="SystemManagement/personnel_hr_new.html" class="btn btn-blue" data-icon="plus"
				data-width="1150" data-height="735" data-toggle="dialog" data-mask="true"><i class="fa fa-plus"></i> 添加
		</button>

		<!--<button type="button" class="btn btn-red" data-icon="times" onclick="show_delete_alert()"><i
				class="fa fa-times"></i> 删除
		</button>-->

		<button type="button" class="btn btn-orange" data-icon="undo" onclick="show_resetpw_alert()"><i
				class="fa fa-undo"></i> 重置密码
		</button>

		<!--<form id="form1_personnel" action="/v1/personnel/personnel_excel_post" method="post"
			  enctype="multipart/form-data" class="fa">
			<input type="file" name="file" id="upfile_personnel" style="visibility: hidden; position: absolute;"
				   onchange="importExcel_personnel()">
			<button type="button" class="btn btn-blue" data-icon="sign-in" onclick="upfile_personnel.click()"><i
					class="fa fa-sign-in"></i>导入
			</button>
		</form>-->

		<!--<button type="button" id="personnel_edit_0" class="btn btn-green" data-icon="edit"
				onclick="personnel_employees_edit()"><i class="fa fa-edit"></i> 员工录入
		</button>-->

		<!--<button type="button" id="personnel_edit_1" class="btn btn-green" data-icon="edit"-->
				<!--onclick="personnel_hr_surealert()"><i class="fa fa-edit"></i> HR确认-->
		<!--</button>-->
		<button id="excel_post" type="button" class="btn btn-green" data-icon="sign-out" onclick="hr_download()"><i
				class="fa fa-sign-out"></i> 导出
		</button>
		<button type="button" class="btn btn-green" data-icon="sign-out" onclick="hr_leave()"><i
				class="fa fa-sign-out"></i>员工离职
		</button>
	</div>
	<table id="personnel_datagrid" class="table table-bordered" data-width="100%"></table>
</div>