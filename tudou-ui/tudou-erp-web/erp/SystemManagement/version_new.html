<script type="text/javascript">
    var uploader = Qiniu.uploader({
        runtimes: 'html5,flash,html4',
        browse_button: 'pickfiles',
        container: 'container',
        drop_element: 'container',
        max_file_size: '1000mb',
        flash_swf_url: 'bower_components/plupload/js/Moxie.swf',
        dragdrop: true,
        chunk_size: '4mb',
        multi_selection: false,//!(mOxie.Env.OS.toLowerCase()==="ios"),
        uptoken_url:'/v1/other/get_qiniu_token',
        // uptoken: d.data,
        domain: "http://image.meiwo.cn/",
        get_new_uptoken: false,
        auto_start: true,
        log_level: 3,
        init: {
            'FilesAdded': function(up, files) {
                //$('table').show();
                $('#success').hide();
                plupload.each(files, function(file) {
                    showProgress();
                    $.ajax({
                        url: '/v1/other/deleteFile',//+file.name,
                        data:{'filename':file.name},
                        dataType:'json',
                        type: 'POST',
                        xhrFields: {
                            withCredentials: true
                        },
                        crossDomain: true,
                        success: function(d){
                            var progress = new FileProgress(file, 'fsUploadProgress');
                            progress.setStatus("等待...");
                            progress.bindUploadCancel(up);
                        }
                    });
                });
            },
            'BeforeUpload': function(up, file) {
                var progress = new FileProgress(file, 'fsUploadProgress');
                var chunk_size = plupload.parseSize(this.getOption('chunk_size'));
                if (up.runtime === 'html5' && chunk_size) {
                    progress.setChunkProgess(chunk_size);
                }
            },
            'UploadProgress': function(up, file) {
                var progress = new FileProgress(file, 'fsUploadProgress');
                var chunk_size = plupload.parseSize(this.getOption('chunk_size'));
                progress.setProgress(file.percent + "%", file.speed, chunk_size);
                $("#progress_bar").css("width",file.percent + "%");
                $("#progress_bar").text(file.percent + "%");
            },
            'UploadComplete': function() {
                //$('#success').show();
            },
            'FileUploaded': function(up, file, info) {
                BJUI.dialog("close", "progress_dialog");
                var progress = new FileProgress(file, 'fsUploadProgress');
                progress.setComplete(up, info);
                $("#version_address").val(up.settings.domain+$.parseJSON(info).key);
                console.log(up.settings.domain+$.parseJSON(info).key);
            },
            'Error': function(up, err, errTip) {
                $('table').show();
                var progress = new FileProgress(err.file, 'fsUploadProgress');
                progress.setError();
                progress.setStatus(errTip);
            }
        }
    });
    function showProgress() {
         $(this).dialog({
            id: 'progress_dialog',
            target: $("#prgress_content"),
            title: '文件上传中……',
            width: '400',
            height: '100',
            mask: true
        });
    }
    function wtf(json){
        if(json.state==200){
            BJUI.dialog('closeCurrent',this);
            $('#version_datagrid').datagrid('refresh');
        }
    }

    function changePlatform(){
        $("#version_platform").val($("#version_platformid option:selected").text());
        var id = $("#version_platformid option:selected").val();
        if(id=="97" || id=="98" || id=="99"){
            $("#container").hide();
            switch (id){
                case "97":
                    $("#version_address").val("http://fir.im/Meiwo");
                    break;
                case "98":
                    $("#version_address").val("http://fir.im/Meiwo");
                    break;
                case "99":
                    $("#version_address").val("192.168.20.189:8080");
                    break;
            }

        }
    }
</script>
<div class="bjui-pageContent">
    <form action="/v1/version/add_version" data-toggle="validate" data-callback="wtf">
        <table class="table table-condensed table-hover" width="100%">
            <tbody>
                <tr>
                    <td>
                        <label for="version_appname" class="control-label x90">APP名称：</label>
                        <input type="text" id="version_appname" value="" data-rule="required" name="appname" size="15" >
                    </td>
                    <td>
                        <label for="version_code" class="control-label x90">版本号：</label>
                        <input type="text" id="version_code" value="" data-rule="required" name="code" size="15" >
                    </td>

                </tr>
                <tr>
                    <td>
                        <label for="version_must" class="control-label x90">是否必须：</label>
                        <select name="must" id="version_must" data-toggle="selectpicker" >
                            <option value="1" selected="true">是</option>
                            <option value="0">否</option>
                        </select>
                    </td>
                    <td>
                        <label for="version_isnew" class="control-label x90">是否最新：</label>
                        <select name="isnew" id="version_isnew" data-toggle="selectpicker" >
                            <option value="1" selected="true">是</option>
                            <option value="0">否</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="version_platformid" class="control-label x90">所属平台：</label>
                        <select name="platformid" id="version_platformid" data-toggle="selectpicker" onchange="changePlatform()">
                            <option value="95" selected="true">安卓B端</option>
                            <option value="96">安卓C端</option>
                            <option value="97">IOSB端</option>
                            <option value="98">IOSC端</option>
                            <option value="99">ERP</option>
                        </select>
                        <input type="hidden" id="version_platform" value="安卓B端" data-rule="required" name="platform" size="15">
                    </td>
                    <td>
                        <label for="version_address" class="control-label x90">升级地址：</label>
                        <input type="text" id="version_address" value="" data-rule="required" name="address" size="15" readonly="readonly">
                        <div class="main" style="width: auto;display:inline-block">
                            <div class="body">
                                <div id="container">
                                    <a class="btn btn-default btn-sm " id="pickfiles" href="#" >
                                        <i class="glyphicon glyphicon-plus"></i>
                                        <sapn>选择文件</sapn>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <label for="version_updateinfor" class="control-label x90">更新日志：</label>
                        <textarea name="updateinfor" id="version_updateinfor" data-toggle="autoheight" cols="50" rows="3"></textarea>
                    </td>
                </tr>
            </tbody>
        </table>
    </form>
</div>
<div class="bjui-pageFooter">
    <ul>
        <li><button type="button" class="btn-close" data-icon="close">取消</button></li>
        <li><button type="submit" class="btn-default" data-icon="save">保存</button></li>
    </ul>
</div>

<div id="prgress_content" style="display:none;">
    <div style="height: 20px;line-height:20px;text-align:center;background: green;margin-top: 25px;" id="progress_bar"></div>
</div>