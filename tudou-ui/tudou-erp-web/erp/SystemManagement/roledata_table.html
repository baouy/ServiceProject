<html>

<head>
    <script type="text/javascript">
        $('#roledata_datagrid').datagrid({
            local: 'remote',
            dataUrl: '/v1/roledata/rolelist',
            dataType: 'json',
            sortAll: false,
            loadType: 'get',
            filterAll: true,
            height: '95%',
            columns: [
                {
                    name: 'rights', width: '300', label: '权限', hide: true, render: function (value) {
                    var arr = [];
                    for (var i = 0; i < value.length; i++) {
                        arr.push(value[i].rightid);
                    }
                    return arr;
                }
                },
                {name: 'roleName', width: '120', label: '角色名'},
                {name: 'dataaccess', width: '150', label: '角色权限'},
                //{name:'multorgname', width:'200', label:'多组织'},
                {name: 'genTime', width: '200', label: '创建时间'},
                {name: 'isdel', type: 'select', items: [{'true': '是'}, {'false': '否'}], width: '80', label: '是否删除'},
                {name: 'description', width: '300', label: '角色描述'},
                {name: 'id', width: '80', label: '主键', hide: true}],
            paging: {pageSize: 20, selectPageSize: '50,100,200', pageCurrent: 1},
            columnMenu: true,
            columnShowhide: true,
            columnFilter: true,
            columnLock: false,
            fullGrid: false,
            clickRow: function () {
                var treeObj = $.fn.zTree.getZTreeObj("menu-ztree");
                treeObj.checkAllNodes(false);
                var treeObj2 = $.fn.zTree.getZTreeObj("menu-erp-ztree");
                treeObj2.checkAllNodes(false);

                var datas = $("#roledata_datagrid").data('selectedDatas');
                if (datas.length <= 0) return;
                var rights = datas[0].rights;
                if (rights == null || rights.length <= 0) return;
                else {
                    for (var i = 0; i < rights.length; i++) {
                        var nodes = treeObj.getNodesByParam("id", rights[i].rightid, null);
                        var checked = false;
                        if (nodes != null && nodes.length > 0) {
                            checked = nodes[0].checked;
                            if (checked) {
                                treeObj.checkNode(nodes[0], false, false);
                            } else {
                                treeObj.checkNode(nodes[0], true, false);
                            }
                        }


                        var nodes2 = treeObj2.getNodesByParam("id", rights[i].rightid, null);
                        var checked2 = false;
                        if (nodes2 != null && nodes2.length > 0) {
                            checked2 = nodes2[0].checked;
                            if (checked2) {
                                treeObj2.checkNode(nodes2[0], false, false);
                            } else {
                                treeObj2.checkNode(nodes2[0], true, false);
                            }
                        }


                    }
                }
            }
        });


        var formItems = ["id", "roleName", "genTime", "description", "dataaccess", "dataaccessid", "isdel"];

        function setRight() {
            var datas = $("#roledata_datagrid").data('selectedDatas');
            if (datas == null || datas == undefined || datas.length == 0) {
                $(this).alertmsg('error', '请在列表中选择要操作的对象。');
            } else if (datas.length > 1) {
                $(this).alertmsg('error', '请选择唯一的操作对象。');
            } else {
                var id = datas[0].id;
                var treeObj = $.fn.zTree.getZTreeObj("menu-ztree");
                var nodes = treeObj.getCheckedNodes(true);

                var treeObj2 = $.fn.zTree.getZTreeObj("menu-erp-ztree");
                var nodes2 = treeObj2.getCheckedNodes(true);


                var arr = [];
                for (var i = 0; i < nodes.length; i++) {
                    arr.push(nodes[i].id);
                }
                for (var i = 0; i < nodes2.length; i++) {
                    arr.push(nodes2[i].id);
                }
                $.ajax({
                    url: '/v1/roledata/set_right',
                    dataType: 'json',
                    type: 'POST',
                    data: {'id': id, 'rights': arr.toString()},
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (d) {
                        if (d.state == 200) {
                            $(this).alertmsg('ok', '操作成功');
                            $('#roledata_datagrid').datagrid('refresh');
                            var treeObj = $.fn.zTree.getZTreeObj("menu-ztree");
                            treeObj.checkAllNodes(false);
                            var treeObj2 = $.fn.zTree.getZTreeObj("menu-erp-ztree");
                            treeObj2.checkAllNodes(false);
                        }
                    }
                });
            }

        }

        function changeDataAccess() {
            $("#roledata_dataaccess").val($("#roledata_dataaccessid option:selected").text());
        }

        var datas_id;
        function editRoleDialog() {
            var selected = $("#roledata_datagrid").find('tr.datagrid-selected-tr');
            var datas = $("#roledata_datagrid").data('selectedDatas');
            if (!datas) {
                $(this).alertmsg('error', '请在列表中选择要操作的对象。');
            } else if (datas.length > 1) {
                $(this).alertmsg('error', '请选择唯一的操作对象。');
            } else {
                datas_id = datas[0].id
                $(this).dialog({
                    id: 'roledata_edit',
                    url: 'SystemManagement/roledata_edit.html',
                    title: '编辑',
                    width: '700',
                    height: '300',
                    mask: true
                });
            }
        }

        function show_delete_alert() {
            var datas = $("#roledata_datagrid").data('selectedDatas');
            if (datas.length == 0) {
                $(this).alertmsg('error', '请在列表中选择要操作的对象。');
            } else {
                $(this).alertmsg('confirm', '确定删除吗?', {okCall: 'personnel_deleteItesm'});
            }

        }

        function personnel_deleteItesm() {
            var datas = $("#roledata_datagrid").data('selectedDatas');
            var arr = [];
            for (var i = 0; i < datas.length; i++) {
                arr.push(datas[i].id);
            }
            $(this).alertmsg('confirm', '确定删除吗?', {
                okCall: $.ajax({
                    url: '/v1/roledata/delete_role?ids=' + arr.toString(),
                    dataType: 'json',
                    type: 'POST',
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (d) {
                        if (d.state == 200) {
                            $(this).alertmsg('ok', '操作成功');
                            $('#roledata_datagrid').datagrid('refresh');
                            var treeObj = $.fn.zTree.getZTreeObj("menu-ztree");
                            treeObj.checkAllNodes(false);
                        }
                    }
                })
            });
        }

        function refreshMenu(a) {
            var treeObj = $.fn.zTree.getZTreeObj("menu-erp-ztree");
            if (a == 1) {
                treeObj = $.fn.zTree.getZTreeObj("menu-ztree");
            }
            treeObj.refresh();
        }


    </script>
</head>

<body>

<div class="bjui-pageContent">
    <div class="roleLeft"  style="width: 55% !important;position: relative;height: 97%;float: left;">
        <div style="margin:0px 0px 10px 0px;">
            <button type="button" data-url="SystemManagement/roledata_new.html" class="btn btn-blue" data-icon="plus"
                    data-width="700" data-height="300" data-toggle="dialog" data-mask="true"><i class="fa fa-plus"></i>
                添加
            </button>

            <button type="button" class="btn btn-green" data-icon="edit" onclick="editRoleDialog()"><i
                    class="fa fa-edit"></i> 编辑
            </button>

            <button type="button" class="btn btn-red" data-icon="times" onclick="show_delete_alert()"><i
                    class="fa fa-times"></i> 删除
            </button>
        </div>
        <table id="roledata_datagrid" class="table table-hover" data-width="100%"></table>
    </div>
    <div style="width: 45% !important;height: 97%;float: left;">
        <div style="width: 100% !important;margin:0px 0px 10px 0px;">
            <!--<div style="float: left">-->
                <button type="button" class="btn btn-green" data-icon="times" onclick="refreshMenu(1)"><i
                        class="fa fa-refresh"></i> 刷新
                </button>
                <button type="button" class="btn btn-orange" data-icon="undo" onclick="setRight(1)"><i
                        class="fa fa-gg"></i>
                    赋权
                </button>
            <!--</div>-->

            <!--<div style="float: right;">-->
                <button type="button" class="btn btn-green" data-icon="times" onclick="refreshMenu(2)"style="float: right"><i
                        class="fa fa-refresh"></i> 刷新
                </button>
                <button type="button" class="btn btn-orange" data-icon="undo" onclick="setRight(2)" style="float: right"><i
                        class="fa fa-gg"></i>
                    赋权
                </button>
            <!--</div>-->
        </div>

        <div style="width: 100% !important;height: 95%;float: left;">
            <div class="roleRight"
                 style="width: 43% !important;height: 97%;float:left;border: 1px solid #c0c0c0;overflow: auto;">
                <ul id="menu-ztree" class="ztree" data-on-click="test" data-on-check="test" data-radio-type="all"
                    data-chk-style="checkbox" data-check-enable="true"
                    data-expand-all="true" data-toggle="ztree"
                    data-setting="{
                            async:
                            {
                                enable: true,
                                url:'/v1/roledata/menulist',
                                autoParam: ['id','parentid'],
                                contentType: 'application/json',
                                dataType: 'json',
                                type:'get'
                            },view: {
                                selectedMulti: false
                            }
                         }"></ul>
            </div>

            <div class="roleRight"
                 style="width: 57% !important;height: 97%;float: right;border: 1px solid #c0c0c0;overflow: auto;">
                <ul id="menu-erp-ztree" class="ztree" data-on-click="test" data-on-check="test" data-radio-type="all"
                    data-chk-style="checkbox" data-check-enable="true"
                    data-expand-all="true" data-toggle="ztree"
                    data-setting="{
                            async:
                            {
                                enable: true,
                                url:'/v1/roledata/menulist2',
                                autoParam: ['id','parentid'],
                                contentType: 'application/json',
                                dataType: 'json',
                                type:'get'
                            },view: {
                                selectedMulti: false
                            }
                         }"></ul>
            </div>
        </div>
    </div>
</div>


</body>

</html>