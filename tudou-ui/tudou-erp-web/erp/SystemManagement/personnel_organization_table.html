<div id="tsalespackage_layout" style="width: 100%; height: 100%;">
	<script type="text/javascript">
		var p_id,p_pid;

		init();

		function init() {
			var $t = $('#menu-p-ztree');
			$t.data('addHoverDom', "edit").data('removeHoverDom', "edit").data('onRemove','onRemove');
		}


		function savePMenu() {

			if (p_pid === undefined && p_id === undefined){
				return;
			}

			var name = $('#persionnel_org_name').val();

			//新增
			if (p_pid === undefined){
				persionnel_add(p_id,name);
			}
			//编辑
			else{
				persionnel_reset(p_id,name);
			}
		}

		function S_NodeCheck(e, treeId, treeNode) {
			var id = treeNode.id;
			var npId = treeNode.pId;
			var code = treeNode.code;
			var name = treeNode.name;
			if (id === undefined){
				p_id = treeNode.pId;
				p_pid = undefined;
				$('#persionnel_org_name').val('');
				$('#jobs_datagrid').datagrid('reload',{ dataUrl: '/v1/roleright/tjobs_list?orgidfk='+0})
			}else{
				p_id = id;
				p_pid = npId;
				$('#persionnel_org_name').val(name);
				$('#jobs_datagrid').datagrid('reload',{ dataUrl: '/v1/roleright/tjobs_list?orgidfk='+id})
			}


			//$('#jobs_datagrid').datagrid('selectedRows', null, false);//取消已经选中行
			/*var datas = $("#jobs_datagrid").data('selectedDatas');
			if(datas!=null && datas.length>0){
				for(var i =0;i<datas.length;i++){
					$('#jobs_datagrid').datagrid('selectedRows', datas[i].gridIndex, false)
				}
			}*/

			/*$("#jobs_datagrid").find('tr').each(function(){
				var _this = this;
				var orgid = $(_this).find('td:eq(2)').find('div').html();
				if(id==orgid){
					$('#jobs_datagrid').datagrid('selectedRows', parseInt($(_this).find('td:eq(0)').find('div').html())-1, true)
				}
			});*/

		}

		function persionnel_add(id,orgName) {
			$.ajax({
				url: '/v1/personnel/organization_add',
				dataType: 'json',
				type: 'POST',
				data:{
					parentToId:id,
					orgName:orgName,
				},
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function (d) {
					if(d.state == 200) {
						var zTree  = $.fn.zTree.getZTreeObj("menu-p-ztree")
						var upNode = zTree.getSelectedNodes()[0];
						upNode.id = d.data
						upNode.tid = id
						upNode.pId = id
						upNode.name   = orgName
						zTree.updateNode(upNode)

						p_id = undefined;
						p_pid = undefined;

						$('#persionnel_org_name').val('');

					}else{
						$(this).alertmsg('warn', '添加失败!');
					}
				}
			});
		}


		function persionnel_reset(id,orgName) {

			$.ajax({
				url: '/v1/personnel/organization_reset',
				dataType: 'json',
				type: 'POST',
				data:{
					id:id,
					orgName:orgName,
				},
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function (d) {
					if(d.state ==200) {

						var zTree  = $.fn.zTree.getZTreeObj("menu-p-ztree")
						var upNode = zTree.getSelectedNodes()[0];
						upNode.name   = orgName
						zTree.updateNode(upNode)

						p_id = undefined;
						p_pid = undefined;
						$('#persionnel_org_name').val('');

					}else{
						$(this).alertmsg('warn', '更新失败!');
					}
				}
			});
		}
		
		function PRefresh() {
			$(this).bjuiajax('doLoad', {url:'SystemManagement/personnel_organization_table.html', target:'#tsalespackage_layout',loadingmask:true});
		}

		function getjobdatagrid(id) {
			id = id== undefined || null ? 0 : id;
			$('#jobs_datagrid').datagrid({
				local: 'remote',
				dataUrl: '/v1/roleright/tjobs_list?orgidfk='+id,
				dataType: 'json',
				sortAll: false,
				loadType: 'get',
				filterAll: true,
				height:'95%',
				columns: [
					{name:'orgidfk', width:'10', label:'组织ID',hide:true},
					{name:'jobsName', width:'150', label:'岗位名称'},
					{name:'description', width:'320', label:'岗位描述'},
					{name:'genTime', width:'180', label:'创建时间'},
					{name:'id', width:'80', label:'主键', hide:true}],
				paging: {pageSize:1000, selectPageSize:'1000', pageCurrent:1},
				columnMenu: true,
				columnShowhide: true,
				columnFilter: true,
				filterThead:false,
				columnLock: false,
				fullGrid: false,
				showCheckboxcol:true,
			});
		}

		getjobdatagrid();
		function jobs_new() {
			var treeObj = $.fn.zTree.getZTreeObj("menu-p-ztree");
			var nodes = treeObj.getSelectedNodes();

			if(nodes!=null && nodes.length==1){
				$(this).dialog({
					id: 'personnel_employees_edit',
					url: 'SystemManagement/jobs_new.html',
					title: '员工录入',
					width: '700',
					height: '230',
					mask: true
				});
			}else{
				$(this).alertmsg('warn', '请选择一个组织！');
			}

		}

		function saveJobs(){
			var treeObj = $.fn.zTree.getZTreeObj("menu-p-ztree");
			var nodes = treeObj.getSelectedNodes();
			var orgIdFk = nodes[0].id;
			var jobsName = $("#roleright_jobsName").val();
			var description =$("#roleright_description").val();
			$.ajax({
				url:'/v1/roleright/add_jobs',
				type:'post',
				data:'orgIdFk='+orgIdFk+'&jobsName='+jobsName+'&description='+description,
				success:function (data) {
					if (data.state == 200) {
						BJUI.dialog('closeCurrent', this);
						$('#jobs_datagrid').datagrid('refresh');
					}
				}
			});
		}
		function editJobsDialog(){
			var datas = $("#jobs_datagrid").data('selectedDatas');
			if(!datas){
				$(this).alertmsg('error', '请在列表中选择要操作的对象。');
			}else if(datas.length > 1){
				$(this).alertmsg('error', '请选择唯一的操作对象。');
			}else{
				$(this).dialog({
					id: 'rolejobs_edit',
					url: 'SystemManagement/jobs_edit.html',
					title: '编辑',
					width: '700',
					height: '240',
					mask: true
				});
				$.ajax({
					url: '/v1/roleright/get_jobs?ids='+datas[0].id,
					dataType: 'json',
					type: 'GET',
					xhrFields: {
						withCredentials: true
					},
					crossDomain: true,
					success: function(d){
						$.CurrentDialog.find("#roleright_jobsName").val(d.data.jobsName);
						$.CurrentDialog.find("#roleright_id").val(d.data.id);
						$.CurrentDialog.find("#roleright_description").val(d.data.description);
					}
				});
			}
		}

		function show_deleteJobs_alert() {
			var datas = $("#jobs_datagrid").data('selectedDatas');
			if(datas== null || datas == undefined || datas.length == 0){
				$(this).alertmsg('error', '请在列表中选择要操作的对象。');
			}else{
				$(this).alertmsg('confirm', '确定删除吗?', {okCall:'jobs_deleteItesm'});
			}

		}

		function jobs_deleteItesm(){
			var datas = $("#jobs_datagrid").data('selectedDatas');
			var arr = [];
			for(var i = 0; i <datas.length;i++){
				arr.push(datas[i].id);
			}
			$(this).alertmsg('confirm', '确定删除吗?', {okCall:
					$.ajax({
						url: '/v1/roleright/delete_jobs',
						dataType: 'json',
						type: 'POST',
						data:'ids='+arr.toString(),
						xhrFields: {
							withCredentials: true
						},
						crossDomain: true,
						success: function(d){
							if(d.state == 200){
								$(this).alertmsg('ok', '操作成功');
								$('#jobs_datagrid').datagrid('refresh');
							}
						}
					})
			});
		}
	</script>
<div class="bjui-pageContent">
	<div class="roleLeft" style="width: 360px !important;position: relative;height: 800px;float: left;">

		<div style="margin:0px 0px 10px 0px;">
			<input type="text" class="form-control" name="org_name" id="persionnel_org_name" size="15" style="width: 150px;">
			<button class="btn btn-green" onclick="savePMenu();">保存</button>
			<button class="btn btn-green" onclick="PRefresh();">刷新</button>
		</div>
		<div style="border: 0px solid red;height: 760px;width: 360px;overflow: auto">
			<ul id="menu-p-ztree" class="ztree"
				data-on-click="S_NodeCheck"
				data-radio-type="all"
				data-expand-all="true"
				data-toggle="ztree"
				data-options="{maxAddLevel:7}"
				data-setting="{
                            async:
                            {
                                enable: true,
                                url:'/v1/personnel/organization_list',
                                autoParam: ['id','pId'],
                                contentType: 'application/json',
                                dataType: 'json',
                                type:'get'
                            },view: {
                                selectedMulti: false
                            }
                         }">
			</ul>
		</div>

	</div>

	<div class="jobs_div" style="width: 45% !important;position: relative;height: 800px;float: left;margin: 0px 10px;">
			<div style="margin:0px 0px 10px 0px;">
				<button type="button" class="btn btn-blue" data-icon="plus" onclick="jobs_new()"><i class="fa fa-plus"></i> 添加</button>
				<button type="button" class="btn btn-green" data-icon="edit" onclick="editJobsDialog()"><i class="fa fa-edit"></i> 编辑</button>
				<button type="button" class="btn btn-red" data-icon="times" onclick="show_deleteJobs_alert()"><i class="fa fa-times"></i> 删除</button>
			</div>
			<table id="jobs_datagrid" class="table table-hover" data-width="100%" disabled="true"> </table>
	</div>
</div>
</div>