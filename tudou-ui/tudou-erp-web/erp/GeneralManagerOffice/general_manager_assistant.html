<script>

	var assinstant_edit_type = 0;
	$('#general_manager_assistant').datagrid({
		local: 'remote',
		dataUrl: '/v1/newcustomer/assistant_customerlist', // ?custsalesid=1 1表示不为空，0表示为空
		dataType: 'json',
		sortAll: false,
		loadType: 'get',
		filterAll: true,
		height:'95%',
		columns:
				[
				    {name: 'nextfellowtime', width: '150', label: '下次沟通时间',type:'date',pattern:'yyyy-MM-dd'},
					{name: 'completion', width: '60', label: '完成度'},
					{name: 'intentiontype', width: '95', label: '意向度',type:'select',items: [{'意向客户': '意向客户'}, {'非意向': '非意向'},{'非意向(无人接听/关机)': '非意向(无人接听/关机)'},{'非意向(随便注册)': '非意向(随便注册)'},{'非意向(直接挂断)': '非意向(直接挂断)'},{'非意向(本市非服务范围内)': '非意向(本市非服务范围内)'},{'非意向(外地)': '非意向(外地)'},{'非意向(不足70㎡)': '非意向(不足70㎡)'},{'非意向(房子已装修好)': '非意向(房子已装修好)'},{'非意向(房子太旧)': '非意向(房子太旧)'},{'非意向(大于180㎡)': '非意向(大于180㎡)'},{'非意向(户型不符)': '非意向(户型不符)'},{'非意向(其他)': '非意向(其他)'}]},
					{name: 'cusname', width: '70', label: '姓名'},
					{name: 'mobile', width: '90', label: '电话'},
					{name: 'village', width: '100', label: '小区名称'},
					{name: 'roommodel', width: '70', label: '毛坯平层',type:'select',items: [{'毛坯平层': '毛坯平层'}, {'旧房平层': '旧房平层'}, {'复式毛坯': '复式毛坯'}, {'跃层毛坯': '跃层毛坯'}, {'排屋毛坯': '排屋毛坯'}, {'别墅毛坯': '别墅毛坯'}, {'其他': '其他'}, {'0':'未填写'}]},
					{name: 'newbudget', width: '70', label: '预算',type:'select',items: [{'7万以下': '7万以下'}, {'7万': '7万'}, {'8万': '8万'}, {'9万': '9万'}, {'10万': '10万'}, {'11万': '11万'}, {'12万': '12万'}, {'13万': '13万'}, {'14万': '14万'}, {'15万': '15万'}, {'15万以上': '15万以上'}, {'0':'未填写'}]},
                    {name: 'area', width: '70', label: '面积',type:'select',items: [{'1': '70㎡以下'}, {'2': '70㎡-80㎡'}, {'3':'80㎡-90㎡'},{'4': '90㎡-100㎡'}, {'5': '100㎡-110㎡'}, {'6':'110㎡-120㎡'}, {'7':'120㎡以上'},{'0':'未填写'}]},
					{name: 'roomstatus', width: '70', label: '交房状态',type:'select',items: [{'现房': '现房'}, {'期房': '期房'}, {'0':'未填写'}]},
					{name: 'followdate', width: '100', label: '最后一次跟进时间'},
					{name: 'followdetails', width: '200', label: '最后一次跟进内容'},
					{name: 'state', width: '90', label: '状态',type:'select',items: [{'新增': '新增'},{'待跟进': '待跟进'}, {'已邀约': '已邀约'}, {'已分配': '已分配'}, {'已签到': '已签到'}, {'接待中': '接待中'}, {'已付定金': '已付定金'},{'已签约': '已签约'},{'施工中': '施工中'},{'已竣工': '已竣工'}]},
					{name: 'details', width: '150', label: '备注(关注点)'},
					{name: 'marktime', width: '150', label: '到场时间',type:'date',pattern:'yyyy-MM-dd'},
					{name: 'record', width: '150', label: '来源备注'},
                    {name: 'source', width: '150', label: '报名渠道来源',type:'select',items:function(){
                        return source_content;
                    }},
                    {name: 'mobilesalesdepname', width: '70', label: '美客部门',type:'select',items:function(){
                        return mobilesalesdepname_content;
                    }},
                    {name: 'mobilesales', width: '70', label: '美客员',type:'select',items:function(){
                        return mobilesales_content;
                    }},
                    {name: 'custsalesdepname', width: '70', label: '销售部门',type:'select',items:function(){
                        return custsalesdepname_content;
                    }},
					{name: 'custsales', width: '70', label: '客户经理',type:'select',items:function(){
						return custsales_content;
					}},
                    {name: 'designer', width: '70', label: '设计师',type:'select',items:function(){
                        return designers_content;
                    }},
                    {name: 'bookingsituation', width: '70', label: '预售情况'},
					{name: 'orgname', width: '70', label: '组织'},
                    {name: 'dispatchtime', width: '150', label: '派单时间',type:'date',pattern:'yyyy-MM-dd'},
                    {name: 'activitytime', width: '150', label: '最后一次报名时间',type:'date',pattern:'yyyy-MM-dd'},
					{name: 'createtime', width: '150', label: '创建时间',type:'date',pattern:'yyyy-MM-dd'},
					{name: 'lasttime', width: '150', label: '更新时间',type:'date',pattern:'yyyy-MM-dd'},
				],
		paging: {pageSize: 50, selectPageSize: '50,100,200', pageCurrent: 1},
		hiddenFields: ['id','custsalesid'],
		columnMenu: true,
		columnShowhide: true,
		columnFilter: true,
		columnLock: false,
		fullGrid: false,
		dblOnClick: 'assistant_dbClickOneRow',
		clickRow: 'assistant_clickOneRow',
        headSureBack:'head_common_mobileAndsales'
	});

	var ass_c_id,ass_c_ids,dispatch_which;
    function assistant_clickOneRow() {
        var selected = $("#general_manager_assistant").data('selectedDatas');
        if (null == selected || selected[0].id != ass_c_id){
            ass_c_id = selected[0].id;
            assistant_follows_refresh();
        }
    }

    function assistant_dbClickOneRow() {
        assistant_show_details("#general_manager_assistant");
    }

    /** 总经办分配客服/跟单/客户经理/设计师等公用函数 @jiaobai */
    function assistant_distribution_onclick(name,tt,htl) {
        var selected = $(name).data('selectedDatas');
        if (null == selected || selected.length == 0) {
            $(this).alertmsg('warn', '请在列表中选择要操作的对象。');
            return;
        } else {
            ass_c_id = selected[0].id;
            ass_c_ids = new Array();
            var isPay = true;
            for (var i = 0; i < selected.length; i++){
                if(isPay && selected[i].state != '已付定金' && selected[i].state != '已签约' && selected[i].state != '施工中'){
                    isPay = false;
                }
                ass_c_ids.push(selected[i].id);
            }

            if(tt=='分配美客'){
                dispatch_which = "mobile";
            }else if(tt=='分配微聊'){ // 即为：新媒体
                dispatch_which = "newmedia";
            }else if(tt=='分配设计师' && !isPay){
                $(this).alertmsg('warn', '分配设计师，必须是[已付定金/已签约/施工中]的客户订单');
                return;
            }
            $(this).dialog({
                title: tt,
                url: "GeneralManagerOffice/"+htl,
                width: 800,
                height: 600,
                mask: true
            });
        }
    }

    var assistant_rfh;
    function assistant_changeValue(num){
        ass_c_id = null;
        ass_c_ids = [];
        assinstant_edit_type = num;
        assistant_rfh="refresh";
        setTimeout(function(){
            assistant_tab_refresh();
        },300);

        assistant_follows_refresh()
    }

    /** 对应tab 数据刷新 */
    function assistant_tab_refresh(){
        var currTab_ = null;
        switch (assinstant_edit_type){
            case 0:
                currTab_ = '#general_manager_assistant';
                break;
            case 1:
                currTab_ = '#general_manager_assistant_tab-toBeAssigned';
                break;
            case 2:
                currTab_ = '#general_manager_assistant_tab-toBeFollowing';
                break;
            case 3:
                currTab_ = '#general_manager_assistant_tab-downPayment';
                break;
            case 4:
                currTab_ = '#general_manager_assistant_tab-signed';
                break;
        }
        if(null != currTab_) {
            if(null != assistant_rfh){
                assistant_rfh = null;
                $(currTab_).datagrid('refresh');
            }else{
                $(currTab_).datagrid('refresh_part');
			}
            $(currTab_).data('selectedDatas', null);
        }
        assistant_follows_refresh();
	}

    /** 跟进信息(加载、刷新) */
    function assistant_follows_refresh(){
        $(this).bjuiajax('doLoad', {
            url: 'GeneralManagerOffice/assistant_follow_table.html',
            target: '#assistant_follow_table',
            loadingmask: false
        });
    }
    /** 查看详情 @param #tb */
    function assistant_show_details(tb) {
        var selected = $(tb).data('selectedDatas');
        if (null == selected || selected.length == 0) {
            $(this).alertmsg('warn', '请在列表中选择要操作的对象。');
        } else {
            ass_c_id = selected[0].id;
            $(this).dialog({
                title: "客户详情",
                url: "GeneralManagerOffice/assistant_follow_edit.html",
                width: 1800,
                height: 900,
                mask: true
            });
        }
    }
</script>

<div style="border: 0px solid green;width: 100% !important;position: relative;height: 60%;">
	<ul class="nav nav-tabs" role="tablist" id="btn_list">
		<li class="active">
			<a style="font-size: 13px" href="#assistant_table_all" role="tab" data-toggle="tab" onclick="assistant_changeValue(0)">全部客户</a>
		</li>
		<li>
			<a style="font-size: 13px" href="GeneralManagerOffice/general_manager_assistant_tab-toBeAssigned.html" role="tab" data-toggle="ajaxtab" data-target="#assistant_table_toBeAssigned" data-reload="false" onclick="assistant_changeValue(1)">待分配</a>
		</li>
		<li>
			<a style="font-size: 13px" href="GeneralManagerOffice/general_manager_assistant_tab-toBeFollowing.html" role="tab" data-toggle="ajaxtab" data-target="#assistant_table_toBeFollowing" data-reload="false" onclick="assistant_changeValue(2)">待跟进</a>
		</li>
		<li>
			<a style="font-size: 13px" href="GeneralManagerOffice/general_manager_assistant_tab-downPayment.html" role="tab" data-toggle="ajaxtab" data-target="#assistant_table_downPayment" data-reload="false" onclick="assistant_changeValue(3)">已交定金</a>
		</li>
		<li>
			<a style="font-size: 13px" href="GeneralManagerOffice/general_manager_assistant_tab-signed.html" role="tab" data-toggle="ajaxtab" data-target="#assistant_table_signed" data-reload="false" onclick="assistant_changeValue(4)">已签约</a>
		</li>
	</ul>

	<div class="tab-content" style="height: 95%;padding: 0px;">
		<!--全部客户-->
		<div class="tab-pane fade active in" id="assistant_table_all" style="height: 100%;">

			<div style="border: 0px solid green;width: 100% !important;position: relative;height: 100%;">
				<div style="margin: 5px;">
					<!--<button type="button" class="btn btn-green" data-icon="sign-out" onclick="show_assistant_alert()"> 导出</button>-->
					<button type="button" class="btn btn-green" data-icon="user" onclick="assistant_distribution_onclick('#general_manager_assistant','分配美客','general_manager_assistant_to_mei_we_chat.html')"> 分配美客</button>
					<!--<button type="button" class="btn btn-green" data-icon="user" onclick="assistant_distribution_onclick('#general_manager_assistant','分配微聊','general_manager_assistant_to_mei_we_chat.html')"> 分配微聊</button>-->
					<button type="button" class="btn btn-green" data-icon="user" onclick="assistant_distribution_onclick('#general_manager_assistant','分配客户经理','general_manager_assistant_to_accountManager.html')"> 分配客户经理</button>
					<button type="button" class="btn btn-green" data-icon="user" onclick="assistant_distribution_onclick('#general_manager_assistant','分配设计师','general_manager_assistant_to_designer.html')"> 分配设计师</button>
					<button type="button" class="btn btn-green" data-icon="edit" onclick="assistant_dbClickOneRow()"><i class="fa fa-edit"></i>查看详情 </button>
				</div>
				<table id="general_manager_assistant" class="table table-hover" data-width="100%"></table>
			</div>

		</div>

		<!--待分配-->
		<div class="tab-pane fade" id="assistant_table_toBeAssigned" style="height: 100%;"> </div>
		<!--待跟进-->
		<div class="tab-pane fade" id="assistant_table_toBeFollowing" style="height: 100%;"> </div>
		<!--已交定金-->
		<div class="tab-pane fade" id="assistant_table_downPayment" style="height: 100%;"> </div>
		<!--已交签约-->
		<div class="tab-pane fade" id="assistant_table_signed" style="height: 100%;"> </div>
	</div>
</div>

<div id="assistant_follow_table" style="border: 0px solid green;width: 100% !important;position: relative;height: 40%;">
	<script>
        assistant_follows_refresh();
	</script>
</div>