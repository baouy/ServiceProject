<script>

	$('#general_manager_dispatch').datagrid({
		local: 'remote',
		dataUrl: '/v1/newcustomer/sale_customerlist?stateid=20', // TODO 活动现场客户
		dataType: 'json',
		sortAll: false,
		loadType: 'get',
		filterAll: true,
		height:'95%',
		columns:
				[
					{name: 'cusname', width: '70', label: '姓名',attrs:{'readonly':"true"}},
					{name: 'mobile', width: '90', label: '电话',attrs:{'readonly':"true"}},
					{name: 'village', width: '100', label: '小区名称',attrs:{'readonly':"true"}},
					{name: 'area', width: '70', label: '面积',attrs:{'readonly':"true"}},
					{name: 'roomstatus', width: '70', label: '交房状态',type:'select',items: [{'现房': '现房'}, {'期房': '期房'}, {'0':'未填写'}],attrs:{'readonly':"true"}},
					{name: 'state', width: '90', label: '状态',type:'select',attrs:{'readonly':"true"},items: [{'新增': '新增'},{'待跟进': '待跟进'}, {'已邀约': '已邀约'}, {'已分配': '已分配'}, {'已签到': '已签到'}, {'接待中': '接待中'}, {'已付定金': '已付定金'},{'已签约': '已签约'},{'施工中': '施工中'},{'已竣工': '已竣工'}]},
					{name: 'details', width: '150', label: '备注(关注点)',attrs:{'readonly':"true"}},
					{name: 'custsalesdepname', width: '70', label: '销售部门',type:'select',items:function(){
						if (custsalesdepname_content == undefined){
							custsalesdepname_content = new Array();
							$.ajax({
								url: '/v1/other/getorgdepdeatil?pid=37',
								dataType: 'json',
								async: false,
								type: 'GET',
								xhrFields: {
									withCredentials: true
								},
								crossDomain: true,
								success: function (d) {
									if (d.state == 200){
										custsalesdepname_data = d.data
										var c
										for (var i = 0 ; i < d.data.length; i ++){
											var b = d.data[i].org_name;
											c = new Object();
											c[b]= b;
											custsalesdepname_content.push(c)
										}
									}
								}
							});
						}
						return custsalesdepname_content;
					}},
					{name: 'firstamout', width: '70', label: '预定金',attrs:{'readonly':"true"}}
				],
		paging: {pageSize: 50, selectPageSize: '50,100,200', pageCurrent: 1},
		hiddenFields: ['id','custsalesid'],
		columnMenu: true,
		columnShowhide: true,
		columnFilter: true,
		columnLock: false,
		fullGrid: false,
        saveAll: true,
        editUrl:'/meiwo',
		headSureBack:'dispatch_headSureBack'
	});

	function dispatch_headSureBack() {
		$("select[name='custsalesdepname']").change(function() {
			var mt = $("select[name='custsalesdepname'] option:selected").val()
			var index= $("select[name='custsalesdepname']").get(0).selectedIndex
			var code;
			if (index == 0){
				code = '001002007';
			}else{
				code = custsalesdepname_data[index - 1].depcode;
			}
			depname_ajax($("select[name='custsales']"),code);
		});
	}

	function depname_ajax(selectpicker,code) {

		$.ajax({
			url: '/v1/user/getdepcode_userlist',
			dataType: 'json',
			type: 'GET',
			data:{
				code:code
			},
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			success: function (d) {
				if (d.state == 200) {
					selectpicker.find('option').remove();
					selectpicker.append($('<option value="">全部</option>'));
					$.each(d.data, function (i) {
						selectpicker.append($("<option value=" + d.data[i].flower_name + ">" + d.data[i].flower_name + "</option>"));
					});
					selectpicker.selectpicker('refresh');
				}
			}
		});
	}

	var g_id,f_id,dispatch_type; //
    function dispatch_clickOneRow() {
        var selected = $("#general_manager_dispatch").data('selectedDatas');
        if (selected[0].id != g_id){
            g_id = selected[0].id;
        }
    }

    function dispatch_dbClickOneRow() {
    }

    function dispatch_action_onclick(act) {
        var rows = $(name).data('selectedDatas');
        if (rows.length == 0) {
            $(this).alertmsg('warn', '请在列表中选择要操作的对象。');
            return;
        } else {
           // f_id = rows[0].id;
			var ids=[],decodes=[];
            for(var i=0; i<rows.length; i++){
                ids.push(rows[i].id);
                decodes.push(rows[i].custsalesdepname);
            }
            alert(ids.join(',')+decodes.join(','));
            // 验证、获取数据

			// 分配提交地址

			// confirm
            switch (act){
                case "save": $(this).alertmsg('confirm', '确定保存吗?', {okCall: 'doSaveBtn'});break;
                case "cancel": $(this).alertmsg('confirm', '确定取消吗?', {okCall: 'doCancelBtn'});break;
                case "submit": $(this).alertmsg('confirm', '提交后不可修改，确定提交吗?', {okCall: 'doSubmitBtn'});break;
                default:break;
            }
        }
    }

    function doSaveBtn() {

    }
    function doSubmitBtn() {

    }
    function doCancelBtn() {

    }


    function dispatch_changeValue(num){
        g_id = null;
        assinstant_edit_type = num;
        setTimeout(function(){
            dispatch_tab_refresh();
        },300);
    }

    /** 对应tab 数据刷新 @jiaobai */
    function dispatch_tab_refresh(){
        switch (assinstant_edit_type){
            case 0:
                $('#general_manager_dispatch').datagrid('refresh');
                break;
            case 1:
                $('#general_manager_dispatch_tab-toBeAssigned').datagrid('refresh');
                break;
            case 2:
                $('#general_manager_dispatch_tab-toBeFollowing').datagrid('refresh');
                break;
            case 3:
                $('#general_manager_dispatch_tab-downPayment').datagrid('refresh');
                break;
            case 4:
                $('#general_manager_dispatch_tab-signed').datagrid('refresh');
                break;
        }
	}
</script>

<div class="bjui-pageContent">
	<div class="dispatchLeft" style="width: 55% !important;position: relative;height: 95%;float: left;">

		<div style="border: 0px solid green;width: 100% !important;position: relative;height: 60%;">
			<ul class="nav nav-tabs" role="tablist" id="btn_list">
				<li class="active">
					<a style="font-size: 13px" href="#dispatch_table_all" role="tab" data-toggle="tab" onclick="dispatch_changeValue(0)">全部客户</a>
				</li>
				<li>
					<a style="font-size: 13px" href="GeneralManagerOffice/general_manager_dispatch_tab-toBeAssigned.html" role="tab" data-toggle="ajaxtab" data-target="#dispatch_table_toBeAssigned" data-reload="false" onclick="dispatch_changeValue(1)">全部待分配</a>
				</li>
				<li>
					<a style="font-size: 13px" href="GeneralManagerOffice/general_manager_dispatch_tab-activity.html" role="tab" data-toggle="ajaxtab" data-target="#dispatch_table_activity" data-reload="false" onclick="dispatch_changeValue(2)">活动场客户</a>
				</li>
				<li>
					<a style="font-size: 13px" href="GeneralManagerOffice/general_manager_dispatch_tab-generalAppointment.html" role="tab" data-toggle="ajaxtab" data-target="#dispatch_table_generalAppointment" data-reload="false" onclick="dispatch_changeValue(3)">普通预约客户</a>
				</li>
				<li>
					<a style="font-size: 13px" href="GeneralManagerOffice/general_manager_dispatch_tab-ownArrival.html" role="tab" data-toggle="ajaxtab" data-target="#dispatch_table_ownArrival" data-reload="false" onclick="dispatch_changeValue(4)">自然到店客户</a>
				</li>
			</ul>

			<div class="tab-content" style="height: 95%">
				<!--全部客户-->
				<div class="tab-pane fade active in" id="dispatch_table_all" style="height: 100%;">

					<div style="border: 0px solid green;width: 100% !important;position: relative;height: 100%;">
						<div style="margin: 5px;">
							<button type="button" class="btn btn-green" data-icon="user" onclick="dispatch_action_onclick('save')"> 保存</button>
							<button type="button" class="btn btn-green" data-icon="user" onclick="dispatch_action_onclick('cancel')"> 取消</button>
							<button type="button" class="btn btn-green" data-icon="user" onclick="dispatch_action_onclick('submit')"> 提交</button>
						</div>
						<table id="general_manager_dispatch" class="table table-hover" data-width="100%"></table>
					</div>

				</div>

				<!--待分配-->
				<div class="tab-pane fade" id="dispatch_table_toBeAssigned" style="height: 100%;">

				</div>

				<!--活动场客户-->
				<div class="tab-pane fade" id="dispatch_table_activity" style="height: 100%;">

				</div>
				<!--普通预约客户-->
				<div class="tab-pane fade" id="dispatch_table_generalAppointment" style="height: 100%;">

				</div>
				<!--自然到店客户-->
				<div class="tab-pane fade" id="dispatch_table_ownArrival" style="height: 100%;"> </div>
			</div>
		</div>

	</div>
	<div class="dispatchRight" style="width: 45% !important;position: relative;height: 95%;float: left;">
		<table id="statistical_table" class="table table-hover" data-width="100%"></table>
	</div>
</div>
