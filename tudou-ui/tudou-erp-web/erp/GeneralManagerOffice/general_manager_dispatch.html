<script>

	var g_h_b_i_data='',g_e_b_i_data='';
	$('#general_manager_dispatch').datagrid({
		local: 'remote',
		dataUrl: '/v1/newcustomer/dispatch_customerlist?stateid=20&stime='+g_h_b_i_data+'&etime='+g_e_b_i_data, // 20 已邀约
		dataType: 'json',
		sortAll: false,
		loadType: 'get',
		filterAll: true,
		height:'100%',
		columns:
				[
					{name: 'cusname', width: '70', label: '姓名',attrs:{'readonly':"true"}},
					{name: 'mobile', width: '90', label: '电话',attrs:{'readonly':"true"}},
					{name: 'village', width: '100', label: '小区名称',attrs:{'readonly':"true"}},
					{name: 'area', width: '70', label: '面积',type:'select',area:true,items: [{'1': '70㎡以下'}, {'2': '70㎡-80㎡'}, {'3':'80㎡-90㎡'},{'4': '90㎡-100㎡'}, {'5': '100㎡-110㎡'}, {'6':'110㎡-120㎡'}, {'7':'120㎡以上'},{'0':'未填写'}],attrs:{'disabled':"disabled"},change: function (val) {
						var str;
						if (val == 0){
							str = 0
						}else if (val > 0 && val <= 70){
							str = 1
						}else if(val > 70 && val <= 80){
							str = 2
						}else if(val > 80 && val <= 90){
							str = 3
						}else if(val > 90 && val <= 100){
							str = 4
						}else if(val > 100 && val <= 110){
							str = 5
						}else if(val > 110 && val <= 120){
							str = 6
						}else if(val > 120){
							str = 7
						}
						return str;
					}

					},
					{name: 'roomstatus', width: '70', label: '交房状态',type:'select',items: [{'现房': '现房'}, {'期房': '期房'}, {'NO':'未填写'}],attrs:{'disabled':"disabled"}},
					{name: 'bookingsituation',attrs:{'readonly':"true"}, width: '70', label: '预售情况'},
					{name: 'marktime', width: '150', label: '邀约时间',type:'date',pattern:'yyyy-MM-dd hh:mm:ss',attrs:{'readonly':"true"}},
					{name: 'custsalesdepname', width: '70', label: '销售部门',type:'select',rule: 'required,no',items:function(){
						if (custsalesdepname_content == undefined){
							custsalesdepname_content = new Array();
							$.ajax({
								url: '/v1/other/getorgdepdeatil?pid=37',
								dataType: 'json',
								async: false,
								type: 'GET',
								xhrFields: {
									withCredentials: true
								},
								crossDomain: true,
								success: function (d) {
									if (d.state == 200){
										custsalesdepname_data = d.data
										var c
										for (var i = 0 ; i < d.data.length; i ++){
											var b = d.data[i].org_name;
											c = new Object();
											c[b]= b;
											custsalesdepname_content.push(c)
										}
									}
									var c = new Object();
									c['NO']= '请选择赛选';
									c['']= '请选择为空';
									custsalesdepname_content.push(c)
								}
							});
						}
						return custsalesdepname_content;
					}}
				],
		paging: false,
		hiddenFields: ['id','custsalesid'],
		columnMenu: true,
		columnShowhide: true,
        columnFilter: true,
        toolbarCustom:
		'<button type="button" class="btn btn-blue" data-icon="sign-out" id = "dispatch_submit" onclick="customer_dispatch_post_submit()"> 提交 </button></div>' +
		'<input type="text" id="general_summary_h_b_i" data-toggle="datepicker" size="15" class="form-control" aria-required="true" style="width: 80px;margin-left: 5px;">' +
		'<label class="control-label">—</label>'+
		'<input type="text" id="general_summary_e_b_i" data-toggle="datepicker" size="15" class="form-control" aria-required="true" style="width: 80px;">' +
		'<button type="button" class="btn btn-green" onclick="select_general_detail_data()" style="margin-left: 5px;"><i class="fa fa-edit"></i> 查询</button>' +
		'<button type="button" class="btn btn-green" onclick="clear_general_detail_data()" style="margin-left: 5px;"><i class="fa fa-undo"></i> 刷新</button>'
		,
        columnLock: false,
        fullGrid: false,
        showToolbar: true,
        toolbarItem: 'save,cancel',
        saveAll: true,
        editUrl:'/v1/newcustomer/customer_dispatch_post',
		selectChange:'selectBack',
		editCallback:'general_edit_back',
        editdblOnclick: true,
	});

	$('#channel_summary_h_b_i').val(g_h_b_i_data);
	$('#channel_summary_e_b_i').val(g_e_b_i_data);

//    function dispatch_changeValue(num){
//        g_id = null;
//        assinstant_edit_type = num;
//        setTimeout(function(){
//            dispatch_tab_refresh();
//        },300);
//    }
//
//    /** 对应tab 数据刷新 @jiaobai */
//    function dispatch_tab_refresh(){
//        switch (assinstant_edit_type){
//            case 0:
//                $('#general_manager_dispatch').datagrid('refresh');
//                break;
//            case 1:
//                $('#general_manager_dispatch_tab-toBeFollowing').datagrid('refresh');
//                break;
//            case 2:
//                $('#general_manager_dispatch_tab-downPayment').datagrid('refresh');
//                break;
//            case 3:
//                $('#general_manager_dispatch_tab-signed').datagrid('refresh');
//                break;
//        }
//	}
	
	function select_general_detail_data() {
		var s = $('#general_summary_h_b_i').val()
		if (s.length == 10){
			g_h_b_i_data = s + " 00:00:00"
		}
		var e = $('#general_summary_e_b_i').val()
		if (e.length == 10){
			g_e_b_i_data = e + " 24:00:00"
		}

		$('#general_manager_dispatch').datagrid('refresh_url','/v1/newcustomer/dispatch_customerlist?stateid=20&stime='+g_h_b_i_data+'&etime='+g_e_b_i_data);
		$('#general_manager_dispatch').datagrid('refresh');

		$(this).bjuiajax('doLoad', {
			url: 'GeneralManagerOffice/general_manage_statistical_table.html',
			target: '#general_manage_statistical_table',
			loadingmask: true
		});
	}
	
	function clear_general_detail_data() {
		g_h_b_i_data = ''
		g_e_b_i_data = ''
		$('#general_summary_h_b_i').val('');
		$('#general_summary_e_b_i').val('');

		$('#general_manager_dispatch').datagrid('refresh_url','/v1/newcustomer/dispatch_customerlist?stateid=20&stime='+g_h_b_i_data+'&etime='+g_e_b_i_data);
		$('#general_manager_dispatch').datagrid('refresh');

		$(this).bjuiajax('doLoad', {
			url: 'GeneralManagerOffice/general_manage_statistical_table.html',
			target: '#general_manage_statistical_table',
			loadingmask: true
		});

	}
	
	function selectBack(changeData) {
		console.log(changeData);
		for (var i = 0 ; i < custsalesdepname_data.length; i ++){
			var b = custsalesdepname_data[i].org_name;
			if (changeData['custsalesdepname'] == b){
				changeData['custsalescode'] = custsalesdepname_data[i].depcode
			}
		}
	}
	
	function general_edit_back(json) {
		if(json.state == 200){
			$('#general_manager_dispatch').datagrid('refresh');
			$(this).bjuiajax('doLoad', {
				url: 'GeneralManagerOffice/general_manage_statistical_table.html',
				target: '#general_manage_statistical_table',
				loadingmask: true
			});
		}
	}
	function customer_dispatch_post_submit() {
		$(this).alertmsg('confirm', '是否提交保存的数据!',
				{ okName:'确认', cancelName:'关闭', title:'提交',
					okCall:'customer_dispatch_post_submit_sure'})
	}
	
	function customer_dispatch_post_submit_sure() {
		$.ajax({
			url: '/v1/newcustomer/customer_dispatch_post_submit',
			dataType: 'json',
			async: true,
			type: 'POST',
			crossDomain: true,
			success: function (d) {
				if (d.state == 200){
					$(this).alertmsg('ok', '提交成功!');
					$('#general_manager_dispatch').datagrid('refresh');
					$(this).bjuiajax('doLoad', {
						url: 'GeneralManagerOffice/general_manage_statistical_table.html',
						target: '#general_manage_statistical_table',
						loadingmask: true
					});
				}else{
					$(this).alertmsg('warn', '提交失败,请联系管理员!');
				}
			}
		});
	}
	
</script>

<div class="bjui-pageContent">
	<div class="dispatchLeft" style="width: 55% !important;position: relative;height: 100%;float: left;">

		<table id="general_manager_dispatch" class="table table-hover"></table>

		<!--<div style="border: 0px solid green;width: 100% !important;position: relative;height: 100%;">-->
			<!--<ul class="nav nav-tabs" role="tablist" id="btn_list">-->
				<!--<li class="active">-->
					<!--<a style="font-size: 13px" href="#dispatch_table_all" role="tab" data-toggle="tab" onclick="dispatch_changeValue(0)">全部待分配</a>-->
				<!--</li>-->
				<!--<li>-->
					<!--<a style="font-size: 13px" href="GeneralManagerOffice/general_manager_dispatch_tab-activity.html" role="tab" data-toggle="ajaxtab" data-target="#dispatch_table_activity" data-reload="false" onclick="dispatch_changeValue(1)">活动场客户</a>-->
				<!--</li>-->
				<!--<li>-->
					<!--<a style="font-size: 13px" href="GeneralManagerOffice/general_manager_dispatch_tab-generalAppointment.html" role="tab" data-toggle="ajaxtab" data-target="#dispatch_table_generalAppointment" data-reload="false" onclick="dispatch_changeValue(2)">普通预约客户</a>-->
				<!--</li>-->
			<!--</ul>-->

			<!--<div class="tab-content" style="height: 95%">-->
				<!--&lt;!&ndash;全部客户&ndash;&gt;-->
				<!--<div class="tab-pane fade active in" id="dispatch_table_all" style="height: 100%;">-->

						<!--<table id="general_manager_dispatch" class="table table-hover"></table>-->

				<!--</div>-->

				<!--待分配-->
				<!--<div class="tab-pane fade" id="dispatch_table_toBeAssigned" style="height: 100%;">-->

				<!--</div>-->

				<!--&lt;!&ndash;活动场客户&ndash;&gt;-->
				<!--<div class="tab-pane fade" id="dispatch_table_activity" style="height: 100%;">-->

				<!--</div>-->
				<!--&lt;!&ndash;普通预约客户&ndash;&gt;-->
				<!--<div class="tab-pane fade" id="dispatch_table_generalAppointment" style="height: 100%;">-->

				<!--</div>-->
				<!--自然到店客户-->
				<!--<div class="tab-pane fade" id="dispatch_table_ownArrival" style="height: 100%;"> </div>-->
			<!--</div>-->
		<!--</div>-->

	</div>
	<div class="dispatchRight" style="width: 45% !important;position: relative;height: 100%;float: left;">
		<div id="general_manage_statistical_table" style="width: 100%; height: 100%;">
			<script>
				$(this).bjuiajax('doLoad', {
					url: 'GeneralManagerOffice/general_manage_statistical_table.html',
					target: '#general_manage_statistical_table',
					loadingmask: true
				});
			</script>
		</div>
	</div>



</div>
