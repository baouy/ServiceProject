<html>
<style type="text/css">
    .iconp {
        position: absolute;
    }

    .iconp li {
        list-style: none;
        float: left;
        margin-left: 3px;
    }

    .iconp img {
        width: 32px;
    }
</style>
<head>
    <script type="text/javascript">
        var id, pid, prid;
        init();
        function init() {
            var $t = $('#model-ztree');
            $t.data('addHoverDom', "edit").data('removeHoverDom', "edit").data('onRemove', 'onRemove');
        }

        //保存事件
        function saveMenu() {
            if (pid === undefined && prid === undefined) {
                return;
            }
            var name = $('#name').val();
            var isperson = $('#isperson').val();
            //新增
            if (prid === undefined) {
                itemclass_add(pid, name, isperson);
            }
            //编辑
            else {
                itemclass_reset(prid, name, isperson, pid);
            }
        }
        //点击节点
        function S_NodeCheck(e, treeId, treeNode) {

            var id = treeNode.id;//id
            if (id < 1000) {
                $('#isperson').iCheck('disable');
            } else {
                $('#isperson').iCheck('enable');
            }
            var name = treeNode.name;//名称
            var isperson = treeNode.isperson;//是否为个性包
            var treeObj = $.fn.zTree.getZTreeObj(treeId);
            if (id === undefined) {//如果id不存在，则是新增
                prid = undefined;
                pid = treeNode.pId;//得到父节点id
                $('#name').val('');
                $('#isperson').iCheck('uncheck');

                var node = treeObj.getNodeByParam("id", pid, null);
                if (node != null) {
                    $("#parentname").val(node.name);
                } else {
                    $("#parentname").val('');
                }

            } else {//回显
                prid = treeNode.id;
                pid = treeNode.pId;//得到父节点id
                if (treeNode.levelid == 2) {

                    var node = treeObj.getNodeByParam("id", pid, null);
                    $("#parentname").val(node.name);
                } else {
                    $("#parentname").val('');
                }

                $('#name').val(name);
                if (isperson) {
                    $('#isperson').iCheck('check');
                } else {
                    $('#isperson').iCheck('uncheck');
                }

                var workersroleid = treeNode.workersroleid;
                if (workersroleid != null) {
                    $("#WorkersRole").val(workersroleid);
                } else {
                    $("#WorkersRole").val(-1);
                }
                $('#WorkersRole').selectpicker('refresh');
                $('#WorkersRole').selectpicker('render');

                var projectstateid = treeNode.projectstateid;
                if (projectstateid != null) {
                    $("#projectstate").val(projectstateid);
                } else {
                    $("#projectstate").val(-1);
                }
                $('#projectstate').selectpicker('refresh');
                $('#projectstate').selectpicker('render');
                console.log(treeNode.level)
                if (treeNode.level == 2) {
                    $("#qcfield").removeClass('hide');
                    getqcList(id);
                    $("#modelphase").removeClass("hide");
                    var node;
                    if (treeNode.levelid == 1 || treeNode.level == 2) {
                        node = treeObj.getNodeByParam("id", pid, null);
                    } else if (treeNode.levelid == 2 || treeNode.level == 3) {
                        node = treeObj.getNodeByParam("id", treeObj.getNodeByParam("id", pid, null).pId, null);
                    }
                    $("#modelid").val(node.id);
                } else {
                    $("#qcfield").addClass('hide');
                    getqcList(0);
                    $("#modelphase").addClass("hide");
                }
            }
            $("#icon1").val(treeNode.icon1);
            $("#icon2").val(treeNode.icon2);
        }
        //新增
        function itemclass_add(pid, name, isperson) {
            var workersroleid = $("#WorkersRole option:selected").val();
            var workersrole = $("#WorkersRole option:selected").text();
            var projectstateid = $("#projectstate option:selected").val();
            var projectstate = $("#projectstate option:selected").text();
            var parentname = $("#parentname").val();
            var qcroleid = $("#qcroleid").val();
            var modelid = $("#modelid").val();
            var icon1 = $("#icon1").val();
            var icon2 = $("#icon2").val();
            $.ajax({
                url: '/v1/project/tprojectmodel_add',
                dataType: 'json',
                type: 'POST',
                data: {
                    pId: pid,
                    name: name,
                    parentname: parentname,
                    isperson: isperson,
                    workersroleid: workersroleid,
                    workersrole: workersrole,
                    projectstateid: projectstateid,
                    projectstate: projectstate,
                    qcroleid: qcroleid,
                    modelid: modelid,
                    icon1: icon1,
                    icon2: icon2
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        var zTree = $.fn.zTree.getZTreeObj("model-ztree");
                        zTree.reAsyncChildNodes(null, "refresh");
                        setTimeout(function () {
                            var zTree = $.fn.zTree.getZTreeObj("model-ztree");
                            var ndoe = zTree.getNodeByParam("id", pid, null);
                            zTree.expandNode(ndoe, true, true, true);
                            zTree.selectNode(zTree.getNodeByParam("id", d.data, null));
                        }, 300);
                    } else {
                        $(this).alertmsg('warn', '添加失败!');
                    }
                }
            });
        }

        //修改
        function itemclass_reset(id, name, isperson, pid) {
            var workersroleid = $("#WorkersRole option:selected").val();
            var workersrole = $("#WorkersRole option:selected").text();
            var projectstateid = $("#projectstate option:selected").val();
            var projectstate = $("#projectstate option:selected").text();
            var parentname = $("#parentname").val();
            var qcroleid = $("#qcroleid").val();
            var modelid = $("#modelid").val();
            var icon1 = $("#icon1").val();
            var icon2 = $("#icon2").val();
            $.ajax({
                url: '/v1/project/tprojectmodel_edit',
                dataType: 'json',
                type: 'POST',
                data: {
                    id: id,
                    pId: pid,
                    name: name,
                    parentname: parentname,
                    isperson: isperson,
                    workersroleid: workersroleid,
                    workersrole: workersrole,
                    projectstateid: projectstateid,
                    projectstate: projectstate,
                    qcroleid: qcroleid,
                    modelid: modelid,
                    icon1: icon1,
                    icon2: icon2
                },
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        var zTree = $.fn.zTree.getZTreeObj("model-ztree");
                        zTree.reAsyncChildNodes(null, "refresh");
                        setTimeout(function () {
                            var zTree = $.fn.zTree.getZTreeObj("model-ztree");
                            var ndoe = zTree.getNodeByParam("id", pid, null);
                            zTree.expandNode(ndoe, true, true, true);
                            zTree.selectNode(zTree.getNodeByParam("id", id, null));
                        }, 300);
                    } else {
                        $(this).alertmsg('warn', '更新失败!');
                    }
                }
            });
        }
        function show_delete_model() {
            var zTree = $.fn.zTree.getZTreeObj("model-ztree");
            var nodes = zTree.getSelectedNodes();
            if (nodes == null || nodes.length == 0) {
                $(this).alertmsg('error', '请在选择要操作的节点。');
            } else {
                $(this).alertmsg('confirm', '确定删除吗?', {okCall: 'model_deleteItesm'});
            }

        }
        function model_deleteItesm() {
            var zTree = $.fn.zTree.getZTreeObj("model-ztree");
            var nodes = zTree.getSelectedNodes();
            var level = nodes[0].levelid == null ? 0 : nodes[0].levelid;

            $(this).alertmsg('confirm', '确定删除吗?', {
                okCall: $.ajax({
                    url: '/v1/project/tprojectmodel_del?id=' + nodes[0].id + "&level=" + level,
                    dataType: 'json',
                    type: 'POST',
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (d) {
                        if (d.state == 200) {
                            $(this).alertmsg('ok', '操作成功');
                            var treeObj = $.fn.zTree.getZTreeObj("model-ztree");
                            treeObj.reAsyncChildNodes(null, "refresh");
                        }
                    }
                })
            });
        }
        function addQc(id) {
            if (id) {
                var datas = $("#qc_datagrid").data('selectedDatas');
                if (datas.length != 1) return;
                $(this).dialog({
                    id: 'qcmode_edit',
                    target: $("#qcmodel"),
                    title: '编辑验收模板',
                    width: '500',
                    height: '120',
                    mask: true
                });
                var stagename = datas[0].stagename;
                $("#stagename").val(stagename);
                $("#id_").val(datas[0].id);
                $("#qclevel").val(datas[0].qclevel);
                $('#qclevel').selectpicker('refresh');
                $('#qclevel').selectpicker('render');
            } else {
                $(this).dialog({
                    id: 'qcmode_edit',
                    target: $("#qcmodel"),
                    title: '添加验收模板',
                    width: '500',
                    height: '120',
                    mask: true
                });
            }

        }
        function delQc() {
            var datas = $("#qc_datagrid").data('selectedDatas');
            if (datas.length < 1) return;
            var arr = [];
            for (var i = 0; i < datas.length; i++) {
                arr.push(datas[i].id)
            }
            $.ajax({
                url: '/v1/project/tprojectmodel_qc_del?ids=' + arr,
                dataType: 'json',
                type: 'get',
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        $(this).alertmsg('ok', '操作成功');
                       // $('#qc_datagrid').datagrid('reload');
                        getqcList();
                    }
                }
            });
        }
        function saveQc() {
            var stagename = $("#stagename").val();
            var zTree = $.fn.zTree.getZTreeObj("model-ztree");
            var nodes = zTree.getSelectedNodes();
            var modeldetailid = nodes[0].id;
            var modelid = $("#modelid").val();
            $.ajax({
                url: '/v1/project/tprojectmodel_qc_save',
                data: {
                    stagename: stagename,
                    modeldetailid: modeldetailid,
                    modelid: modelid,
                    id: $("#id_").val(),
                    qclevel: $("#qclevel").val()
                },
                dataType: 'json',
                type: 'POST',
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        $(this).alertmsg('ok', '操作成功');
                        getqcList();
                        BJUI.dialog("closeCurrent", this);

                    }
                }
            });
        }
        var datagridexistid;
        function getqcList(id) {
            if (id)datagridexistid = id;
            $("#datatable").load('EngineeringManagement/project_model_table.html');
        }

        $.ajax({
            url: '/v1/project/getWorker',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function (data) {
                for (var worker of data.data) {
                    var html = '<option value="' + worker.id + '">' + worker.roleName + '</option>'
                    $("#WorkersRole").append(html);
                    $('#WorkersRole').selectpicker('refresh');
                    $('#WorkersRole').selectpicker('render');
                }
            }
        });


        $(".greyipt").click(function (event) {
            event.stopPropagation();
            $(".iconp").addClass('hide');
            $(".icongrey").removeClass('hide');
            $(".iconp").attr('style', ' left: 572px; top: 190px')
        });
        $(".coript").click(function (event) {
            event.stopPropagation();
            $(".iconp").addClass('hide');
            $(".iconcor").removeClass('hide');
            $(".iconp").attr('style', ' left: 572px; top: 220px')
        });
        $(".iconcor li").click(function (event) {
            event.stopPropagation();
            $(".coript").val($(this).find('img').attr('src'));
            $(".iconcor").addClass('hide');
        });
        $(".icongrey li").click(function (event) {
            event.stopPropagation();
            $(".greyipt").val($(this).find('img').attr('src'));
            $(".icongrey").addClass('hide');
        });
        $('body').click(function () {
            $(".iconp").addClass('hide');
        });

    </script>

</head>

<body>


<div class="bjui-pageContent">
    <div class="roleLeft"
         style="border: 0px solid green;width: 300px !important;height: 100%;float: left;overflow: auto">
        <ul id="model-ztree" class="ztree"
            data-on-click="S_NodeCheck"
            data-radio-type="all"
            data-expand-all="true"
            data-toggle="ztree"
            data-options="{maxAddLevel:3}"
            data-setting="{
                            async:
                            {
                                enable: true,
                                url:'/v1/project/project_model_list',
                                autoParam: ['id','pId'],
                                contentType: 'application/json',
                                dataType: 'json',
                                type:'get'
                            },view: {
                                selectedMulti: false
                            }
                         }"></ul>

    </div>

    <!--右边-->
    <div class="roleRight" style="width:900px;min-height:600px;margin: 10px 300px;">


        <div class="" data-content="详细信息">
            <fieldset>
                <legend>工程模板</legend>
                <div class="form-group">
                    <label for="name" class="control-label x85">名称:</label>
                    <input type="text" class="form-control" name="name" id="name" size="15" style="width: 150px;">
                    <input type="hidden" class="form-control" name="parentname" id="parentname" size="15"
                           style="width: 150px;">
                    <input type="hidden" class="form-control" name="modelid" id="modelid" size="15"
                           style="width: 150px;">
                </div>
                <div class="form-group">
                    <label for="isperson" class="control-label x85">是否为个性包:</label>
                    <td><input type="checkbox" name="isperson" id="isperson" value="1" data-toggle="icheck"
                               data-label="复选框"></td>
                </div>
                <div id="modelphase" class="hide">
                    <div class="form-group">
                        <label for="WorkersRole" class="control-label x85">工种:</label>
                        <td><select name="workersrole" id="WorkersRole" data-toggle="selectpicker">
                            <option value="-1">-请选择-</option>
                        </select></td>
                    </div>
                    <div class="form-group">
                        <label for="projectstate" class="control-label x85">工程状态:</label>
                        <td><select name="projectstate" id="projectstate" data-toggle="selectpicker">
                            <option value="-1">-请选择-</option>
                            <option value="56">前期完成</option>
                            <option value="57">中期完成</option>
                            <option value="58">已竣工</option>
                        </select></td>
                    </div>
                    <!--<div class="form-group">
                        <label class="control-label x85">是否需要质检:</label>
                        <td>
                            <input type="radio" name="qcroleid0" id="qcroleid1" data-toggle="icheck" data-label="是" value="1" checked="checked">
                            <input type="radio" name="qcroleid0" id="qcroleid2" data-toggle="icheck" data-label="否" value="0">
                            <input type="hidden" name="qcroleid" id="qcroleid" value="1">
                        </td>
                    </div>-->
                    <div class="form-group">
                        <label for="icon1" class="control-label x85">阶段图标1:</label>
                        <input type="text" class="form-control iconipt greyipt" name="icon1" id="icon1" size="15"
                               style="width: 150px;" readonly="readonly">
                    </div>
                    <div class="form-group">
                        <label for="icon2" class="control-label x85">阶段图标2:</label>
                        <input type="text" class="form-control iconipt coript" name="icon1" id="icon2" size="15"
                               style="width: 150px;" readonly="readonly">
                    </div>
                </div>
                <div class="form-group" style="padding-top:8px; border-top:1px #DDD solid;">
                    <label class="control-label x85"></label>
                    <button class="btn btn-green" onclick="saveMenu();"><i class="fa fa-floppy-o"></i>&nbsp; 保存&更新
                    </button>
                    <button type="button" class="btn btn-red" data-icon="times" onclick="show_delete_model()"><i
                            class="fa fa-times"></i> 删除
                    </button>
                </div>
            </fieldset>
        </div>
        <div class=" hide" data-content="验收模板" id="qcfield">
            <fieldset>
                <legend>验收模板</legend>
                <div id="datatable"></div>
                <!--<table id="qc_datagrid" class="table table-hover" data-width="100%"></table>-->
                <label class="control-label x85"></label>
                <button class="btn btn-green" onclick="addQc();"><i class="fa fa-plus"></i>&nbsp; 添加</button>
                <button type="button" class="btn btn-orange" data-icon="times" onclick="addQc(1);"><i
                        class="fa fa-edit"></i> 编辑
                </button>
                <button type="button" class="btn btn-red" data-icon="times" onclick="delQc();"><i
                        class="fa fa-times"></i> 删除
                </button>
            </fieldset>
        </div>

    </div>
    <div class="form-group hide" data-noinit="true" id="qcmodel">
        <label for="stagename" class="control-label x85">阶段名称:</label>
        <input type="text" class="form-control" name="stagename" id="stagename" size="15" style="width: 150px;">
        <br><br>
        <label for="qclevel" class="control-label x85">验收等级:</label>
        <select name="qclevel" id="qclevel" data-toggle="selectpicker">
            <option value="118">蓝色</option>
            <option value="119">黄色</option>
            <option value="120">红色</option>
        </select>
        <input type="hidden" class="form-control" name="id" id="id_">
        <button class="btn btn-green" onclick="saveQc();"><i class="fa fa-floppy-o"></i>&nbsp; 保存</button>
    </div>
    <div class="hide iconp icongrey">
        <ul>
            <li><img src="https://image.meiwo.cn/icon_prepare_grey.png" alt="施工前准备"></li>
            <li><img src="https://image.meiwo.cn/icon_water_grey.png" alt="水电工"></li>
            <li><img src="https://image.meiwo.cn/icon_anz_grey.png" alt="安装工"></li>
            <li><img src="https://image.meiwo.cn/icon_done_grey.png" alt="完工"></li>
            <li><img src="https://image.meiwo.cn/icon_mood_grey.png" alt="木工"></li>
            <li><img src="https://image.meiwo.cn/icon_wa_grey.png" alt="瓦工"></li>
            <li><img src="https://image.meiwo.cn/icon_youqi_grey.png" alt="油漆工"></li>
        </ul>
    </div>
    <div class="hide iconp iconcor">
        <ul>
            <li><img src="https://image.meiwo.cn/icon_prepare_cor.png" alt="施工前准备"></li>
            <li><img src="https://image.meiwo.cn/icon_water_cor.png" alt="水电工"></li>
            <li><img src="https://image.meiwo.cn/icon_anz_cor.png" alt="安装工"></li>
            <li><img src="https://image.meiwo.cn/icon_done_cor.png" alt="完工"></li>
            <li><img src="https://image.meiwo.cn/icon_mood_cor.png" alt="木工"></li>
            <li><img src="https://image.meiwo.cn/icon_wa_cor.png" alt="瓦工"></li>
            <li><img src="https://image.meiwo.cn/icon_youqi_cor.png" alt="油漆工"></li>
        </ul>
    </div>
</div>

</body>

</html>