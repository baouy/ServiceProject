<!DOCTYPE html>
<html lang="en">
<head>
    <script type="text/javascript">
        var usingphase = $("#usingphase").val();
        if(usingphase==""){
            BJUI.dialog("closeCurrent", this);
            BJUI.alertmsg('error', "未选使用阶段", {
                displayMode: 'fade',
                alertTimeout: 1000,
                displayPosition: 'middlecenter'
            });

        }else{
            //展示获取的采购单列表
            $("#salesorder_selecte_lsit").datagrid({
                local: 'remote',
                dataUrl: '/v1/myother/getsalesorderlist',
                dataType: 'json',
                sortAll: false,
                loadType: 'get',
                filterAll: true,
                height: '95%',
                columns: [
                    {name: 'sodoc', width: '150', label: '销售订单号'},
                    {name: 'receivedaddress', width: '150', label: '送货地址', hide: true},


                    {name: 'custid', width: '150', label: '客户经理', hide: true},
                    {name: 'custusername', width: '150', label: '客户姓名'},
                    {name: 'contractdoc', width: '150', label: '合同号'},
                    {name: 'contractid', width: '150', label: '合同id', hide: true},

                    {name: 'mobile', width: '150', label: '手机号'},
                    {name: 'projectmanager', width: '150', label: '项目经理'},



                    {name: 'details', width: '150', label: '备注', hide: true},

                    {name: 'linestate', width: '150', label: '行状态', hide: true},
                    {name: 'itemno', width: '150', label: '料号', hide: true},
                    {name: 'itemclass', width: '150', label: '分类', hide: true},
                    {name: 'brand', width: '150', label: '品牌', hide: true},
                    {name: 'partname', width: '150', label: '商品名称', hide: true},
                    {name: 'partspec', width: '150', label: '规格', hide: true},
                    {name: 'partstyle', width: '150', label: '型号', hide: true},
                    {name: 'funit', width: '150', label: '单位', hide: true},
                    {name: 'qty', width: '150', label: '原数量', hide: true},
                    {name: 'linenum', width: '150', label: '销售订单行号', hide: true},
                    {name: 'orgname', width: '80', label: '组织'},
                    {name: 'projectmanagerphone', width: '80', label: '项目经理手机',hide: true},
                    {name: 'id', width: '80', label: '主键', hide: true},

                ],
                showLinenumber: true,
                paging: {pageSize: 50, selectPageSize: '50,100,200', pageCurrent: 1},
                columnMenu: true,
                columnShowhide: true,
                columnFilter: true,
                columnLock: false,
                fullGrid: false
            })
            function sales_order_select() {
                var sodoc = "'" + $("#salesorder_selecte_lsit .datagrid-selected-tr>td:eq(1)").text() + "'";//供应商编码
                var receivedaddress = "'" + $("#salesorder_selecte_lsit .datagrid-selected-tr>td:eq(2)").text() + "'";
                var orderid = "'" + $("#salesorder_selecte_lsit .datagrid-selected-tr>td:eq(22)").text() + "'";

                var custid = "'"+$("#salesorder_selecte_lsit .datagrid-selected-tr>td:eq(3)").text()+"'";
                var custname = "'"+$("#salesorder_selecte_lsit .datagrid-selected-tr>td:eq(4)").text()+"'";
                var contractdoc = "'"+$("#salesorder_selecte_lsit .datagrid-selected-tr>td:eq(5)").text()+"'";
                var contractid = "'"+$("#salesorder_selecte_lsit .datagrid-selected-tr>td:eq(6)").text()+"'";
//            var receivedphone = "'"+$("#salesorder_selecte_lsit .datagrid-selected-tr>td:eq(7)").text()+"'";
                var receiveduser = "'"+$("#salesorder_selecte_lsit .datagrid-selected-tr>td:eq(8)").text()+"'";
                var receivedphone = "'"+$("#salesorder_selecte_lsit .datagrid-selected-tr>td:eq(21)").text()+"'";
//            var businessdate = "'"+$("#salesorder_selecte_lsit .datagrid-selected-tr>td:eq(7)").text()+"'";
//            var paymentaccount = "'"+$("#salesorder_selecte_lsit .datagrid-selected-tr>td:eq(8)").text()+"'";
//            var details = "'"+$("#salesorder_selecte_lsit .datagrid-selected-tr>td:eq(9)").text()+"'";
                //将获取的值封装好,回传
//            $("#selected_order").attr("data-args","{sodoc:"+sodoc+","+"stores:"+stores+","+"custsales:"+custsales+","
//                    +"custusername:"+custusername+","+"mobile:"+mobile+","+"receivedaddress:"+receivedaddress+","
//                    +"businessdate:"+businessdate+","+"paymentaccount:"+paymentaccount+","+"details:"+details+","
//                    +"}");
                $("#selected_order").attr("data-args", "{sodoc:" + sodoc + ","
                        +"orderid:" + orderid +","
                        +"custid:" + custid +","
                        +"custname:" + custname +","
                        +"contractdoc:" + contractdoc +","
                        +"contractid:" + contractid +","
                        +"receivedphone:" + receivedphone +","
                        +"receiveduser:" + receiveduser +","
                        +"receivedaddress:" + receivedaddress + "}");

                var selected = $("#salesorder_selecte_lsit").find('tr.datagrid-selected-tr');
//            console.log($("#usingphase").val()=="");
//            var usingphase = $("#usingphase").val() == "" ? null : $("#usingphase").val();

                //获取套餐名称
//            var typename = selected.find('td').eq(2)[0].innerText;
                $.ajax({
                    url: '/v1/myother/getsalesorderdetaillist?usingphase='+usingphase,
                    dataType: 'json',
                    type: 'GET',
                    data: {
                        id: selected[0].lastChild.innerText,
                    },
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (d) {
                        var html = "";
                        if (d.state == 200) {
                            //各数量,添加合计栏时计算
                            //构造html代码
                            for (var i = 0; i < d.data.length; i++) {
                                var actualapplyqty =d.data[i].qty-d.data[i].recqty;
                                //需要合计的三个值
                                html += "<tr>" +
                                        "<td  style='width: 3%'><input type=text   name='delivery_apply[" + i + "].linenum' readonly=true class='form-control linenum' value=''></td>" +
                                        "<td style='width: 3%'><input type=text   name='delivery_apply[" + i + "].linestate' readonly=true class='form-control linestate' value=''></td>" +
                                        "<td style='width: 11%'><input type=text   name='delivery_apply[" + i + "].itemno' readonly=true class='form-control itemno' value='" + d.data[i].itemno + "'></td>" +
                                        "<td style='width: 4%'><input type=text   name='delivery_apply[" + i + "].itemclass' readonly=true class='form-control itemclass' value='" + d.data[i].itemclass + "'></td>" +
                                        "<td style='width: 4%'><input type=text   name='delivery_apply[" + i + "].brand' readonly=true class='form-control brand' value='" + d.data[i].brand + "'></td>" +
                                        "<td style='width: 27%'><input type=text   name='delivery_apply[" + i + "].partname' readonly=true class='form-control partname' value='" + d.data[i].partname + "'></td>" +
                                        "<td style='width: 7%'><input type=text   name='delivery_apply[" + i + "].partspec' readonly=true class='form-control partspec' value='" + d.data[i].partspec + "'></td>" +
                                        "<td style='width: 4%'><input type=text   name='delivery_apply[" + i + "].partstyle' readonly=true class='form-control partstyle' value='" + d.data[i].partstyle + "'></td>" +
                                        "<td style='width: 4%'><input type=text   name='delivery_apply[" + i + "].colorlevel' readonly=true class='form-control colorlevel' value='" + d.data[i].colorlevel + "'></td>" +
                                        "<td style='width: 4%'><input type=text   name='delivery_apply[" + i + "].material' readonly=true class='form-control material' value='" + d.data[i].material + "'></td>" +
                                        "<td style='width: 4%'><input type=text   name='delivery_apply[" + i + "].funit' readonly=true class='form-control funit' value=" + d.data[i].funit + "></td>" +
                                        "<td style='width: 4%'><input type=text   name='delivery_apply[" + i + "].grossweight' readonly=true class='form-control grossweight' value=" + d.data[i].grossweight + "></td>" +
                                        "<td style='width: 4%'><input type=text   name='delivery_apply[" + i + "].unitweight' readonly=true class='form-control unitweight' value=" + d.data[i].unitweight + "></td>" +
                                        "<td style='width: 4%'><input   name='delivery_apply[" + i + "].actualapplyqty'  value=" + actualapplyqty + " class='form-control actualapplyqty ' onchange='count_change_add(this.parentNode.parentNode)'></td>" +
                                        "<td style='width: 4%'><input   class='form-control sourcenum'readonly=true name='delivery_apply[" + i + "].sourcenum' value=" + d.data[i].orderno + " ></td>" +
                                        "<td style='width: 4%'><input   class='form-control soucrelinenum'readonly=true name='delivery_apply[" + i + "].soucrelinenum' value=" + d.data[i].linenum + " ></td>" +
                                        "<td style='width: 4%'><input   class='form-control recqty'readonly=true name='delivery_apply[" + i + "].recqty' value='0' ></td>" +
                                        "<input   class='form-control orderdetailid' type=hidden  readonly=true name='delivery_apply[" + i + "].orderdetailid' value=" + d.data[i].id + " >" +
                                        "<input   class='form-control itemid' type=hidden readonly=true name='delivery_apply[" + i + "].itemid' value=" + d.data[i].itemid + " >" + "</tr>";
                            }

                            var html2 = "<table class='table table-bordered table-hover table-striped bjui-tabledit'><tr>" +
                                    "<td><input   class='form-control'  value='合计'></td>" +
                                    "<td><input   type='text'  class='form-control' value></td>" +
                                    "<td><input  style='width: 60px' type='text'  class='form-control' value></td>" +
                                    "<td><input   type='text'  class='form-control' value></td>" +
                                    "<td><input   type='text'  class='form-control' value></td>" +
                                    "<td><input  style='width: 270px' type='text'  class='form-control' value></td>" +
                                    "<td><input   type='text'  class='form-control' value></td>" +
                                    "<td><input   type='text'  class='form-control' value></td>" +
                                    "<td><input   type='text'  class='form-control' value></td>" +
                                    "<td><input   type='text'  class='form-control' value></td>" +
                                    "<td><input   type='text'  class='form-control' value></td>" +
                                    "<td><input   type='text'  class='form-control' value></td>" +
                                    "<td><input   type='text'  class='form-control' value></td>" +
                                    "<td><input   type='text'  class='form-control' value></td>" +
                                    "<td style='text-align: center'><input   type='text' id='countunitqty' readonly=true class='form-control' value=0></td>" +
                                    "<td style='text-align: center'><input   type='text' id='countmodifyunitqty' readonly=true class='form-control' value=0></td>" +
                                    "<td style='text-align: center'><input   type='text' id='countmpq'readonly=true  class='form-control' value=0></td>" +
                                    "<td style='text-align: center'><input   type='text' id='countqty' readonly=true class='form-control' value=0></td>" +
                                    "<td style='text-align: center'><input   type='text' id='countmodifyqty' readonly=true class='form-control' value=0></td>" +
                                    "<td style='text-align: center'><input   type='text' id='countchangeqty' readonly=true class='form-control' value=0></td>" +
                                    "<td><input type='text'    class='form-control' value></td>" +
                                    "</tr></table>";

                            $("#delivery_apply_order_add tbody").html(html);

//                        $("#sales_order_change_count").html(html2);
//                        countline = $("#sales_order_change_design_add_detail_table tbody tr").length;//todo
//                        count_change_add();
                            //让选择的行变成class变成selected，其他行变成readonly
                            $("#delivery_apply_order_add tbody tr").click(function () {
                                $(this).removeClass("readonly")
                                        .addClass("selected").siblings("tr").removeClass("selected")
                                        .addClass("readonly");
                            })
                            //关闭对话
//                        BJUI.dialog("closeCurrent", this);
                        } else {
                            BJUI.alertmsg('info', d.content, {
                                displayMode: 'fade',
                                alertTimeout: 1000,
                                displayPosition: 'middlecenter'
                            });
                        }
                    }
                });
            }
//
//        function count_change_add(theRow) {
//            //根据单位用户量unitqty,和最小包装MPQ mpq计算出所需数量qty
//            //qty=unitqty/mpq 向上取整
//            var unitqty = $(theRow).find(".unitqty").val();//单位用户量
//            var modifyunitqty = $(theRow).find(".modifyunitqty").val();//修改单位用户量
//            var mpq = $(theRow).find(".mpq").val();//最小包装MPQ
//            var qty = $(theRow).find(".qty").val();//数量
//            var modifyqty = Math.ceil(modifyunitqty / mpq);//修改数量数量
//            var changeqty = modifyqty - qty;//数量
//            $(theRow).find(".modifyqty").val(modifyqty);//数量
//            $(theRow).find(".changeqty").val(changeqty);//数量
//
//
//            //重新合计各数量
//            var sumunitqty = 0;
//            var summodifyunitqty = 0;
//            var sunmpq = 0;
//            var sumqty = 0;
//            var summodifqty = 0;
//            var sumchangeqty = 0;
//
//            for (var i = 0; i < $("#sales_order_change_design_add_detail_table tbody tr").length; i++) {
//                if ($("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(12) input").val() != '') {
//                    sumunitqty += parseInt($("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(12) input").val());
//                }
//                if ($("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(13) input").val() != '') {
//                    summodifyunitqty += parseInt($("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(13) input").val());
//                }
//                if ($("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(14) input").val() != '') {
//                    sunmpq += parseInt($("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(14) input").val());
//                }
//
//                if ($("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(15) input").val() != '') {
//                    sumqty += parseInt($("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(15) input").val());
//                }
//                if ($("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(16) input").val() != '') {
//                    summodifqty += parseInt($("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(16) input").val());
//                }
//                if ($("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(17) input").val() != '') {
//                    sumchangeqty += parseInt($("#sales_order_change_design_add_detail_table tbody tr:eq(" + i + ") td:eq(17) input").val());
//                }
//                $("#sales_order_change_count  td:eq(12) input").val(sumunitqty);
//                $("#sales_order_change_count  td:eq(13) input").val(summodifyunitqty);
//                $("#sales_order_change_count  td:eq(14) input").val(sunmpq);
//                $("#sales_order_change_count  td:eq(15) input").val(sumqty);
//                $("#sales_order_change_count  td:eq(16) input").val(summodifqty);
//                $("#sales_order_change_count  td:eq(17) input").val(sumchangeqty);
//            }
//        }
        }

    </script>
</head>
<body>
<div class="bjui-pageContent">
    <div style="margin-bottom:18px;">
        <!--获取选择行数据-->
        <a href="javascript:;" data-toggle="lookupback" onclick="sales_order_select()" class="btn btn-blue" data-args=""
           title="选择本项" data-icon="check" id="selected_order"><i class="fa fa-check"></i> 选择</a>
        <button type="button" class="btn-close btn" data-icon="close"><i class="fa fa-close"></i> 关闭</button>
    </div>
    <table id="salesorder_selecte_lsit">

    </table>
</div>
</body>
</html>