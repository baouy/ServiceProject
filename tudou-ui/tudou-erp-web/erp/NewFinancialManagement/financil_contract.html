<script type="text/javascript">

    var roleid = $.cookie("roleid");
    var cl_deltype,contract_selected_row, contract_selected_id = -1,contract_selected_custid_fk = -1;
    if (roleid != 10 && roleid != 6) {
        $('#financil_contract_pay_yes').remove();
        $('#financil_contract_pay_no').remove();
    }

    $('#contract_list_datagrid').datagrid({

        local: 'remote',
        dataUrl: '/v1/contract/list',
        dataType: 'json',
        sortAll: false,
        loadType: 'get',
        filterAll: true,
        height: '95%',
        columns: [{name: 'contractdoc', width: '110', label: '合同单号'},
            {name: 'custname', width: '70', label: '姓名'},
            {name: 'mobile', width: '100', label: '手机号'},
            {name: 'community', width: '100', label: '小区名'},
            {name: 'state', width: '50', label: '状态',type:'select',items:[{'新增':'新增','审核':'审核'}]},
            {name: 'room', width: '70', label: '门牌号'},
            {name: 'rooms', width: '30', label: '室',type:'select',items: [{'0': '0室'},{'1': '1室'},{'2': '2室'},{'3': '3室'},{'4': '4室'},{'5': '5室'}],render:function(value){
                return value==""?"":value+"室";
            }},
            {name: 'hall', width: '30', label: '厅',type:'select',items: [{'0': '0厅'},{'1': '1厅'},{'2': '2厅'},{'3': '3厅'},{'4': '4厅'},{'5': '5厅'}],render:function(value){
                return value==""?"":value+"厅";
            }},
            {name: 'kitchen', width: '30', label: '厨',type:'select',items: [{'0': '0厨'},{'1': '1厨'},{'2': '2厨'},{'3': '3厨'},{'4': '4厨'},{'5': '5厨'}],render:function(value){
                return value==""?"":value+"厨";
            }},
            {name: 'toilet', width: '30',label: '卫',type:'select',items: [{'0': '0卫'},{'1': '1卫'},{'2': '2卫'},{'3': '3卫'},{'4': '4卫'},{'5': '5卫'}],render:function(value){
                return value==""?"":value+"卫";
            }},
            {name: 'balcony', width: '40', label: '阳台',type:'select',items: [{'0': '0阳台'},{'1': '1阳台'},{'2': '2阳台'},{'3': '3阳台'},{'4': '4阳台'},{'5': '5阳台'}],render:function(value){
                return value==""?"":value+"阳台";
            }},
            {name: 'usearea', width: '70', label: '量房面积'},
            {name: 'buildarea', width: '70', label: '产权面积'},
            {name: 'handoverdate', width: '70', label: '交房时间',type:'date',pattern:'yyyy-MM-dd'},
            {name: 'roomtype', width: '70', label: '房屋类型',type:'select',items:[{'毛坯平层':'毛坯平层'},{'旧房平层':'旧房平层'},{'复式毛坯':'复式毛坯'},{'跃层毛坯':'跃层毛坯'},{'排屋毛坯':'排屋毛坯'},{'别墅毛坯':'别墅毛坯'},{'其他':'其他'}]},
            {name: 'paid', width: '70', label: '已付总额',columnFilter:false},
            {name: 'paypercent', width: '70', label: '已付百分比',render:function(value){
                return value ? value+"%": value;
            }},
            {name: 'contractamount', width: '70', label: '合同总额'},
            {name: 'standardcost', width: '70', label: '基本造价'},
            {name: 'personalpkg', width: '70', label: '个性化造价'},
            {name: 'taxes', width: '70', label: '税金'},
            {name: 'servicecost', width: '70', label: '远程费'},
            {name: 'personchange', width: '70', label: '个性化变动'},
            {name: 'preferential', width: '70', label: '优惠金额'},
            {name: 'preferentialinfo', width: '70', label: '优惠信息'},
            //{name: 'ispay', width: '50', type: 'select', label: '是否收款', items: [{'true': '是'}, {'false': '否'}]},
            //{name: 'startdate', width: '100', label: '开工日期'},
            //{name: 'contractamount', width: '100', label: '合同金额'},
            //{name: 'firstamount', width: '100', label: '首付金额'},
            //{name: 'details', width: '150', label: '备注'},
            //{name: 'designer', width: '70', label: '设计师'},
            //{name: 'custsales', width: '70', label: '客户经理'},
            //{name: 'orgname', width: '70', label: '组织'},
            {name: 'createuser', width: '70', label: '制单人'},
            {name: 'createtime', width: '100', label: '制单时间',type:'date',pattern:'yyyy-MM-dd',render:function(value){
                return value ? value.substr(0, 18) : value;
            }},
            {name: 'reviewuser', width: '70', label: '审核人'},
            {name: 'reviewtime', width: '100', label: '审核时间',type:'date',pattern:'yyyy-MM-dd'},
            {name: 'id', width: '80', label: '', hide: true}
        ],
        paging: {pageSize: 20, selectPageSize: '50,100,200', pageCurrent: 1},
        columnMenu: true,
        columnShowhide: true,
        columnFilter: true,
        columnLock: false,
        fullGrid: false,
        dblOnClick: 'contract_dbClick',
        clickRow: 'contract_click',
        showToolbar: true,
        toolbarCustom: '<button type="button" class="btn btn-green" data-icon="edit" onclick="contract_dbClick()">编辑</button> ' +
        '<button type="button" class="btn btn-green" data-icon="thumbs-up" onclick="financial_cl_audit(true,0)" data-width="1050" data-height="400" data-id="contract_d">审核 </button> ' +
        '<button type="button" class="btn btn-orange" data-icon="thumbs-down" onclick="financial_cl_audit(false,0)" data-width="1050" data-height="400" data-id="contract_qd">弃审 </button> ' +
        /* '<button type="button" class="btn btn-red" data-icon="times" onclick="showalert_cl(false)" data-width="1050" data-height="400" data-id="personnel_d">删除 </button> ' +
        '<button type="button" id="financial_contract_pay_yes" class="btn btn-green" data-icon="thumbs-up" onclick="showalert_contract_pay(true)">确认收款 </button> ' +
        '<button type="button" id="financial_contract_pay_no" class="btn btn-orange" data-icon="thumbs-down" onclick="showalert_contract_pay(false)">取消收款 </button> ' +
        '<form id="form1_Contract" action="/v1/contract/test_contract_excel_post" method="post"  enctype="multipart/form-data" class="fa">' +
        '<input type="file" name="file" id="upfile_c" style="visibility: hidden; position: absolute;" onchange="import_Contract_Excel()">' +
        '<button type="button" class="btn btn-blue" data-icon="sign-in" onclick="upfile_c.click()"><i class="fa fa-sign-in"></i>导入</button>' + */
        '</form>'
    });

    function contract_click() {
        contract_selected_row = $("#contract_list_datagrid").data('selectedDatas');
        if (null != contract_selected_row || contract_selected_row[0].id != contract_selected_id) {
            contract_selected_id = contract_selected_row[0].id;
            contract_selected_custid_fk = contract_selected_row[0].custid_fk;
            contract_invoice_loading();
        }
    }

    function contract_dbClick() {
        contract_selected_row = $("#contract_list_datagrid").data('selectedDatas');
        if (null == contract_selected_row || contract_selected_row.length == 0) {
            $(this).alertmsg('error', '请在列表中选择要操作的对象。');
        } else if (contract_selected_row.length > 1) {
            $(this).alertmsg('error', '请选择唯一的操作对象。');
        } else {
            contract_selected_id = contract_selected_row[0].id;
            contract_selected_custid_fk = contract_selected_row[0].custid_fk;
            if (contract_selected_id > 0) {
                $(this).dialog({
                    id: 'engineering_project_edit',
                    url: 'NewFinancialManagement/financil_contract_edit.html',
                    title: '编辑合同',
                    width: '1050',
                    height: '350',
                    mask: true
                });
            }
        }
    }

    function financial_cl_audit(type, index) {
        if (null == contract_selected_row || contract_selected_row.length == 0) {
            $(this).alertmsg('error', '请在列表中选择要操作的对象。');
        } else if (contract_selected_row.length > 1) {
            $(this).alertmsg('error', '请选择唯一的操作对象。');
        } else{
            contract_selected_id = contract_selected_row[0].id;
            if(type && contract_selected_row[0].state=='审核'){
                $(this).alertmsg('error', '当前状态【审核】不能重复审核');
                return ;
            }
            if( !type && contract_selected_row[0].state=='新增'){
                $(this).alertmsg('error', '当前状态【新增】不能弃审');
                return ;
            }
            if (type && contract_selected_row[0].paypercent<95){
                $(this).alertmsg('error', '当前合同已付款比例低于95%不能审核');
                return ;
            }
            $.ajax({
                url: '/v1/contract/contract_edittype?ids=' + contract_selected_id + '&type=' + type,
                dataType: 'json',
                type: 'POST',
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        $(this).alertmsg('ok', '操作成功');
                        $('#contract_list_datagrid').datagrid('refresh');
                    } else {
                        $(this).alertmsg('warn', d.content);
                    }

                }
            });
        }
    }

    function financial_cl_delete() {
        if (null == contract_selected_row || contract_selected_row.length == 0) {
            $(this).alertmsg('error', '请在列表中选择要操作的对象。');
        } else if (contract_selected_row.length > 1) {
            $(this).alertmsg('error', '请选择唯一的操作对象。');
        } else{
            contract_selected_id = contract_selected_row[0].id;
            $.ajax({
                url: '/v1/contract/contract_delete?ids=' + contract_selected_id,
                dataType: 'json',
                type: 'POST',
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        $(this).alertmsg('ok', '操作成功');
                        $('#contract_list_datagrid').datagrid('refresh');
                        if (deltype) {
                            BJUI.dialog('closeCurrent', this);
                        }
                    } else {
                        $(this).alertmsg('warn', d.content);

                    }
                }
            });
        }
    }

    function showalert_cl(del) {
        deltype = del;
        $(this).alertmsg('confirm', '确定删除吗?', {okCall: 'financial_cl_delete'});
    }


    function cl_chooseItems(val) {
        if (val == 51) {
            $('#c_save').attr('disabled', "true");
            $('#c_audit').attr('disabled', "true");
            $('#c_at').removeAttr("disabled");
            $('#c_del').attr('disabled', "true");
            $('#c_csl').attr('disabled', "true");

        } else {
            $('#c_save').removeAttr("disabled");
            $('#c_audit').removeAttr("disabled");
            $('#c_at').attr('disabled', "true");
            $('#c_del').removeAttr("disabled");
            $('#c_csl').removeAttr("disabled");
        }
    }

    function contract_back(json) {
        if (json.state == 200) {
            BJUI.dialog('closeCurrent', this);
            $('#contract_list_datagrid').datagrid('refresh');
        } else {
            var content = json.content;
            $(this).alertmsg('error', content);
        }
    }

    var contract_ispay;
    function showalert_contract_pay(pay) {
        contract_ispay = pay;
        $(this).alertmsg('confirm', '确定收款吗?', {okCall: 'financial_contract_pay'});
    }

    function financial_contract_pay() {
        var resetKeys = getclselectedKey();
        if (resetKeys.length > 0) {
            $.ajax({
                url: '/v1/contract/change_pay?ids=' + resetKeys + '&type=' + contract_ispay,
                dataType: 'json',
                type: 'POST',
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (d) {
                    if (d.state == 200) {
                        $(this).alertmsg('ok', "操作成功");
                        $('#contract_list_datagrid').datagrid('refresh');
                    } else {
                        $(this).alertmsg('warn', d.content);
                    }
                }
            });
        } else {
            $(this).alertmsg('warn', '请选择要操作的对象。');
        }
    }


    function checkDataContract() {
        var fileDir = $("#upfile_c").val();
        if (fileDir.length == 0) {
            return false;
        }
        var suffix = fileDir.substr(fileDir.lastIndexOf("."));
        if ("" == fileDir) {
            $(this).alertmsg('info', '选择EXCEL格式的文件导入');
            return false;
        }
        if (".xls" != suffix && ".xlsx" != suffix) {
            $(this).alertmsg('info', '选择EXCEL格式的文件导入');
            return false;
        }
        return true;
    }

    function import_Contract_Excel() {
        if (!checkDataContract()) {
            $("#upfile_c").val("");
            return;
        }
        $.ajax({
            url: '/v1/contract/test_contract_excel_post',
            type: 'POST',
            cache: false,
            data: new FormData($('#form1_Contract')[0]),
            processData: false,
            contentType: false
        }).done(function (res) {
            if (res.state == 200) {
                $(this).alertmsg('ok', '导入成功');
                $('#contract_list_datagrid').datagrid('refresh');
            } else {
                var content = '';
                for (var i = 0; i < res.data.length; i++) {
                    content += res.data[i] + "<br>";
                }

                $(this).alertmsg('info', content, {autoClose: false, title: '导入电话重复项'});
            }
            $("#upfile_c").val("");
        }).fail(function (res) {
            $("#upfile_c").val("");
            $(this).alertmsg('error', '导入失败,请重新导入');
        });
    }

    function foot_tab_change(idx) {
        var currTab = null;
        switch (idx) {
            case 0:
                currTab = "#invoice_follow_tab";
                break;
            case 1:
                currTab = "#invoice_xxx_tab";
                break;
        }
        if (null != currTab) {
            $(currTab).datagrid('refresh');
            $(currTab).data('selectedDatas', null);
        }
    }
    // 默认加载foot-tab
    function contract_invoice_loading() {
        $(this).bjuiajax('doLoad', {
            url: 'NewFinancialManagement/invoice_follow_tab.html',
            target: '#contract_invoice_div',
            loadingmask: false
        });
    }

    function contract_changeTabs(num){
        cl_deltype=null, contract_selected_id = -1;
       // TODO
        if (num ==0)$('#contract_list_datagrid').datagrid('refresh');
    }
</script>
<div style="border: 0px solid green;width: 100% !important;position: relative;height: 60%;">
    <ul class="nav nav-tabs" role="tablist" id="btn_list">
        <li class="active">
            <a style="font-size: 13px" href="#sale_table_all" role="tab" data-toggle="tab"
               onclick="contract_changeTabs(0)">全部客户</a>
        </li>
        <!--<li>
            <a style="font-size: 13px" href="" role="tab" data-toggle="ajaxtab" data-target="" data-reload="false"
               onclick="contract_changeTabs(1)">未审核</a>
        </li>
        <li>
            <a style="font-size: 13px" href="" role="tab" data-toggle="ajaxtab" data-target="" data-reload="false"
               onclick="contract_changeTabs(2)">部门已审核</a>
        </li>
        <li>
            <a style="font-size: 13px" href="" role="tab" data-toggle="ajaxtab" data-target="" data-reload="false"
               onclick="contract_changeTabs(3)">财务已审核</a>
        </li>
        <li>
            <a style="font-size: 13px" href="" role="tab" data-toggle="ajaxtab" data-target="" data-reload="false"
               onclick="contract_changeTabs(4)">工程已审核</a>
        </li>
        <li>
            <a style="font-size: 13px" href="" role="tab" data-toggle="ajaxtab" data-target="" data-reload="false"
               onclick="contract_changeTabs(5)">施工中</a>
        </li>
        <li>
            <a style="font-size: 13px" href="" role="tab" data-toggle="ajaxtab" data-target="" data-reload="false"
               onclick="contract_changeTabs(6)">已竣工</a>
        </li>
        <li>
            <a style="font-size: 13px" href="" role="tab" data-toggle="ajaxtab" data-target="" data-reload="false"
               onclick="contract_changeTabs(7)">已退款</a>
        </li>-->
    </ul>

    <div class="tab-content" style="height: 95%;padding: 0px;">
        <!--全部客户-->
        <div class="tab-pane fade active in" id="sale_table_all" style="height: 100%;">

            <div style="border: 0px solid green;width: 100% !important;position: relative;height: 100%;">
                <table id="contract_list_datagrid" class="table table-hover" data-width="100%"></table>
            </div>
        </div>
        <!--未审核
        <div class="tab-pane fade" id="" style="height: 100%;"> </div>
         部门已审核
        <div class="tab-pane fade" id="" style="height: 100%;"> </div>-->
    </div>
</div>

<div style="border: 0px solid green;width: 100% !important;position: relative;height: 40%;">
    <ul class="nav nav-tabs" role="tablist">
        <li class="active in">
            <a id="df_invoice_follow_tab" style="font-size: 13px"
               href="NewFinancialManagement/invoice_follow_tab.html" role="tab" data-toggle="ajaxtab"
               data-reload="false" data-target="#contract_invoice_div" onclick="foot_tab_change(0)">收款记录</a>
        </li>
        <!--<li> <a style="font-size: 13px" href="NewFinancialManagement/invoice_follow_tab.html" role="tab"
               data-toggle="ajaxtab" data-target="#contract_xx_table" data-reload="false" onclick="foot_tab_change(0)">选材表</a>
        </li>
        <li> <a style="font-size: 13px" href="NewFinancialManagement/invoice_follow_tab.html" role="tab"
                data-toggle="ajaxtab" data-target="#contract_xx_table" data-reload="false" onclick="foot_tab_change(0)">施工进度</a>
        </li>-->
    </ul>
    <div id="contract_invoice_div" style="height: 100%;">
        <script> contract_invoice_loading() </script>
    </div>
    <div id="contract_xx_table" style="height: 100%;">contract_xx_table</div>
</div>