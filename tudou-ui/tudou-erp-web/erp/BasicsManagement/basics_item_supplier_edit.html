<script type="text/javascript">
	/***
	 * 添加料品
	 * */
	itemdetail();
	function itemdetail(){
		$.ajax({
			url: '/v1/titem/itemdetail?id='+item_list_id,
			dataType: 'json',
			type: 'GET',
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			success: function(d){
				if(d.state == 200){
					var val;
					for(var i in d.data){
						$.CurrentDialog.find("#item_"+i).val(d.data[i]);

						if (i == "recmode") {
							$.CurrentDialog.find("#item_" + i).selectpicker('val',d.data[i]);
						}
						if (i == "usingphase") {
							$.CurrentDialog.find("#item_" + i).selectpicker('val',d.data[i]);
						}
						if (i == "unitweight"){
							$.CurrentDialog.find("#item_" + i).selectpicker('val',d.data[i]);
						}
						if (i == "worker") {
							$.CurrentDialog.find("#item_" + i).selectpicker('val',d.data[i]);
						}

						if (i == "isactive"){
							if (d.data[i]){
								$.CurrentDialog.find('#item_isactive1').iCheck('check');
								$.CurrentDialog.find('#item_isactive2').iCheck('uncheck');
							}else{
								$.CurrentDialog.find('#item_isactive2').iCheck('check');
								$.CurrentDialog.find('#item_isactive1').iCheck('uncheck');
							}
						}

						if (i == "isnonstandard"){
							if (d.data[i]){
								$.CurrentDialog.find('#item_isnonstandard1').iCheck('check');
								$.CurrentDialog.find('#item_isnonstandard2').iCheck('uncheck');
							}else{
								$.CurrentDialog.find('#item_isnonstandard2').iCheck('check');
								$.CurrentDialog.find('#item_isnonstandard1').iCheck('uncheck');
							}
						}

						if (i == "ischild"){
							if (d.data[i]){
								$.CurrentDialog.find('#item_ischild1').iCheck('check');
								$.CurrentDialog.find('#item_ischild2').iCheck('uncheck');
							}else{
								$.CurrentDialog.find('#item_ischild2').iCheck('check');
								$.CurrentDialog.find('#item_ischild1').iCheck('uncheck');
							}
						}

						if (i == "issn"){
							if (d.data[i]){
								$.CurrentDialog.find('#item_issn1').iCheck('check');
								$.CurrentDialog.find('#item_issn2').iCheck('uncheck');
							}else{
								$.CurrentDialog.find('#item_issn2').iCheck('check');
								$.CurrentDialog.find('#item_issn1').iCheck('uncheck');
							}
						}
					}

				}
			}
		});
	}

	var itemAUValid = null,itemSupplierAUValidList = null,titemwarehouseValids = null;
	var is_post_data = false;
	$('#basics_item_supplier_from').bind('valid.form', function(){
		var isactive = $('input:radio[name="isactive"]:checked').val();
		var isnonstandard = $('input:radio[name="isnonstandard"]:checked').val();
		var ischild = $('input:radio[name="ischild"]:checked').val();
		var issn = $('input:radio[name="issn"]:checked').val();

		itemAUValid = {
			id:item_list_id,
			itemno:$("#item_itemno").val(),//料号
			itemclass:$("#item_itemclass").val(),//分类
			itemclassid:$("#item_itemclassid").val(),//分类ID
			itemclasscode:$("#item_itemclasscode").val(),//分类code
			partspec:$("#item_partspec").val(),//规格
			partstyle:$("#item_partstyle").val(),//型号
			colorlevel:$("#item_colorlevel").val(),//颜色
			partname:$("#item_partname").val(),//品名
			funit:$("#item_funit").val(),//单位
			brand:$("#item_brand").val(),//品牌
			brandid:$("#item_brandid").val(),//品牌ID
			material:$("#item_material").val(),//材质
			usingphase:$("#item_usingphase").val(),//使用阶段
			recmode:$("#item_recmode").val(),//收货模式
			isactive:isactive,//是否有效
			isnonstandard:isnonstandard,//是否非标
			ischild:ischild,//是否子件
			parentitemno:$("#item_parentitemno").val(),//套件料号
			parentitemnoid:$("#item_parentitemnoid").val(),//套件料号ID
			useunit:$("#item_useunit").val(),//单位用量
			length:$("#item_length").val(),//长度
			wide:$("#item_wide").val(),//宽度
			high:$("#item_high").val(),//高度
			cartonsize:$("#item_cartonsize").val(),//外箱体积
			grossweight:$("#item_grossweight").val(),//毛重
			netweight:$("#item_netweight").val(),//净重
			unitweight:$("#item_unitweight").val(),//重量单位
			issn:issn,//
			worker:$("#item_worker").val(),//工种
			workerid:$("#item_workerid").val()//工种ID
		}

		$('#basics_item_datagrid_1').datagrid('saveAll');
	});

	$('#basics_item_datagrid_1').datagrid({
		gridTitle:'采购信息',
		dataUrl: '/v1/titemsupplier/itemid_detail_list?itemid='+item_list_id,
		dataType: 'json',
		sortAll: false,
		loadType: 'get',
		addLocation: 'next',
		filterThead:false,
		columns: [{name:'suppliercode', width:'100', label:'供应商编码',hide:true},
			{name:'suppliername', width:'100', label:'供应商名称',type:'lookup',rule: 'required',attrs: {'readonly':"true",'data-url':'BasicsManagement/basics_suppliercode_table_add.html','data-width':600,'data-title':"供应商列表",'class':'doc_lookup form-control'}},
			{name:'issupplier', width:'100',label:'是否是主供应商',type: 'select',rule: 'required',items: [{'':''},{'true': '是'}, {'false': '不是'}]},
			{name:'pounit', width:'70',label:'采购单位',attrs: {'data-rule':'required'}},
			{name:'poxs', width:'70',label:'采购系数',attrs: {'data-rule':'required;number'}},
			{name:'kcxs', width:'70',label:'库存系数',attrs: {'data-rule':'required;number'}},
			{name:'suppliersku', width:'100',label:'供方料号'},
			{name:'procycle', width:'100',label:'订货周期L/T'},
			{name:'procost', width:'100',label:'采购成本'},
			{name:'procount', width:'100',label:'采购起订量(MPQ)'},
			{name:'mpq', width:'100',label:'最小包装(MPQ)'},
			{name:'supplierid',hide:true},
		],
		paging:false,
		showToolbar: true,
		toolbarItem: 'add,cancel,del',
		saveAll: false,
		editUrl:'meiwo',
		issaveallback:'save_json',
		contextMenuB:true,
		delConfirm:true,
		delPK:'id',
		delType:'POST',
		delUrl:'/v1/titemsupplier/supplier_del',
		afterDelete:'del_item_view',
		showEditbtnscol:true,
		editdblOnclick: true,
	});

	function save_json(json) {
		if (json.length > 0) {
			var test =$('#basics_item_datagrid_1').find("div");
			var is_sure = 0;
			test.each(function(){
				var $div = $(this)
				if ($div.text() == "是"){
					is_sure++
				}
			})

			var spantest =$('#basics_item_datagrid_1').find("span");
			spantest.each(function(){
				var $span = $(this)
				if ($span.text() == "是" && $span.attr('class') == "filter-option pull-left"){
					is_sure++
				}
			})


			console.log(is_sure);
			if (is_sure == 0){
				$(this).alertmsg('warn', '至少只有一个主供应商');
				return;
			}
			if(is_sure > 1){
				$(this).alertmsg('warn', '至多只有一个主供应商');
				return;
			}
			itemSupplierAUValidList = json;
		}

		$('#basics_item_datagrid_2').datagrid('saveAll');

	}


	function save_json_2(json){

		if (json.length > 0) {
			titemwarehouseValids = json;
		}

		var objOb = new Object();
		objOb.itemAUValid = itemAUValid;
		if (itemSupplierAUValidList != null){
			objOb.itemSupplierAUValidList = itemSupplierAUValidList;
		}
		if (titemwarehouseValids != null){
			objOb.titemwarehouseValids = titemwarehouseValids;
		}

		if (is_post_data){
			return;
		}
		is_post_data = true;
		$.ajax({
			url: '/v1/titem/edititem',
			contentType:"application/json",
			dataType: 'json',
			type: 'POST',
			data:JSON.stringify(objOb),
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			success: function (d) {
				if(d.state == 200) {
					$('#item_list_datagrid').datagrid('refresh');
					if (itemSupplierAUValidList != null){
						$('#basics_item_datagrid_1').datagrid('refresh');
					}
					if (titemwarehouseValids != null){
						$('#basics_item_datagrid_2').datagrid('refresh');
					}
					itemSupplierAUValidList = null;
					titemwarehouseValids = null;
				}
				is_post_data = false;
			}
		});
	}

	$('#basics_item_datagrid_2').datagrid({
		gridTitle:'安全库存',
		dataUrl: '/v1/titemwarehouse/item_detail_list?itemid='+item_list_id,
		dataType: 'json',
		sortAll: false,
		loadType: 'get',
		addLocation: 'next',
		filterThead:false,
		columns: [{name:'orgname', width:'150', label:'组织',hide:true},
			{name:'warehousecode', width:'150', label:'仓库编码',hide:true},
			{name:'warehousename', width:'150',label:'仓库名称',type:'lookup',rule: 'required',attrs: {'readonly':"true",'data-url':'BasicsManagement/basice_warehouse_table_add.html','data-width':600,'data-title':"仓库列表",'class':'doc_lookup form-control'}},
			{name:'warehouseupper', width:'150',label:'仓库上限'},
			{name:'warehouselower', width:'150',label:'仓库下限'},
			{name:'safewarehouse', width:'150',label:'安全库存'},
			{name:'orgFk', width:'150', label:'组织ID',hide:true},
			{name:'orgcode', width:'150', label:'组织CODE',hide:true},
			{name:'orgname', width:'150', label:'组织',hide:true},
			{name:'warehouseid', width:'150', label:'组织',hide:true},
			{name:'itemid', width:'150', label:'组织',hide:true},
		],
		paging:false,
		showToolbar: true,
		toolbarItem: 'add,cancel,del',
		saveAll: true,
		editUrl:'meiwo',
		issaveallback:'save_json_2',
		contextMenuB:true,
		delConfirm:true,
		delPK:'id',
		delType:'POST',
		delUrl:'/v1/titemwarehouse/warehouse_del',
		afterDelete:'del_item_view',
		showEditbtnscol:true,
		editdblOnclick: true,
	});


	$("#item_worker").change(function() {

		var select = $('#item_worker option:selected').text();

		console.log(select);

		switch (select){
			case '水电工':
				$("#item_workerid").val(20);
				break;
			case '泥瓦工':
				$("#item_workerid").val(21);
				break;
			case '木工':
				$("#item_workerid").val(23);
				break;
			case '油漆工':
				$("#item_workerid").val(24);
				break;
			case '安装工':
				$("#item_workerid").val(25);
				break;
		}
	});

	function del_item_view() {
		$(this).alertmsg('ok', '删除成功');
	}

	$('input:radio[name="ischild"]').on('ifChecked', function(event){
		var ischild = $('input:radio[name="ischild"]:checked').val();
		if (ischild == 'true'){
			console.log(ischild);
			$('#item_supplier_td_parentitemnoid').attr("class",'');
		}else{
			$('#item_supplier_td_parentitemnoid').attr("class",'hide');
			$('#item_parentitemnoid').val('');
			$('#item_parentitemno').val('');
		}
	});

</script>
<div class="bjui-pageContent">
	<form id="basics_item_supplier_from" data-toggle="validate" data-toggle="validate">
		<div style="margin:0px 0px 10px 0px;">
			<button class="btn btn-blue" data-icon="save" id="purchase_order_save_btn">
				保存
			</button>
			<button class="btn-close btn" data-icon="close"><i class="fa fa-close"></i>关闭</button>
		</div>

		<table class="table table-bordered table-hover table-striped table-top bjui-tabledit" id="item_supplier_table"
			   width="100%">

			<tbody>
			<tr>
				<td>
					<label for="item_itemno" class="control-label x90">料号：</label>
					<input type="text" name="itemno" id="item_itemno" value="" data-rule="required" size="15">
				</td>

				<td>
					<label class="control-label x90">分类：</label>
					<input type="hidden" value="" name="itemclasscode" id="item_itemclasscode">
					<input type="hidden" value="" name="itemclassid" id="item_itemclassid">
					<input type="text" data-toggle="lookup" data-url="BasicsManagement/basics_itemclass_table.html"
						   id="item_itemclass" name="itemclass" size="10" data-rule="required" data-title="分类" data-width="600" data-height="500" readonly="true">
				</td>

				<td>
					<label for="item_partspec" class="control-label x90">规格：</label>
					<input type="text" name="partspec" id="item_partspec" value="" size="15" data-rule="required">
				</td>
				<td>
					<label for="item_partstyle" class="control-label x90">型号：</label>
					<input type="text" name="partstyle" id="item_partstyle" value="" size="15">
				</td>
			</tr>
			<tr>
				<td>
					<label for="item_colorlevel" class="control-label x90">颜色/等级：</label>
					<input type="text" name="colorlevel" id="item_colorlevel" value="" size="15">
				</td>
				<td>
					<label for="item_partname" class="control-label x90">品名：</label>
					<input type="text" name="partname" id="item_partname" value="" data-rule="required" size="15">
				</td>

				<td>
					<label for="item_funit" class="control-label x90">单位：</label>
					<input type="text" name="funit" id="item_funit" value="" data-rule="required" size="15">
				</td>

				<td>
					<label class="control-label x90">品牌：</label>
					<input type="text" data-toggle="lookup" data-url="BasicsManagement/basics_item_table.html" data-width="600" data-height="500" id="item_brand" name="brand" size="10" data-rule="required" data-title="品牌" readonly="true">
					<input type="hidden" value="" name="brandid" id="item_brandid">
				</td>

			</tr>
			<tr>
				<td>
					<label for="item_material" class="control-label x90">材质：</label>
					<input type="text" name="material" id="item_material" value="" size="15">
				</td>

				<td>
					<label for="item_usingphase" class="control-label x90">使用阶段：</label>
					<select name="usingphase" id="item_usingphase" data-toggle="selectpicker" data-rule="required">
						<option value="" selected="true">请选择</option>
						<option value="第一批">第一批</option>
						<option value="第二批">第二批</option>
						<option value="第三批">第三批</option>
					</select>
				</td>

				<td>
					<label for="item_recmode" class="control-label x90">收货模式：</label>
					<select name="recmode" id="item_recmode" data-toggle="selectpicker" data-rule="required">
						<option value="" selected="true">请选择</option>
						<option value="入仓">入仓</option>
						<option value="入户">入户</option>
					</select>
				</td>

				<td>
					<label for="item_isactive1" class="control-label x90">是否生效：</label>
					<input type="radio" name="isactive" id="item_isactive1" data-toggle="icheck" value="true"
						   data-label="有效&nbsp;&nbsp;" checked>
					<input type="radio" name="isactive" id="item_isactive2" data-toggle="icheck" value="false"
						   data-label="无效">
				</td>
			</tr>
			<tr>
				<td>
					<label for="item_isnonstandard1" class="control-label x90">是否非标料号：</label>
					<input type="radio" name="isnonstandard" id="item_isnonstandard1" data-toggle="icheck" value="true"
						   data-label="是&nbsp;&nbsp;">
					<input type="radio" name="isnonstandard" id="item_isnonstandard2" data-toggle="icheck" value="false"
						   data-label="否" checked>
				</td>
				<td>
					<label for="item_ischild1" class="control-label x90">是否子件料号：</label>
					<input type="radio" name="ischild" id="item_ischild1" data-toggle="icheck" value="true"
						   data-label="是&nbsp;&nbsp;" >
					<input type="radio" name="ischild" id="item_ischild2" data-toggle="icheck" value="false"
						   data-label="否" checked>
				</td>
				<td id="item_supplier_td_parentitemnoid" class="hide">
					<label class="control-label x90">套件料号：</label>
					<input type="hidden" value="" name="parentitemnoid" id="item_parentitemnoid">
					<input type="text" data-toggle="lookup"
						   data-url="BasicsManagement/basics_parentitemno_table.html" id="item_parentitemno"
						   name="parentitemno" size="10" data-title="套件料号" readonly="true">
				</td>
			</tr>
			<tr>
				<td>
					<label for="item_useunit" class="control-label x90">单位用量：</label>
					<input type="text" name="useunit" id="item_useunit" value="" size="15">
				</td>

			</tr>
			<tr>
				<td>
					<label for="item_length" class="control-label x90">长度/mm：</label>
					<input type="text" name="length" id="item_length" value="" size="15">
				</td>
				<td>
					<label for="item_wide" class="control-label x90">宽度/mm：</label>
					<input type="text" name="wide" id="item_wide" value="" size="15">
				</td>
				<td>
					<label for="item_high" class="control-label x90">高度/mm：</label>
					<input type="text" name="high" id="item_high" value="" size="15">
				</td>

			</tr>
			<tr>
				<td>
					<label for="item_cartonsize" class="control-label x90">外箱体积/㎡：</label>
					<input type="text" name="cartonsize" id="item_cartonsize" value="" size="15">
				</td>
				<td>
					<label for="item_grossweight" class="control-label x90">毛重：</label>
					<input type="text" name="grossweight" id="item_grossweight" value="" size="15">
				</td>
				<td>
					<label for="item_netweight" class="control-label x90">净重：</label>
					<input type="text" name="netweight" id="item_netweight" value="" size="15">
				</td>
			</tr>
			<tr>
				<td>
					<label for="item_unitweight" class="control-label x90">重量单位：</label>
					<select name="unitweight" id="item_unitweight" data-toggle="selectpicker">
						<option value="" selected="true">请选择</option>
						<option value="g">g</option>
						<option value="KG">KG</option>
					</select>
				</td>
				<td>
					<label for="item_issn1" class="control-label x90">是否序列号管理：</label>
					<input type="radio" name="issn" id="item_issn1" data-toggle="icheck" value="true"
						   data-label="是&nbsp;&nbsp;">
					<input type="radio" name="issn" id="item_issn2" data-toggle="icheck" value="false" data-label="否" checked>
				</td>
				<td>
					<label for="item_worker" class="control-label x90">工种：</label>
					<input type="hidden" value="" name="workerid" id="item_workerid">
					<select name="worker" id="item_worker" data-toggle="selectpicker">
						<option value="" selected="true">请选择</option>
						<option value="水电工">水电工</option>
						<option value="泥瓦工">泥瓦工</option>
						<option value="木工">木工</option>
						<option value="油漆工">油漆工</option>
						<option value="安装工">安装工</option>
					</select>
				</td>
			</tr>
			</tbody>
		</table>


		<table id="basics_item_datagrid_1" class="table table-hover" data-width="100%"></table>

		<table id="basics_item_datagrid_2" class="table table-hover" data-width="100%"></table>

	</form>
</div>