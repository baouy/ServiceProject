<html>

<head>
	<script type="text/javascript">
		var itemclass_id,itemclass_pid,itemclass_level;
		init();
		function init() {
			var $t = $('#menu-ztree');
			$t.data('addHoverDom', "edit").data('removeHoverDom', "edit").data('onRemove','onRemove');
		}


		function saveMenu() {

			if (itemclass_pid === undefined && itemclass_id === undefined){
				return;
			}

			var code = $('#itemclass_itemclasscode').val();

			var name = $('#itemclass_itemclassname').val();

			var is_v = $('#itemclass_isactive').val();

			//新增
			if (itemclass_pid === undefined){
				itemclass_add(itemclass_id,code,name);
			}
			//编辑
			else{
				itemclass_reset(itemclass_id,itemclass_pid,code,name,is_v);
			}
		}

		function S_NodeCheck(e, treeId, treeNode) {
			var id = treeNode.id;

			var npId = treeNode.tid;

			var code = treeNode.code;

			var name = treeNode.name;

			var is_v = treeNode._v;

			itemclass_level = treeNode.level;

			if (id === undefined){
				itemclass_id = treeNode.pId;
				itemclass_pid = undefined;

				$('#itemclass_itemclasscode').val('');

				$('#itemclass_itemclassname').val('');

				$('#itemclass_isactive').iCheck('check');

			}else{
				itemclass_id = id;
				itemclass_pid = npId;

				$('#itemclass_itemclasscode').val(code);

				$('#itemclass_itemclassname').val(name);

				if (is_v){
					$('#itemclass_isactive').iCheck('check');
				}else{
					$('#itemclass_isactive').iCheck('uncheck');
				}
			}




		}

		function onRemove(event, treeId, treeNode){

			var id = treeNode.id;

			var npId = treeNode.tid;
			if (id === undefined){
				itemclass_id = treeNode.pId;
				itemclass_pid = undefined;
			}else{
				itemclass_id = id;
				itemclass_pid = npId;
			}

			$.ajax({
				url: '/v1/itemclass/itemclass_reset',
				dataType: 'json',
				type: 'POST',
				data:{
					id:itemclass_id,
					parentid:itemclass_pid,
					isactive:false
				},
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function (d) {
					if(d.state ==200) {

						itemclass_id = undefined;
						itemclass_pid = undefined;

						$('#itemclass_itemclasscode').val('');

						$('#itemclass_itemclassname').val('');

						$('#itemclass_isactive').iCheck('uncheck');

					}else{
						$(this).alertmsg('warn', '删除失败!');
					}
				}
			});
		}

		function itemclass_add(id,itemclasscode,itemclassname) {

			$.ajax({
				url: '/v1/itemclass/itemclass_add',
				dataType: 'json',
				type: 'POST',
				data:{
					parentid:id,
					itemclasscode:itemclasscode,
					itemclassname:itemclassname,
					isactive:true,
					level:itemclass_level
				},
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function (d) {
					if(d.state == 200) {
						var zTree  = $.fn.zTree.getZTreeObj("menu-ztree")
						var upNode = zTree.getSelectedNodes()[0];
						upNode.id = d.data
						upNode.tid = id
						upNode.pId = id
						upNode.name   = itemclassname
						upNode.code    = itemclasscode
						upNode._v = true
						zTree.updateNode(upNode)

						itemclass_id = undefined;
						itemclass_pid = undefined;

						$('#itemclass_itemclasscode').val('');

						$('#itemclass_itemclassname').val('');

						$('#itemclass_isactive').iCheck('uncheck');

					}else{
						$(this).alertmsg('warn', '添加失败!');
					}
				}
			});
		}


		function itemclass_reset(id,parentid,itemclasscode,itemclassname,isactive) {

			$.ajax({
				url: '/v1/itemclass/itemclass_reset',
				dataType: 'json',
				type: 'POST',
				data:{
					id:id,
					parentid:parentid,
					itemclasscode:itemclasscode,
					itemclassname:itemclassname,
					isactive:isactive
				},
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function (d) {
					if(d.state ==200) {

						var zTree  = $.fn.zTree.getZTreeObj("menu-ztree")
						var upNode = zTree.getSelectedNodes()[0];
						upNode.name   = itemclassname
						upNode.code    = itemclasscode
						upNode._v = isactive
						zTree.updateNode(upNode)

						itemclass_id = undefined;
						itemclass_pid = undefined;

						$('#itemclass_itemclasscode').val('');

						$('#itemclass_itemclassname').val('');

						$('#itemclass_isactive').iCheck('uncheck');

					}else{
						$(this).alertmsg('warn', '更新失败!');
					}
				}
			});
		}
		



	</script>

</head>

<body>


<div class="bjui-pageContent">
	<div class="roleLeft" style="border: 0px solid green;width: 200px !important;position: relative;height: 100%;float: left;">

		<ul id="menu-ztree" class="ztree"
			data-on-click="S_NodeCheck"
			data-radio-type="all"
			data-expand-all="true"
			data-toggle="ztree"
			data-options="{maxAddLevel:3}"
			data-setting="{
                            async:
                            {
                                enable: true,
                                url:'/v1/itemclass/list',
                                autoParam: ['id','pId'],
                                contentType: 'application/json',
                                dataType: 'json',
                                type:'get'
                            },view: {
                                selectedMulti: false
                            }
                         }"></ul>

	</div>
	<div class="roleRight" style="width: 45% !important;position: relative;height: 800px;float: left;margin: 0px 10px;">

		<div class="bs-example" data-content="详细信息">

			<div class="form-group">
				<label for="itemclass_itemclasscode" class="control-label x85">编码：</label>
				<input type="text" class="form-control" name="itemclasscode" id="itemclass_itemclasscode" size="15" placeholder="" style="width: 150px;">
			</div>
			<div class="form-group">
				<label for="itemclass_itemclassname" class="control-label x85">名称：</label>
				<input type="text" class="form-control" name="itemclassname" id="itemclass_itemclassname" size="15" style="width: 150px;">
			</div>
			<div class="form-group">
				<label for="itemclass_isactive" class="control-label x85">是否生效：</label>
				<td><input type="checkbox" name="isactive" id="itemclass_isactive" value="1" data-toggle="icheck" data-label="复选框"></td>
			</div>

			<div class="form-group" style="padding-top:8px; border-top:1px #DDD solid;">
				<label class="control-label x85"></label>
				<button class="btn btn-green" onclick="saveMenu();">保存更新数据</button>
			</div>
		</div>
	</div>
</div>

</body>

</html>